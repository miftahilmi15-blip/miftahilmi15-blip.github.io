<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBSERVASI KOLEKTIF | v8</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1f6f51; --bg: #f4f7f6; --blue: #2563eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); padding: 10px; display: flex; justify-content: center; }
        .wadah { width: 100%; max-width: 700px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        header h1 { color: var(--primary); font-size: 18px; text-align: center; margin-bottom: 15px; font-weight: 800; }
        
        /* Menu Navigasi Sesuai Request (Nyambung ke Laporan) */
        nav { display: flex; gap: 8px; margin-bottom: 15px; background: #eee; padding: 4px; border-radius: 10px; }
        .nav-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 700; font-size: 12px; cursor: pointer; color: #666; text-align: center; text-decoration: none; }
        .nav-btn.active { background: var(--primary); color: white; }

        .form-grup { margin-bottom: 12px; }
        label { font-size: 11px; font-weight: 700; color: #444; display: block; margin-bottom: 4px; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px; outline: none; }
        
        #pilih-santri-box { width: 100%; max-height: 180px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; background: #fff; }
        .item-santri { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-santri span { margin-left: 10px; font-size: 13px; color: #333; flex: 1; }

        .baris-aspek { display: flex; align-items: center; justify-content: space-between; background: #fafafa; padding: 8px 15px; border-radius: 10px; margin-bottom: 6px; border: 1px solid #eee; }
        .judul-aspek { font-size: 10px; font-weight: 700; color: var(--primary); width: 40%; text-transform: uppercase; }
        .rating { display: flex; gap: 12px; }
        .star { cursor: pointer; font-size: 24px; color: #ddd; transition: 0.2s; }
        .star.active[data-val="1"] { color: #ef4444; }
        .star.active[data-val="2"] { color: #f97316; }
        .star.active[data-val="3"] { color: #fbbf24; }
        .star.active[data-val="4"] { color: #22c55e; }

        .btn-aksi { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; margin-top: 8px; }
        .btn-simpan { background: var(--primary); color: white; }
        
        #overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="overlay"><div class="spinner"></div><p style="margin-top:10px; font-weight:700; color:var(--primary)">MENYIMPAN DATA...</p></div>

<div class="wadah">
    <header><h1>OBSERVASI KARAKTER</h1></header>

    <nav>
        <div class="nav-btn active">INPUT DATA</div>
        <a href="laporan.html" class="nav-btn">ðŸ“Š REKAP (LAPORAN)</a>
    </nav>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="form-grup">
            <label>KELAS</label>
            <select id="pilih-kelas" onchange="loadSantri()">
                <option value="">Pilih Kelas</option>
                <option>7A</option><option>7B</option><option>7C</option><option>7D</option>
                <option>8A</option><option>8B</option><option>8C</option><option>8D</option>
                <option>9A</option><option>9B</option><option>9C</option><option>9D</option>
            </select>
        </div>
        <div class="form-grup">
            <label>NAMA PENILAI</label>
            <select id="nama-penilai">
                <option value="">Pilih Nama</option>
            </select>
        </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <label>PILIH BANYAK ANAK (YANG DINILAI)</label>
        <button onclick="pilihSemuaAnak(true)" style="border:none; background:none; color:var(--blue); font-weight:700; cursor:pointer; font-size:10px;">â˜‘ PILIH SEMUA</button>
    </div>
    <div id="pilih-santri-box"></div>
    
    <button onclick="setSemua4()" style="width:100%; padding:8px; margin-bottom:10px; border-radius:8px; border:1px dashed var(--primary); color:var(--primary); font-weight:700; cursor:pointer; font-size: 11px; background: #fff;">âš¡ SET SEMUA 4 BINTANG</button>

    <div id="area-aspek">
        </div>

    <button class="btn-aksi btn-simpan" onclick="simpanKolektif()">ðŸ’¾ SIMPAN KOLEKTIF</button>
</div>

<script>
    const FIREBASE_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2V6YylCXh8TkmToeNXpSX9uRiuHsQnBElBUUturdGlV1XbwrK5XFIZegOZjC-zo0/exec";
    const aspekList = ["Perkataan", "Berpakaian", "Akhlak", "Disiplin", "Jujur", "Tanggung Jawab", "Ibadah", "Peduli"];

    // Render Aspek Otomatis
    const areaAspek = document.getElementById('area-aspek');
    areaAspek.innerHTML = aspekList.map(a => `
        <div class="baris-aspek" data-aspek="${a}">
            <div class="judul-aspek">${a}</div>
            <div class="rating">
                <span class="star" data-val="1" onclick="klikStar(this,1)">â˜…</span>
                <span class="star" data-val="2" onclick="klikStar(this,2)">â˜…</span>
                <span class="star" data-val="3" onclick="klikStar(this,3)">â˜…</span>
                <span class="star" data-val="4" onclick="klikStar(this,4)">â˜…</span>
            </div>
        </div>
    `).join('');

    async function loadSantri() {
        const k = document.getElementById('pilih-kelas').value;
        const b = document.getElementById('pilih-santri-box');
        const p = document.getElementById('nama-penilai');
        if(!k) return;
        b.innerHTML = '<p style="text-align:center; padding:10px; font-size:12px;">Memuat...</p>';
        const r = await fetch(`${SCRIPT_URL}?action=getSantri&kelas=${k}`);
        const data = await r.json();
        
        b.innerHTML = '';
        p.innerHTML = '<option value="">Pilih Nama</option>';
        data.forEach(s => {
            // Dropdown Penilai
            p.innerHTML += `<option value="${s.nama}">${s.nama}</option>`;
            // Checkbox Anak yang dinilai
            const d = document.createElement('div');
            d.className = 'item-santri';
            d.innerHTML = `<input type="checkbox" class="cb-santri" value="${s.nipd}" data-nama="${s.nama}"> <span>${s.nama}</span>`;
            d.onclick = (e) => { if(e.target.tagName !== 'INPUT') { const c = d.querySelector('input'); c.checked = !c.checked; } };
            b.appendChild(d);
        });
    }

    function pilihSemuaAnak(v) { document.querySelectorAll('.cb-santri').forEach(c => c.checked = v); }

    function klikStar(el, n) {
        const p = el.parentElement;
        p.querySelectorAll('.star').forEach((s, i) => s.classList.toggle('active', i < n));
        p.parentElement.setAttribute('data-nilai', n);
    }

    function setSemua4() { document.querySelectorAll('.baris-aspek').forEach(b => klikStar(b.querySelectorAll('.star')[3], 4)); }

    async function simpanKolektif() {
        const cbs = document.querySelectorAll('.cb-santri:checked');
        const asp = document.querySelectorAll('.baris-aspek');
        const kls = document.getElementById('pilih-kelas').value;
        const penilai = document.getElementById('nama-penilai').value;
        
        if(cbs.length === 0 || !penilai) return alert("Pilih Penilai dan Santri yang dinilai!");
        
        document.getElementById('overlay').style.display = 'flex';
        const tgl = new Date().toISOString().split('T')[0];
        const penilaiId = penilai.replace(/\./g, '_');

        let skorObj = {};
        asp.forEach(a => {
            skorObj[a.getAttribute('data-aspek')] = a.getAttribute('data-nilai') || 4;
        });

        for(let c of cbs) {
            const namaTarget = c.getAttribute('data-nama');
            await fetch(`${FIREBASE_URL}/observasi/${kls}/${tgl}/${namaTarget}/${penilaiId}.json`, { 
                method: 'PUT', 
                body: JSON.stringify({ skor: skorObj, timestamp: Date.now() }) 
            });
        }
        
        document.getElementById('overlay').style.display = 'none';
        alert("Berhasil simpan " + cbs.length + " data!");
        location.reload();
    }
</script>
</body>
</html>
