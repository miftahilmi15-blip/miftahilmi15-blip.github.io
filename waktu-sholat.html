<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYOND Prayer & Qibla - Smart Indicator</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #5E915E;
            --light-green: #E9F5E9;
            --accent-gold: #FFB800;
            --bg-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }

        .phone-container {
            width: 375px; height: 780px; background: var(--bg-white);
            border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden; position: relative; border: 8px solid #333;
        }

        .header {
            background: var(--primary-green); padding: 50px 20px 40px;
            color: white; text-align: center; border-radius: 0 0 35px 35px;
        }
        .time-now { font-size: 3.5rem; font-weight: 700; line-height: 1; }
        .date-text { font-size: 1rem; opacity: 0.9; margin-top: 10px; font-weight: 500; }

        .menu-actions { display: flex; justify-content: center; gap: 15px; margin-top: -25px; }
        .btn-action {
            background: white; padding: 12px 25px; border-radius: 25px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); border: none;
            display: flex; align-items: center; gap: 8px; font-weight: 700; color: #444; cursor: pointer;
            transition: 0.2s;
        }
        .btn-action:active { transform: scale(0.95); }

        /* Kiblat Page */
        .kiblat-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; flex-direction: column; align-items: center;
            padding: 60px 20px 20px;
        }
        .qibla-header { text-align: center; width: 100%; margin-bottom: 20px; }
        .qibla-header h2 { font-size: 1.5rem; color: #000; }
        .qibla-header p { font-size: 0.9rem; color: #666; margin-top: 10px; }

        .compass-wrap {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center; margin-top: 20px;
        }
        .outer-ring {
            width: 280px; height: 280px; border: 12px solid #F0F4F4; border-radius: 50%;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .degree-center { font-size: 3rem; font-weight: 700; color: #000; z-index: 5; transition: color 0.3s; }
        
        .kaaba-orbit { position: absolute; width: 100%; height: 100%; z-index: 10; transition: transform 0.1s; }
        .kaaba-box {
            position: absolute; top: -20px; left: calc(50% - 25px);
            width: 50px; height: 50px; background: var(--accent-gold);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 15px rgba(255,184,0,0.5); font-size: 1.5rem;
        }
        .pointer-up {
            position: absolute; top: 10px; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 20px solid #EF4444; z-index: 10;
        }

        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; border: none; background: none; color: #333; }
        
        .prayer-list { padding: 30px 20px; height: 450px; overflow-y: auto; }
        .prayer-item {
            display: flex; justify-content: space-between; padding: 20px;
            background: white; border-radius: 20px; margin-bottom: 12px; 
            border: 1px solid #f0f0f0; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .prayer-item span:first-child { font-weight: 600; font-size: 1rem; color: #444; }
        .prayer-item span:last-child { font-weight: 700; color: #888; }

        .prayer-item.active { 
            background: var(--light-green); 
            border-color: var(--primary-green); 
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(94, 145, 94, 0.15);
        }
        .prayer-item.active span { color: var(--primary-green) !important; }

        .sensor-btn {
            background: var(--primary-green); color: white; border: none;
            padding: 12px 30px; border-radius: 20px; margin-top: 20px;
            font-weight: 700; cursor: pointer;
        }
    </style>
</head>
<body>

<audio id="adzanAudio" src="https://www.islamcan.com/audio/adhan/makkah.mp3" preload="auto"></audio>

<div class="phone-container">
    <div class="header">
        <p>üìç <span id="cityName">Mencari Lokasi...</span></p>
        <div class="time-now" id="liveClock">00:00</div>
        <p class="date-text" id="dateDisplay">Memuat Tanggal...</p>
    </div>

    <div class="menu-actions">
        <button class="btn-action" onclick="openMasjid()">üïå Masjid</button>
        <button class="btn-action" onclick="toggleKiblat(true)">üß≠ Kiblat</button>
    </div>

    <div class="prayer-list" id="prayerItems"></div>

    <div id="kiblatPage" class="kiblat-page">
        <button class="close-btn" onclick="toggleKiblat(false)">‚úï</button>
        <div class="qibla-header">
            <h2>Arah Kiblat</h2>
            <p>Target: <span id="targetDeg" style="font-weight: bold; color: var(--primary-green);">...</span>¬∞</p>
        </div>
        <div class="compass-wrap">
            <div class="pointer-up"></div>
            <div class="outer-ring" id="compassRing">
                <div class="degree-center" id="currentHeadingDisplay">0¬∞</div>
                <div class="kaaba-orbit" id="kaabaOrbit">
                    <div class="kaaba-box">üïã</div>
                </div>
            </div>
        </div>
        <button class="sensor-btn" id="sensorBtn" onclick="requestSensor()">Aktifkan Sensor</button>
        <p style="font-size: 0.7rem; color: #999; margin-top: 15px; text-align: center; padding: 0 20px;">
            Gerakkan HP membentuk angka 8 jika arah kompas tidak akurat.
        </p>
    </div>
</div>

<script>
    let userLat, userLon, qiblaAngle = 295;
    let currentHeading = 0, lerpHeading = 0;
    const filterFactor = 0.2; 
    let prayerTimesData = {};
    let adzanPlayedStatus = { Fajr: false, Dhuhr: false, Asr: false, Maghrib: false, Isha: false };

    function init() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log("Service Worker Active"))
                .catch(err => console.log("Service Worker Failed", err));
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                fetchData(userLat, userLon);
                calculateQibla(userLat, userLon);
            }, () => { 
                fetchData(-6.2000, 106.8166); 
                calculateQibla(-6.2000, 106.8166);
            });
        }
        
        if ("Notification" in window) {
            Notification.requestPermission();
        }

        updateTime();
        setInterval(updateTime, 1000);
        setInterval(updateActivePrayer, 30000); 
        animate(); 
    }

    async function fetchData(lat, lon) {
        try {
            const dateObj = new Date();
            const d = dateObj.toISOString().split('T')[0];
            // Menggunakan method=20 (Kemenag RI) atau method=3 agar mirip jadwal Google/Lokal Indonesia
            const [locRes, prayRes] = await Promise.all([
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json()),
                fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lon}&method=20`).then(r => r.json())
            ]);
            document.getElementById('cityName').innerText = locRes.address.city || locRes.address.town || "Lokasi Anda";
            document.getElementById('dateDisplay').innerText = dateObj.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
            prayerTimesData = prayRes.data.timings;
            renderPrayerList();
        } catch(e) { console.error("Error data"); }
    }

    function renderPrayerList() {
        if(!prayerTimesData.Fajr) return;
        const t = prayerTimesData;
        const list = [["Subuh", t.Fajr], ["Dzuhur", t.Dhuhr], ["Ashar", t.Asr], ["Maghrib", t.Maghrib], ["Isya", t.Isha]];
        document.getElementById('prayerItems').innerHTML = list.map((p, i) => `<div class="prayer-item" id="pray-${i}"><span>${p[0]}</span><span>${p[1]}</span></div>`).join('');
        updateActivePrayer();
    }

    function triggerAdzan(sholatName) {
        const audio = document.getElementById('adzanAudio');
        audio.volume = 1.0;

        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification(`Waktu Sholat ${sholatName}`, {
                    body: `Waktu sholat ${sholatName} telah tiba untuk wilayah ${document.getElementById('cityName').innerText}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/2972/2972304.png',
                    vibrate: [500, 100, 500, 100, 500],
                    requireInteraction: true
                });
            });
        }
        
        // Coba putar audio (memerlukan setidaknya 1 klik user sebelumnya)
        audio.play().catch(e => console.log("Audio play diblokir: " + e));
    }

    function updateActivePrayer() {
        if (!prayerTimesData.Fajr) return;
        const now = new Date();
        const curH = now.getHours().toString().padStart(2, '0');
        const curM = now.getMinutes().toString().padStart(2, '0');
        const currentTimeStr = `${curH}:${curM}`;
        const curTotalMin = now.getHours() * 60 + now.getMinutes();

        const names = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
        const indoNames = ["Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya"];
        const times = [prayerTimesData.Fajr, prayerTimesData.Dhuhr, prayerTimesData.Asr, prayerTimesData.Maghrib, prayerTimesData.Isha];
        
        let activeIdx = -1;

        times.forEach((t, i) => {
            const [h, m] = t.split(':').map(Number);
            if (curTotalMin >= (h * 60 + m)) activeIdx = i;

            if (currentTimeStr === t && !adzanPlayedStatus[names[i]]) {
                triggerAdzan(indoNames[i]);
                adzanPlayedStatus[names[i]] = true;
            }
            if (currentTimeStr !== t) {
                adzanPlayedStatus[names[i]] = false;
            }
        });

        document.querySelectorAll('.prayer-item').forEach(el => el.classList.remove('active'));
        if (activeIdx !== -1) document.getElementById(`pray-${activeIdx}`).classList.add('active');
    }

    function calculateQibla(lat, lon) {
        const phiK = 21.4225 * Math.PI / 180; const lamK = 39.8262 * Math.PI / 180;
        const phi = lat * Math.PI / 180; const lam = lon * Math.PI / 180;
        let q = Math.atan2(Math.sin(lamK-lam), Math.cos(phi)*Math.tan(phiK)-Math.sin(phi)*Math.cos(lamK-lam));
        qiblaAngle = (q * 180 / Math.PI + 360) % 360;
        document.getElementById('targetDeg').innerText = Math.round(qiblaAngle);
        document.getElementById('kaabaOrbit').style.transform = `rotate(${qiblaAngle}deg)`;
    }

    function toggleKiblat(show) {
        document.getElementById('kiblatPage').style.display = show ? 'flex' : 'none';
        if(!show) {
            window.removeEventListener('deviceorientationabsolute', handleOrientation);
            window.removeEventListener('deviceorientation', handleOrientation);
        }
    }

    function requestSensor() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(state => { if (state === 'granted') startCompass(); });
        } else { startCompass(); }
    }

    function startCompass() {
        if ('ondeviceorientationabsolute' in window) {
            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        } else {
            window.addEventListener('deviceorientation', handleOrientation, true);
        }
        document.getElementById('sensorBtn').style.display = 'none';
    }

    function handleOrientation(e) {
        let heading = e.webkitCompassHeading || (360 - e.alpha);
        if (heading !== undefined) currentHeading = heading;
    }

    function animate() {
        let diff = currentHeading - lerpHeading;
        if (diff > 180) diff -= 360;
        if (diff < -180) diff += 360;
        lerpHeading += diff * filterFactor;
        lerpHeading = (lerpHeading + 360) % 360;

        const ring = document.getElementById('compassRing');
        const orbit = document.getElementById('kaabaOrbit');
        const display = document.getElementById('currentHeadingDisplay');
        
        if (ring) {
            ring.style.transform = `rotate(${-lerpHeading}deg)`;
            orbit.style.transform = `rotate(${qiblaAngle}deg)`;
            display.innerText = Math.round(lerpHeading) + "¬∞";
            const diffQibla = Math.abs(lerpHeading - qiblaAngle);
            display.style.color = (diffQibla < 2 || diffQibla > 358) ? "var(--primary-green)" : "#000";
        }
        requestAnimationFrame(animate);
    }

    function updateTime() {
        const n = new Date();
        document.getElementById('liveClock').innerText = n.getHours().toString().padStart(2,'0')+":"+n.getMinutes().toString().padStart(2,'0');
    }

    function openMasjid() {
        if (userLat) window.open(`https://www.google.com/maps/search/masjid+terdekat/@${userLat},${userLon},15z`, '_blank');
    }

   document.addEventListener('click', function() {
        const audio = document.getElementById('adzanAudio');
        audio.muted = true;
        audio.play().then(() => {
            audio.pause();
            audio.muted = false;
            console.log("Audio Unlocked");
        });
    }, { once: true });

    init();
</script>
</body>
</html>
