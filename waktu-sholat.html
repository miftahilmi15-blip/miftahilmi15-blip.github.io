<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Al-Irsyad: Absensi & Waktu Sholat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --hijau-utama: #1f6f51; 
            --hijau-terang: #22c55e; 
            --merah: #ef4444;
            --bg: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #334155; padding: 15px; }

        /* HEADER & ISLAMI SECTION */
        .grid-header { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 12px; margin-bottom: 20px; }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* WAKTU SHOLAT */
        .sholat-item { 
            display: flex; justify-content: space-between; padding: 8px 10px; 
            margin: 4px 0; border-radius: 8px; font-size: 13px; font-weight: 600;
            border: 1px solid #f1f5f9; transition: 0.3s;
        }
        .aktif { 
            background: #ecfdf5; color: var(--hijau-terang); 
            border: 1px solid var(--hijau-terang); box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }

        /* KOMPAS */
        .compass-box { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .compass { 
            width: 70px; height: 70px; border: 3px solid var(--hijau-utama); 
            border-radius: 50%; margin: 10px 0; position: relative; 
        }
        .needle { 
            width: 3px; height: 35px; background: var(--merah); 
            position: absolute; left: 50%; bottom: 50%; 
            transform-origin: bottom; transform: translateX(-50%) rotate(0deg); 
            transition: transform 0.5s ease-out;
        }

        /* ABSENSI SECTION */
        .absensi-card { background: white; border-radius: 18px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .pilih-box { display: flex; gap: 10px; margin-bottom: 15px; }
        select { flex: 1; padding: 12px; border-radius: 10px; border: 1.5px solid #e2e8f0; outline: none; font-weight: bold; }
        .btn-kirim { background: var(--hijau-utama); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th { text-align: left; padding: 12px; font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        .status-group { display: flex; gap: 4px; }
        .btn-st { width: 34px; height: 34px; border: 1.5px solid #eee; background: white; border-radius: 8px; font-weight: bold; cursor: pointer; color: #94a3b8; }
        .h-aktif { background: var(--hijau-terang) !important; color: white !important; border-color: var(--hijau-terang); }
        .s-aktif { background: #eab308 !important; color: white !important; border-color: #eab308; }
        .i-aktif { background: #3b82f6 !important; color: white !important; border-color: #3b82f6; }
        .a-aktif { background: var(--merah) !important; color: white !important; border-color: var(--merah); }

        #loading { display: none; text-align: center; font-size: 12px; color: var(--hijau-utama); margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="grid-header">
    <div class="card">
        <div id="hijri-display" style="font-size: 11px; font-weight: 700; color: var(--hijau-utama); margin-bottom: 8px;">Memuat Kalender...</div>
        <div id="sholat-list">
            <div class="sholat-item" id="item-subuh">Subuh <span id="wkt-subuh">04:32</span></div>
            <div class="sholat-item" id="item-dzuhur">Dzuhur <span id="wkt-dzuhur">12:10</span></div>
            <div class="sholat-item" id="item-ashar">Ashar <span id="wkt-ashar">15:30</span></div>
            <div class="sholat-item" id="item-maghrib">Maghrib <span id="wkt-maghrib">18:19</span></div>
            <div class="sholat-item" id="item-isya">Isya <span id="wkt-isya">19:35</span></div>
        </div>
    </div>
    <div class="card compass-box">
        <span style="font-size: 10px; font-weight: 800;">QIBLAT</span>
        <div class="compass"><div class="needle" id="needle"></div></div>
        <span id="degree" style="font-size: 10px; font-weight: 600;">0°</span>
    </div>
</div>

<div class="absensi-card">
    <div id="loading">Sedang memproses...</div>
    <div class="pilih-box">
        <select id="pilih-kelas">
            <option value="">-- Pilih Kelas --</option>
            <optgroup label="Kelas 7"><option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="7D">7D</option></optgroup>
            <optgroup label="Kelas 8"><option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option><option value="8D">8D</option></optgroup>
            <optgroup label="Kelas 9"><option value="9A">9A</option><option value="9B">9B</option><option value="9C">9C</option><option value="9D">9D</option></optgroup>
        </select>
        <button class="btn-kirim" onclick="kirimSemua()">SIMPAN</button>
    </div>

    <div class="table-container">
        <table id="tabel-siswa">
            <thead><tr><th>Nama Santri</th><th style="text-align:center">Status</th></tr></thead>
            <tbody><tr><td colspan="2" style="text-align:center; color:#94a3b8; padding:20px;">Pilih kelas untuk absen</td></tr></tbody>
        </table>
    </div>
</div>

<script>
    const URL_SERVER = "https://script.google.com/macros/s/AKfycbywL4XBIzx0kXjBH9oDJTIEHh494-V6IivNN585bSGLdXXJPwgF98GOvA47ezT3Suoj/exec";

    // 1. UPDATE KALENDER HIJRIAH
    const displayHijri = () => {
        const date = new Date();
        const formatted = new Intl.DateTimeFormat('id-TN-u-ca-islamic-uma', { day:'numeric', month:'long', year:'numeric' }).format(date);
        document.getElementById('hijri-display').innerText = formatted.toUpperCase();
    };

    // 2. UPDATE INDIKATOR WARNA HIJAU SHOLAT
    const updateSholatStatus = () => {
        const now = new Date();
        const timeNow = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        
        const times = {
            subuh: document.getElementById('wkt-subuh').innerText,
            dzuhur: document.getElementById('wkt-dzuhur').innerText,
            ashar: document.getElementById('wkt-ashar').innerText,
            maghrib: document.getElementById('wkt-maghrib').innerText,
            isya: document.getElementById('wkt-isya').innerText
        };

        document.querySelectorAll('.sholat-item').forEach(el => el.classList.remove('aktif'));

        if (timeNow >= times.subuh && timeNow < times.dzuhur) document.getElementById('item-subuh').classList.add('aktif');
        else if (timeNow >= times.dzuhur && timeNow < times.ashar) document.getElementById('item-dzuhur').classList.add('aktif');
        else if (timeNow >= times.ashar && timeNow < times.maghrib) document.getElementById('item-ashar').classList.add('aktif');
        else if (timeNow >= times.maghrib && timeNow < times.isya) document.getElementById('item-maghrib').classList.add('aktif');
        else document.getElementById('item-isya').classList.add('aktif');
    };

    // 3. KOMPAS SENSOR
    window.addEventListener('deviceorientation', (e) => {
        if (e.alpha !== null) {
            document.getElementById('needle').style.transform = `translateX(-50%) rotate(${-e.alpha}deg)`;
            document.getElementById('degree').innerText = Math.round(e.alpha) + "°";
        }
    }, true);

    // 4. LOGIKA ABSENSI
    document.getElementById('pilih-kelas').addEventListener('change', async (e) => {
        const kelas = e.target.value;
        if(!kelas) return;
        document.getElementById('loading').style.display = 'block';
        
        try {
            const res = await fetch(`${URL_SERVER}?kelas=${kelas}`);
            const data = await res.json();
            const tbody = document.querySelector('#tabel-siswa tbody');
            tbody.innerHTML = '';
            data.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600;">${s.nama}</td>
                    <td class="status-group">
                        <button class="btn-st" onclick="pick(this,'H')">H</button>
                        <button class="btn-st" onclick="pick(this,'S')">S</button>
                        <button class="btn-st" onclick="pick(this,'I')">I</button>
                        <button class="btn-st" onclick="pick(this,'A')">A</button>
                    </td>`;
                tr.setAttribute('data-nama', s.nama);
                tr.setAttribute('data-nipd', s.nipd);
                tbody.appendChild(tr);
            });
        } catch (e) { alert("Gagal ambil data."); }
        document.getElementById('loading').style.display = 'none';
    });

    function pick(btn, st) {
        btn.parentElement.querySelectorAll('.btn-st').forEach(b => b.className = 'btn-st');
        const color = {'H':'h-aktif', 'S':'s-aktif', 'I':'i-aktif', 'A':'a-aktif'};
        btn.classList.add(color[st]);
        btn.setAttribute('data-res', st);
    }

    async function kirimSemua() {
        const kelas = document.getElementById('pilih-kelas').value;
        const rows = document.querySelectorAll('#tabel-siswa tbody tr');
        const payload = [];

        rows.forEach(tr => {
            const res = tr.querySelector('.btn-st[data-res]');
            if(res) {
                payload.push({
                    kelas: kelas,
                    nipd: tr.getAttribute('data-nipd'),
                    nama: tr.getAttribute('data-nama'),
                    status: res.getAttribute('data-res')
                });
            }
        });

        if(payload.length === 0) return alert("Pilih absen dulu!");
        document.getElementById('loading').style.display = 'block';

        try {
            await fetch(URL_SERVER, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("✅ Absen " + kelas + " Berhasil Disimpan!");
            location.reload();
        } catch (e) { alert("Gagal kirim."); }
        document.getElementById('loading').style.display = 'none';
    }

    // Inisialisasi
    displayHijri();
    updateSholatStatus();
    setInterval(updateSholatStatus, 30000); // Cek setiap 30 detik
</script>
</body>
</html>
