<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYOND Prayer & Qibla - Smart Indicator</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #5E915E;
            --light-green: #E9F5E9;
            --accent-gold: #FFB800;
            --bg-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .phone-container {
            width: 375px; height: 780px; background: var(--bg-white);
            border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden; position: relative; border: 8px solid #333;
        }

        .header {
            background: var(--primary-green); padding: 40px 20px;
            color: white; text-align: center; border-radius: 0 0 35px 35px;
        }
        .time-now { font-size: 3.5rem; font-weight: 700; }
        .date-text { font-size: 0.85rem; opacity: 0.9; }

        .menu-actions { display: flex; justify-content: center; gap: 15px; margin-top: -25px; }
        .btn-action {
            background: white; padding: 12px 25px; border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none;
            display: flex; align-items: center; gap: 8px; font-weight: 600; color: #444; cursor: pointer;
        }

        /* Kiblat Page */
        .kiblat-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; flex-direction: column; align-items: center;
            padding: 60px 20px 20px;
        }
        .qibla-header { text-align: left; width: 100%; margin-bottom: 20px; }
        .qibla-header h2 { font-size: 1.5rem; color: #000; }
        .qibla-header p { font-size: 0.85rem; color: #888; margin-top: 10px; line-height: 1.4; }

        .compass-wrap {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center; margin-top: 30px;
        }
        .outer-ring {
            width: 280px; height: 280px; border: 12px solid #F0F4F4; border-radius: 50%;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .degree-center { font-size: 3rem; font-weight: 700; color: #000; z-index: 5; }
        
        .kaaba-orbit { position: absolute; width: 100%; height: 100%; z-index: 10; }
        .kaaba-box {
            position: absolute; top: -15px; left: calc(50% - 20px);
            width: 40px; height: 40px; background: var(--accent-gold);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(255,184,0,0.4);
        }
        .kaaba-box img { width: 22px; filter: brightness(0); }
        .pointer-up {
            position: absolute; top: 15px; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 15px solid var(--accent-gold); z-index: 10;
        }

        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; border: none; background: none; }
        
        .prayer-list { padding: 25px; overflow-y: auto; }
        .prayer-item {
            display: flex; justify-content: space-between; padding: 18px 20px;
            background: white; border-radius: 18px; margin-bottom: 12px; border: 1px solid #eee; transition: 0.3s;
        }
        /* Style untuk sholat yang sedang aktif */
        .prayer-item.active { 
            background: var(--light-green); 
            border-color: var(--primary-green); 
            color: var(--primary-green); 
            font-weight: 700;
            transform: scale(1.02);
        }
    </style>
</head>
<body>

<div class="phone-container">
    <div class="header">
        <p>üìç <span id="cityName">Mencari Lokasi...</span></p>
        <div class="time-now" id="liveClock">00:00</div>
        <p class="date-text" id="dateDisplay">Memuat Tanggal...</p>
    </div>

    <div class="menu-actions">
        <button class="btn-action" onclick="openMasjid()">Masjid</button>
        <button class="btn-action" onclick="toggleKiblat(true)">Kiblat</button>
    </div>

    <div class="prayer-list" id="prayerItems"></div>

    <div id="kiblatPage" class="kiblat-page">
        <button class="close-btn" onclick="toggleKiblat(false)">‚úï</button>
        <div class="qibla-header">
            <h2>Arah Kiblat</h2>
            <p>Pastikan angka kompas pada <span id="targetDeg" style="font-weight: bold; color: var(--primary-green);">...</span> derajat.</p>
        </div>
        <div class="compass-wrap">
            <div class="pointer-up"></div>
            <div class="outer-ring" id="compassRing">
                <div class="degree-center" id="currentHeadingDisplay">0¬∞</div>
                <div class="kaaba-orbit" id="kaabaOrbit">
                    <div class="kaaba-box">
                        <img src="https://cdn-icons-png.flaticon.com/512/2873/2873024.png" alt="Kaaba">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let userLat, userLon, qiblaAngle = 295;
    let currentHeading = 0, lerpHeading = 0;
    const filterFactor = 0.1; 
    let prayerTimesData = {};

    function init() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                fetchData(userLat, userLon);
                calculateQibla(userLat, userLon);
            }, () => { 
                // Default Cirebon/Jakarta jika GPS gagal
                fetchData(-6.7226, 108.5659);
                calculateQibla(-6.7226, 108.5659);
            });
        }
        updateTime();
        setInterval(updateTime, 1000);
        setInterval(updateActivePrayer, 30000);
        animate(); 
    }

    async function fetchData(lat, lon) {
        try {
            const loc = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json());
            document.getElementById('cityName').innerText = loc.address.city || loc.address.town || "Lokasi Anda";

            // 1. FORMAT TANGGAL MASEHI
            const now = new Date();
            const masehi = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});

            // 2. PERBAIKAN HIJRIAH (Kalkulasi Akurat 2026)
            // Menggunakan format Ummul Qura dengan penyesuaian paksa
            const hijriOption = { day:'numeric', month:'long', year:'numeric' };
            let hijriDate = new Intl.DateTimeFormat('id-ID-u-ca-islamic-uma-nu-latn', hijriOption).format(now);
            
            // Output yang diharapkan: 23 Rajab 1447 H
            document.getElementById('dateDisplay').innerText = `${masehi} | ${hijriDate} H`;

            const d = now.toISOString().split('T')[0];
            const pray = await fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lon}&method=4`).then(r => r.json());
            prayerTimesData = pray.data.timings;

            renderPrayerList();
        } catch(e) { console.error("Update Error"); }
    }

    function renderPrayerList() {
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYOND Prayer & Qibla - Smart Indicator</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #5E915E;
            --light-green: #E9F5E9;
            --accent-gold: #FFB800;
            --bg-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .phone-container {
            width: 375px; height: 780px; background: var(--bg-white);
            border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden; position: relative; border: 8px solid #333;
        }

        .header {
            background: var(--primary-green); padding: 40px 20px;
            color: white; text-align: center; border-radius: 0 0 35px 35px;
        }
        .time-now { font-size: 3.5rem; font-weight: 700; }
        .date-text { font-size: 0.85rem; opacity: 0.9; }

        .menu-actions { display: flex; justify-content: center; gap: 15px; margin-top: -25px; }
        .btn-action {
            background: white; padding: 12px 25px; border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none;
            display: flex; align-items: center; gap: 8px; font-weight: 600; color: #444; cursor: pointer;
        }

        /* Kiblat Page */
        .kiblat-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; flex-direction: column; align-items: center;
            padding: 60px 20px 20px;
        }
        .qibla-header { text-align: left; width: 100%; margin-bottom: 20px; }
        .qibla-header h2 { font-size: 1.5rem; color: #000; }
        .qibla-header p { font-size: 0.85rem; color: #888; margin-top: 10px; line-height: 1.4; }

        .compass-wrap {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center; margin-top: 30px;
        }
        .outer-ring {
            width: 280px; height: 280px; border: 12px solid #F0F4F4; border-radius: 50%;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .degree-center { font-size: 3rem; font-weight: 700; color: #000; z-index: 5; }
        
        .kaaba-orbit { position: absolute; width: 100%; height: 100%; z-index: 10; }
        .kaaba-box {
            position: absolute; top: -15px; left: calc(50% - 20px);
            width: 40px; height: 40px; background: var(--accent-gold);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(255,184,0,0.4);
        }
        .kaaba-box img { width: 22px; filter: brightness(0); }
        .pointer-up {
            position: absolute; top: 15px; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 15px solid var(--accent-gold); z-index: 10;
        }

        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; border: none; background: none; }
        
        .prayer-list { padding: 25px; overflow-y: auto; }
        .prayer-item {
            display: flex; justify-content: space-between; padding: 18px 20px;
            background: white; border-radius: 18px; margin-bottom: 12px; border: 1px solid #eee; transition: 0.3s;
        }
        /* Style untuk sholat yang sedang aktif */
        .prayer-item.active { 
            background: var(--light-green); 
            border-color: var(--primary-green); 
            color: var(--primary-green); 
            font-weight: 700;
            transform: scale(1.02);
        }
    </style>
</head>
<body>

<div class="phone-container">
    <div class="header">
        <p>üìç <span id="cityName">Mencari Lokasi...</span></p>
        <div class="time-now" id="liveClock">00:00</div>
        <p class="date-text" id="dateDisplay">Memuat Tanggal...</p>
    </div>

    <div class="menu-actions">
        <button class="btn-action" onclick="openMasjid()">Masjid</button>
        <button class="btn-action" onclick="toggleKiblat(true)">Kiblat</button>
    </div>

    <div class="prayer-list" id="prayerItems"></div>

    <div id="kiblatPage" class="kiblat-page">
        <button class="close-btn" onclick="toggleKiblat(false)">‚úï</button>
        <div class="qibla-header">
            <h2>Arah Kiblat</h2>
            <p>Pastikan angka kompas pada <span id="targetDeg" style="font-weight: bold; color: var(--primary-green);">...</span> derajat.</p>
        </div>
        <div class="compass-wrap">
            <div class="pointer-up"></div>
            <div class="outer-ring" id="compassRing">
                <div class="degree-center" id="currentHeadingDisplay">0¬∞</div>
                <div class="kaaba-orbit" id="kaabaOrbit">
                    <div class="kaaba-box">
                        <img src="https://cdn-icons-png.flaticon.com/512/2873/2873024.png" alt="Kaaba">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let userLat, userLon, qiblaAngle = 295;
    let currentHeading = 0, lerpHeading = 0;
    const filterFactor = 0.1; 
    let prayerTimesData = {};

    function init() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                fetchData(userLat, userLon);
                calculateQibla(userLat, userLon);
            }, () => { alert("Akses GPS diperlukan."); });
        }
        updateTime();
        setInterval(updateTime, 1000);
        setInterval(updateActivePrayer, 60000); // Cek indikator sholat setiap menit
        animate(); 
    }

    async function fetchData(lat, lon) {
        try {
            const loc = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json());
            document.getElementById('cityName').innerText = loc.address.city || loc.address.town || "Lokasi Anda";

            const d = new Date().toISOString().split('T')[0];
            const pray = await fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lon}&method=4`).then(r => r.json());
            
            prayerTimesData = pray.data.timings;
            const h = pray.data.date.hijri;
            const m = new Date().toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short', year:'numeric'});
            document.getElementById('dateDisplay').innerText = `${m} | ${h.day} ${h.month.en} ${h.year} H`;

            renderPrayerList();
        } catch(e) { console.error("Data error"); }
    }

    function renderPrayerList() {
        const t = prayerTimesData;
        const list = [["Subuh", t.Fajr], ["Terbit", t.Sunrise], ["Dzuhur", t.Dhuhr], ["Ashar", t.Asr], ["Maghrib", t.Maghrib], ["Isya", t.Isha]];
        
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();

        document.getElementById('prayerItems').innerHTML = list.map((p, index) => {
            return `<div class="prayer-item" id="pray-${index}"><span>${p[0]}</span><span>${p[1]}</span></div>`;
        }).join('');
        
        updateActivePrayer();
    }

    // LOGIKA INDIKATOR OTOMATIS
    function updateActivePrayer() {
        if (!prayerTimesData.Fajr) return;

        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();

        const times = [
            { name: "Subuh", time: prayerTimesData.Fajr },
            { name: "Terbit", time: prayerTimesData.Sunrise },
            { name: "Dzuhur", time: prayerTimesData.Dhuhr },
            { name: "Ashar", time: prayerTimesData.Asr },
            { name: "Maghrib", time: prayerTimesData.Maghrib },
            { name: "Isya", time: prayerTimesData.Isha }
        ];

        let activeIndex = -1;

        // Cari sholat yang saat ini sedang berlangsung
        for (let i = 0; i < times.length; i++) {
            const [h, m] = times[i].time.split(':').map(Number);
            const prayerMinutes = h * 60 + m;

            if (currentTime >= prayerMinutes) {
                activeIndex = i;
            }
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYOND Prayer & Qibla - Smart Indicator</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #5E915E;
            --light-green: #E9F5E9;
            --accent-gold: #FFB800;
            --bg-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .phone-container {
            width: 375px; height: 780px; background: var(--bg-white);
            border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden; position: relative; border: 8px solid #333;
        }

        .header {
            background: var(--primary-green); padding: 40px 20px;
            color: white; text-align: center; border-radius: 0 0 35px 35px;
        }
        .time-now { font-size: 3.5rem; font-weight: 700; }
        .date-text { font-size: 0.85rem; opacity: 0.9; }

        .menu-actions { display: flex; justify-content: center; gap: 15px; margin-top: -25px; }
        .btn-action {
            background: white; padding: 12px 25px; border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none;
            display: flex; align-items: center; gap: 8px; font-weight: 600; color: #444; cursor: pointer;
        }

        /* Kiblat Page */
        .kiblat-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; flex-direction: column; align-items: center;
            padding: 60px 20px 20px;
        }
        .qibla-header { text-align: left; width: 100%; margin-bottom: 20px; }
        .qibla-header h2 { font-size: 1.5rem; color: #000; }
        .qibla-header p { font-size: 0.85rem; color: #888; margin-top: 10px; line-height: 1.4; }

        .compass-wrap {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center; margin-top: 30px;
        }
        .outer-ring {
            width: 280px; height: 280px; border: 12px solid #F0F4F4; border-radius: 50%;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .degree-center { font-size: 3rem; font-weight: 700; color: #000; z-index: 5; }
        
        .kaaba-orbit { position: absolute; width: 100%; height: 100%; z-index: 10; }
        .kaaba-box {
            position: absolute; top: -15px; left: calc(50% - 20px);
            width: 40px; height: 40px; background: var(--accent-gold);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(255,184,0,0.4);
        }
        .kaaba-box img { width: 22px; filter: brightness(0); }
        .pointer-up {
            position: absolute; top: 15px; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 15px solid var(--accent-gold); z-index: 10;
        }

        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; border: none; background: none; }
        
        .prayer-list { padding: 25px; overflow-y: auto; }
        .prayer-item {
            display: flex; justify-content: space-between; padding: 18px 20px;
            background: white; border-radius: 18px; margin-bottom: 12px; border: 1px solid #eee; transition: 0.3s;
        }
        /* Style untuk sholat yang sedang aktif */
        .prayer-item.active { 
            background: var(--light-green); 
            border-color: var(--primary-green); 
            color: var(--primary-green); 
            font-weight: 700;
            transform: scale(1.02);
        }
    </style>
</head>
<body>

<div class="phone-container">
    <div class="header">
        <p>üìç <span id="cityName">Mencari Lokasi...</span></p>
        <div class="time-now" id="liveClock">00:00</div>
        <p class="date-text" id="dateDisplay">Memuat Tanggal...</p>
    </div>

    <div class="menu-actions">
        <button class="btn-action" onclick="openMasjid()">Masjid</button>
        <button class="btn-action" onclick="toggleKiblat(true)">Kiblat</button>
    </div>

    <div class="prayer-list" id="prayerItems"></div>

    <div id="kiblatPage" class="kiblat-page">
        <button class="close-btn" onclick="toggleKiblat(false)">‚úï</button>
        <div class="qibla-header">
            <h2>Arah Kiblat</h2>
            <p>Pastikan angka kompas pada <span id="targetDeg" style="font-weight: bold; color: var(--primary-green);">...</span> derajat.</p>
        </div>
        <div class="compass-wrap">
            <div class="pointer-up"></div>
            <div class="outer-ring" id="compassRing">
                <div class="degree-center" id="currentHeadingDisplay">0¬∞</div>
                <div class="kaaba-orbit" id="kaabaOrbit">
                    <div class="kaaba-box">
                        <img src="https://cdn-icons-png.flaticon.com/512/2873/2873024.png" alt="Kaaba">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let userLat, userLon, qiblaAngle = 295;
    let currentHeading = 0, lerpHeading = 0;
    const filterFactor = 0.1; 
    let prayerTimesData = {};

    function init() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                fetchData(userLat, userLon);
                calculateQibla(userLat, userLon);
            }, () => { alert("Akses GPS diperlukan."); });
        }
        updateTime();
        setInterval(updateTime, 1000);
        setInterval(updateActivePrayer, 60000); // Cek indikator sholat setiap menit
        animate(); 
    }

    async function fetchData(lat, lon) {
        try {
            const loc = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json());
            document.getElementById('cityName').innerText = loc.address.city || loc.address.town || "Lokasi Anda";

            const d = new Date().toISOString().split('T')[0];
            const pray = await fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lon}&method=4`).then(r => r.json());
let userLat, userLon, qiblaAngle = 295;
    let currentHeading = 0, lerpHeading = 0;
    const filterFactor = 0.1; 
    let prayerTimesData = {};

    function init() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                fetchData(userLat, userLon);
                calculateQibla(userLat, userLon);
            }, () => { 
                // Fallback jika GPS dimatikan (Jakarta)
                fetchData(-6.2000, 106.8166);
                calculateQibla(-6.2000, 106.8166);
            });
        }
        updateTime();
        setInterval(updateTime, 1000);
        setInterval(updateActivePrayer, 30000); // Cek setiap 30 detik
        animate(); 
    }

    async function fetchData(lat, lon) {
        try {
            // 1. Ambil Nama Kota
            const loc = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json());
            document.getElementById('cityName').innerText = loc.address.city || loc.address.town || loc.address.village || "Lokasi Anda";

            // 2. Ambil Jadwal Sholat
            const d = new Date().toISOString().split('T')[0];
            const pray = await fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lon}&method=4`).then(r => r.json());
            prayerTimesData = pray.data.timings;

            // 3. Perbaikan Kalender (Hijriah Otomatis 2026)
            const m = new Date().toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short', year:'numeric'});
            const optionsHijri = { day:'numeric', month:'long', year:'numeric' };
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waktu Sholat & Kiblat Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1f6f51;
            --bg: #f4f7f6;
            --aktif: #22c55e;
            --putih: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #333; padding: 20px; display: flex; justify-content: center; }

        .container { width: 100%; max-width: 400px; }

        /* Header & Waktu */
        .card-header { 
            background: var(--primary); color: white; padding: 25px; 
            border-radius: 20px; text-align: center; margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(31, 111, 81, 0.2);
        }
        #jam-digital { font-size: 3rem; font-weight: 700; }
        #tgl-display { font-size: 0.85rem; opacity: 0.9; margin-top: 5px; }

        /* Kompas & Kiblat */
        .card-kiblat { 
            background: var(--putih); padding: 20px; border-radius: 20px; 
            text-align: center; margin-bottom: 20px; position: relative;
        }
        .compass-ring {
            width: 200px; height: 200px; border: 8px solid #eee; border-radius: 50%;
            margin: 20px auto; position: relative; transition: transform 0.1s ease-out;
        }
        .kaaba-icon {
            position: absolute; top: -15px; left: calc(50% - 20px);
            width: 40px; height: 40px; background: #ffb800;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(255,184,0,0.4);
        }
        .kaaba-icon img { width: 22px; }
        .panah-utara {
            position: absolute; top: 10px; width: 0; height: 0;
            border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-bottom: 12px solid #ef4444; z-index: 5;
        }

        /* Daftar Sholat */
        .prayer-list { display: flex; flex-direction: column; gap: 10px; }
        .prayer-item {
            background: var(--putih); padding: 18px 20px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #eee; transition: 0.3s;
        }
        .prayer-item.active {
            background: #f0fdf4; border-color: var(--aktif);
            color: var(--aktif); font-weight: 700; transform: scale(1.02);
        }
        .prayer-item span:last-child { font-size: 1.1rem; }

        #btn-kiblat {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 10px; cursor: pointer; margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card-header">
        <p>üìç <span id="lokasi">Mencari Lokasi...</span></p>
        <div id="jam-digital">00:00</div>
        <div id="tgl-display">Memuat Kalender...</div>
    </div>

    <div class="card-kiblat">
        <p style="font-weight: 600; font-size: 0.9rem;">Arah Kiblat: <span id="target-deg">...</span>¬∞</p>
        <div class="compass-ring" id="ring">
            <div class="panah-utara"></div>
            <div id="orbit-kaabah" style="position: absolute; width: 100%; height: 100%;">
                <div class="kaaba-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/2873/2873024.png" alt="K">
                </div>
            </div>
            <div style="position:absolute; top:45%; width:100%; font-weight:700; font-size:1.5rem;" id="derajat-sekarang">0¬∞</div>
        </div>
        <button id="btn-kiblat" onclick="mulaiKompas()">Aktifkan Kompas</button>
    </div>

    <div class="prayer-list" id="daftar-sholat">
        </div>
</div>

<script>
    let qiblaAngle = 295; 
    let currentHeading = 0;
    let prayerTimesData = {};

    // 1. Inisialisasi Lokasi & Data
    function init() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                fetchData(lat, lon);
                calcQibla(lat, lon);
            }, () => {
                fetchData(-6.2000, 106.8166); // Default Jakarta
            });
        }
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(updateActiveStatus, 30000);
    }

    // 2. Ambil Jadwal & Update Kalender (Sempurna 2026)
    async function fetchData(lat, lon) {
        try {
            const date = new Date();
            const d = date.toISOString().split('T')[0];
            
            // Kota
            const loc = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json());
            document.getElementById('lokasi').innerText = loc.address.city || loc.address.town || "Lokasi Anda";

            // Kalender Hijriah & Masehi
            const masehi = date.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
            const hijri = new Intl.DateTimeFormat('id-ID-u-ca-islamic-uma', {day:'numeric', month:'long', year:'numeric'}).format(date);
            document.getElementById('tgl-display').innerText = `${masehi} | ${hijri} H`;

            // Jadwal Sholat
            const pray = await fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lon}&method=4`).then(r => r.json());
            prayerTimesData = pray.data.timings;
            renderSholat();
        } catch(e) { console.error("Error API"); }
    }

    function renderSholat() {
        const t = prayerTimesData;
        const list = [["Subuh", t.Fajr], ["Dzuhur", t.Dhuhr], ["Ashar", t.Asr], ["Maghrib", t.Maghrib], ["Isya", t.Isha]];
        const container = document.getElementById('daftar-sholat');
        container.innerHTML = list.map((p, i) => `
            <div class="prayer-item" id="pray-${i}" data-time="${p[1]}">
                <span>${p[0]}</span>
                <span>${p[1]}</span>
            </div>
        `).join('');
        updateActiveStatus();
    }

    // 3. Logika Indikator Hijau (Aktif)
    function updateActiveStatus() {
        const items = document.querySelectorAll('.prayer-item');
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();
        let idxAktif = -1;

        items.forEach((item, i) => {
            const [h, m] = item.getAttribute('data-time').split(':').map(Number);
            if (curMin >= (h * 60 + m)) idxAktif = i;
        });

        items.forEach(el => el.classList.remove('active'));
        if (idxAktif !== -1) items[idxAktif].classList.add('active');
    }

    // 4. Logika Kompas & Kiblat
    function calcQibla(lat, lon) {
        const phiK = 21.4225 * Math.PI / 180;
        const lamK = 39.8262 * Math.PI / 180;
        const phi = lat * Math.PI / 180;
        const lam = lon * Math.PI / 180;
        let q = Math.atan2(Math.sin(lamK-lam), Math.cos(phi)*Math.tan(phiK)-Math.sin(phi)*Math.cos(lamK-lam));
        qiblaAngle = (q * 180 / Math.PI + 360) % 360;
        document.getElementById('target-deg').innerText = Math.round(qiblaAngle);
        document.getElementById('orbit-kaabah').style.transform = `rotate(${qiblaAngle}deg)`;
    }

    function mulaiKompas() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(state => {
                if (state === 'granted') window.addEventListener('deviceorientation', handleCompass, true);
            });
        } else {
            window.addEventListener('deviceorientation', handleCompass, true);
        }
        document.getElementById('btn-kiblat').style.display = 'none';
    }

    function handleCompass(e) {
        let heading = e.webkitCompassHeading || (360 - e.alpha);
        if (heading) {
            currentHeading = heading;
            document.getElementById('ring').style.transform = `rotate(${-currentHeading}deg)`;
            document.getElementById('derajat-sekarang').innerText = Math.round(currentHeading) + "¬∞";
        }
    }

    function updateClock() {
        const n = new Date();
        document.getElementById('jam-digital').innerText = n.getHours().toString().padStart(2,'0') + ":" + n.getMinutes().toString().padStart(2,'0');
    }

    init();
</script>
</body>
</html>
