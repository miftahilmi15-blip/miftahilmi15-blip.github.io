<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat & Kiblat Pintar</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1f6f51;
            --bg: #f1f5f9;
            --aktif: #22c55e;
            --aksen: #ffb800;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #1e293b; padding: 15px; display: flex; justify-content: center; }

        .container { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }

        /* Kartu Jam & Tanggal */
        .card-header { 
            background: var(--primary); color: white; padding: 35px 20px; 
            border-radius: 25px; text-align: center;
            box-shadow: 0 10px 25px rgba(31, 111, 81, 0.2);
        }
        #jam { font-size: 3.8rem; font-weight: 800; line-height: 1; letter-spacing: -2px; }
        #tgl-lengkap { font-size: 0.85rem; font-weight: 600; opacity: 0.9; margin-top: 10px; }

        /* Bagian Kompas */
        .card-compass { 
            background: white; padding: 25px; border-radius: 25px; 
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .compass-ui {
            width: 200px; height: 200px; border: 12px solid #f8fafc; border-radius: 50%;
            margin: 20px auto; position: relative; display: flex; align-items: center; justify-content: center;
            background: #ffffff;
        }
        .ring-kompas {
            width: 100%; height: 100%; position: absolute;
            transition: transform 0.2s ease-out;
        }
        .kaabah-pointer {
            position: absolute; top: -18px; left: calc(50% - 22px);
            width: 44px; height: 44px; background: var(--aksen);
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 15px rgba(255,184,0,0.4); z-index: 10; font-size: 1.5rem;
        }
        .utara-marker {
            position: absolute; top: 5px; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 18px solid #ef4444;
        }
        .derajat-teks { font-size: 2.2rem; font-weight: 800; color: #334155; z-index: 5; }

        /* Daftar Sholat */
        .prayer-list { display: flex; flex-direction: column; gap: 10px; }
        .prayer-item {
            background: white; padding: 18px 22px; border-radius: 18px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #e2e8f0; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .prayer-item span:first-child { font-weight: 600; font-size: 1rem; }
        .prayer-item span:last-child { font-weight: 700; font-size: 1.1rem; color: #64748b; }

        /* Warna Hijau Aktif */
        .prayer-item.aktif {
            background: #f0fdf4; border-color: var(--aktif);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.15);
            transform: scale(1.03);
        }
        .prayer-item.aktif span { color: var(--aktif) !important; }

        .btn-mulai {
            background: var(--primary); color: white; border: none;
            padding: 14px 28px; border-radius: 50px; font-weight: 700;
            cursor: pointer; margin-top: 10px; width: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card-header">
        <p id="lokasi-nama">üìç Mencari Lokasi...</p>
        <div id="jam">00:00</div>
        <div id="tgl-lengkap">Memuat Kalender...</div>
    </div>

    <div class="card-compass">
        <p style="font-size: 0.75rem; font-weight: 800; color: #94a3b8; letter-spacing: 1px;">ARAH KIBLAT: <span id="qibla-val">...</span>¬∞</p>
        <div class="compass-ui">
            <div class="utara-marker"></div>
            <div class="ring-kompas" id="ring">
                <div id="orbit-kaabah" style="position: absolute; width: 100%; height: 100%;">
                    <div class="kaabah-pointer">üïã</div>
                </div>
            </div>
            <div class="derajat-teks" id="heading-val">0¬∞</div>
        </div>
        <button class="btn-mulai" id="btnCompass" onclick="izinkanSensor()">Aktifkan Kompas</button>
    </div>

    <div class="prayer-list" id="list-sholat">
        </div>
</div>



<script>
    let dataSholat = {};
    let sudutKiblat = 295;
    let headingSekarang = 0;

    // --- 1. BOOTSTRAP APLIKASI ---
    async function mulaiApp() {
        // Fallback jika GPS macet (Default Cirebon/Jakarta)
        const timeoutGps = setTimeout(() => {
            fetchData(-6.7226, 108.5659); 
            hitungKiblat(-6.7226, 108.5659);
        }, 5000);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                clearTimeout(timeoutGps);
                fetchData(pos.coords.latitude, pos.coords.longitude);
                hitungKiblat(pos.coords.latitude, pos.coords.longitude);
            }, () => {
                clearTimeout(timeoutGps);
                fetchData(-6.7226, 108.5659);
            });
        }
        updateJam();
        setInterval(updateJam, 1000);
        setInterval(cekSholatAktif, 30000);
    }

    // --- 2. AMBIL DATA JADWAL & HIJRIAH ---
    async function fetchData(lat, lon) {
        try {
            const hariIni = new Date();
            const tglIso = hariIni.toISOString().split('T')[0];
            
            // API Parallel
            const [dataLokasi, dataPray] = await Promise.all([
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(r => r.json()),
                fetch(`https://api.aladhan.com/v1/timings/${tglIso}?latitude=${lat}&longitude=${lon}&method=4`).then(r => r.json())
            ]);

            document.getElementById('lokasi-nama').innerText = `üìç ${dataLokasi.address.city || dataLokasi.address.town || 'Lokasi Terdeteksi'}`;
            
            // Perbaikan Kalender Hijriah (Ummul Qura)
            const masehi = hariIni.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
            const hijri = new Intl.DateTimeFormat('id-ID-u-ca-islamic-uma', {day:'numeric', month:'long', year:'numeric'}).format(hariIni);
            document.getElementById('tgl-lengkap').innerText = `${masehi} | ${hijri} H`;

            dataSholat = dataPray.data.timings;
            renderList();
        } catch (e) {
            document.getElementById('lokasi-nama').innerText = "üìç Mode Offline";
        }
    }

    function renderList() {
        const s = dataSholat;
        const urutan = [["Subuh", s.Fajr], ["Terbit", s.Sunrise], ["Dzuhur", s.Dhuhr], ["Ashar", s.Asr], ["Maghrib", s.Maghrib], ["Isya", s.Isha]];
        const container = document.getElementById('list-sholat');
        container.innerHTML = urutan.map((item, i) => `
            <div class="prayer-item" id="sholat-${i}" data-time="${item[1]}">
                <span>${item[0]}</span>
                <span>${item[1]}</span>
            </div>
        `).join('');
        cekSholatAktif();
    }

    // --- 3. INDIKATOR HIJAU (DETEKSI AKTIF) ---
    function cekSholatAktif() {
        const items = document.querySelectorAll('.prayer-item');
        const skrg = new Date();
        const menitSkrg = skrg.getHours() * 60 + skrg.getMinutes();
        let indexAktif = -1;

        items.forEach((el, i) => {
            const [h, m] = el.getAttribute('data-time').split(':').map(Number);
            const menitSholat = h * 60 + m;
            if (menitSkrg >= menitSholat) indexAktif = i;
        });

        items.forEach(el => el.classList.remove('aktif'));
        if (indexAktif !== -1) items[indexAktif].classList.add('aktif');
    }

    // --- 4. LOGIKA KOMPAS ---
    function hitungKiblat(lat, lon) {
        const latK = 21.4225 * Math.PI / 180;
        const lonK = 39.8262 * Math.PI / 180;
        const latU = lat * Math.PI / 180;
        const lonU = lon * Math.PI / 180;
        let q = Math.atan2(Math.sin(lonK - lonU), Math.cos(latU) * Math.tan(latK) - Math.sin(latU) * Math.cos(lonK - lonU));
        sudutKiblat = (q * 180 / Math.PI + 360) % 360;
        
        document.getElementById('qibla-val').innerText = Math.round(sudutKiblat);
        document.getElementById('orbit-kaabah').style.transform = `rotate(${sudutKiblat}deg)`;
    }

    function izinkanSensor() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(respon => {
                if (respon === 'granted') window.addEventListener('deviceorientation', gerakKompas, true);
            });
        } else {
            window.addEventListener('deviceorientation', gerakKompas, true);
        }
        document.getElementById('btnCompass').style.display = 'none';
    }

    function gerakKompas(e) {
        let heading = e.webkitCompassHeading || (360 - e.alpha);
        if (heading) {
            headingSekarang = heading;
            document.getElementById('ring').style.transform = `rotate(${-headingSekarang}deg)`;
            document.getElementById('heading-val').innerText = Math.round(headingSekarang) + "¬∞";
        }
    }

    function updateJam() {
        const n = new Date();
        document.getElementById('jam').innerText = n.getHours().toString().padStart(2,'0') + ":" + n.getMinutes().toString().padStart(2,'0');
    }

    mulaiApp();
</script>
</body>
</html>
