<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiblat & Jadwal Sholat - GPS Precision</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #5E915E;
            --light-green: #E9F5E9;
            --bg-color: #F8F9F8;
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .phone-container {
            width: 375px; height: 780px; background: var(--white);
            border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden; position: relative; border: 8px solid #333;
        }

        /* Dashboard Header */
        .header {
            background: var(--primary-green); padding: 40px 20px;
            color: var(--white); text-align: center; border-radius: 0 0 35px 35px;
        }

        .location-text { font-size: 0.9rem; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .time-now { font-size: 3.5rem; font-weight: 700; }
        .date-text { font-size: 0.85rem; opacity: 0.9; margin-bottom: 15px; }

        .menu-actions { display: flex; justify-content: center; gap: 15px; margin-top: -25px; }
        .btn-action {
            background: var(--white); padding: 12px 25px; border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none;
            display: flex; align-items: center; gap: 8px; font-weight: 600;
            color: #444; cursor: pointer; transition: 0.3s;
        }

        .prayer-list { padding: 25px; }
        .prayer-item {
            display: flex; justify-content: space-between; padding: 18px 20px;
            background: var(--white); border-radius: 18px; margin-bottom: 12px;
            border: 1px solid #eee; font-weight: 600;
        }
        .prayer-item.active { background: var(--light-green); border-color: var(--primary-green); color: var(--primary-green); }

        /* Halaman Kiblat Modern */
        .kiblat-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; flex-direction: column; align-items: center;
            padding-top: 60px;
        }

        /* Lingkaran Orbit */
        .compass-ring {
            width: 280px; height: 280px;
            border: 2px solid #ddd;
            border-radius: 50%;
            position: relative;
            margin-top: 50px;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s linear;
        }

        /* Jarum/Indikator ke arah Utara */
        .north-mark {
            position: absolute; top: -30px; font-weight: bold; color: var(--primary-green); font-size: 1.2rem;
        }

        /* Wrapper Ka'bah yang berputar di garis lingkaran */
        .kaaba-orbit {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.2s ease-out;
        }

        /* Ikon Ka'bah berada di atas garis lingkaran */
        .kaaba-icon {
            position: absolute;
            top: -25px; /* Setengah dari tinggi ikon agar pas di garis */
            left: calc(50% - 25px);
            width: 50px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .direction-display { margin-top: 50px; text-align: center; }
        .degree-val { font-size: 2.5rem; font-weight: 800; color: var(--primary-green); }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; border: none; background: none; }
    </style>
</head>
<body>

    <div class="phone-container">
        <div class="header">
            <p class="location-text">üìç <span id="cityName">Mencari Lokasi...</span></p>
            <div class="time-now" id="liveClock">00:00</div>
            <p class="date-text" id="dateDisplay">Memuat Tanggal...</p>
            <p style="font-size: 0.9rem;">Sholat Berikutnya: <strong id="nextPrayerName">-</strong></p>
        </div>

        <div class="menu-actions">
            <button class="btn-action" onclick="openMasjid()">üìç Masjid</button>
            <button class="btn-action" onclick="toggleKiblat(true)">üß≠ Kiblat</button>
        </div>

        <div class="prayer-list" id="prayerItems">
            </div>

        <div id="kiblatPage" class="kiblat-page">
            <button class="close-btn" onclick="toggleKiblat(false)">‚úï</button>
            <h2 style="color: var(--primary-green)">Arah Kiblat</h2>
            <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Arahkan HP hingga Ka'bah berada di posisi yang tepat</p>
            
            <div class="compass-ring" id="compassRing">
                <div class="north-mark">U</div>
                <div class="kaaba-orbit" id="kaabaOrbit">
                    <img src="https://cdn-icons-png.flaticon.com/512/2873/2873024.png" class="kaaba-icon" alt="Kaaba">
                </div>
                <div style="width: 15px; height: 15px; background: var(--primary-green); border-radius: 50%; box-shadow: 0 0 15px var(--primary-green);"></div>
            </div>

            <div class="direction-display">
                <div class="degree-val" id="qiblaDegree">0¬∞</div>
                <p style="font-weight: 600; color: #666;">Derajat dari Utara</p>
            </div>
        </div>
    </div>

    <script>
        let userLat, userLon, qiblaAngle = 0;

        // 1. Inisialisasi Aplikasi (GPS & Jam)
        function initApp() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    
                    fetchLocationName(userLat, userLon);
                    fetchPrayerAndHijri(userLat, userLon);
                    calculateQibla(userLat, userLon);
                }, () => {
                    alert("Akses lokasi diperlukan untuk jadwal sholat & kiblat presisi.");
                });
            }
            updateClock();
            setInterval(updateClock, 1000);
        }

        // 2. Ambil Nama Kota & Jadwal Sholat (Otomatis)
        async function fetchLocationName(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                const data = await res.json();
                document.getElementById('cityName').innerText = data.address.city || data.address.town || data.address.suburb || "Lokasi Anda";
            } catch (e) { document.getElementById('cityName').innerText = "Lokasi Terdeteksi"; }
        }

        async function fetchPrayerAndHijri(lat, lon) {
            const dateStr = new Date().toISOString().split('T')[0];
            try {
                const resp = await fetch(`https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lon}&method=4`);
                const data = await resp.json();
                
                // Set Tanggal Masehi & Hijriah
                const now = new Date();
                const masehi = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });
                const h = data.data.date.hijri;
                document.getElementById('dateDisplay').innerText = `${masehi} | ${h.day} ${h.month.en} ${h.year} H`;

                // Render List Jadwal
                const t = data.data.timings;
                const prayers = [
                    {n: "Subuh", t: t.Fajr}, {n: "Terbit", t: t.Sunrise}, 
                    {n: "Dzuhur", t: t.Dhuhr}, {n: "Ashar", t: t.Asr}, 
                    {n: "Maghrib", t: t.Maghrib}, {n: "Isya", t: t.Isha}
                ];

                let html = "";
                prayers.forEach(p => {
                    const isActive = p.n === "Maghrib" ? "active" : ""; // Simulasi aktif
                    html += `<div class="prayer-item ${isActive}"><span>${p.n}</span><span>${p.t}</span></div>`;
                });
                document.getElementById('prayerItems').innerHTML = html;
                document.getElementById('nextPrayerName').innerText = "Maghrib"; 
            } catch (e) { console.error("Gagal memuat jadwal."); }
        }

        // 3. Logika Kiblat: Ka'bah di Lingkaran
        function calculateQibla(lat, lon) {
            const phiK = 21.4225 * Math.PI / 180;
            const lambdaK = 39.8262 * Math.PI / 180;
            const phi = lat * Math.PI / 180;
            const lambda = lon * Math.PI / 180;

            const q = Math.atan2(Math.sin(lambdaK - lambda), Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda));
            qiblaAngle = (q * 180 / Math.PI + 360) % 360;
            document.getElementById('qiblaDegree').innerText = Math.round(qiblaAngle) + "¬∞";
        }

        function toggleKiblat(show) {
            document.getElementById('kiblatPage').style.display = show ? 'flex' : 'none';
            if (show && window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleCompass, true);
            }
        }

        function handleCompass(event) {
            // Deteksi arah hadap HP (Utara Magnetik)
            const alpha = event.webkitCompassHeading || (360 - event.alpha);
            
            if (alpha) {
                // Lingkaran kompas berputar sesuai hadap HP (Utara selalu di atas ring)
                document.getElementById('compassRing').style.transform = `rotate(${-alpha}deg)`;
                
                // Gambar Ka'bah diputar di atas garis lingkaran sesuai derajat kiblat
                // Kita tambahkan rotasi ke Ka'bah agar posisinya tetap di derajat yang benar terhadap Utara
                document.getElementById('kaabaOrbit').style.transform = `rotate(${qiblaAngle}deg)`;
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        }

        function openMasjid() {
            window.open(`https://www.google.com/maps/search/masjid+terdekat/@${userLat},${userLon}`, '_blank');
        }

        initApp();
    </script>
</body>
</html>
