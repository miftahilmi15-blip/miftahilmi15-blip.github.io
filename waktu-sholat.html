<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Waktu Sholat & Arah Kiblat</title>
<style>
  body { font-family: 'Poppins', sans-serif; background:#f4f7f6; text-align:center; padding:20px; }
  h1 { color:#1f6f51; margin-bottom:10px; }
  #qiblaCanvas { background:#fff; border-radius:50%; margin:20px auto; display:block; }
  .countdown { font-size:16px; margin-bottom:10px; color:#333; }
  .jadwal { display:flex; justify-content:center; gap:15px; margin-top:15px; flex-wrap:wrap; }
  .jadwal div { background:#fff; border-radius:8px; padding:10px 14px; box-shadow:0 2px 8px rgba(0,0,0,0.1); min-width:70px; }
  .jadwal div span { display:block; font-weight:600; color:#1f6f51; font-size:14px; }
  .jadwal div small { color:#555; font-size:12px; }
</style>
</head>
<body>

<h1>Waktu Sholat & Arah Kiblat</h1>
<canvas id="qiblaCanvas" width="300" height="300"></canvas>
<div class="countdown" id="nextSholat">Memuat...</div>

<div class="jadwal" id="jadwalContainer">
  <!-- Jadwal sholat akan muncul di sini -->
</div>

<script>
const canvas = document.getElementById("qiblaCanvas");
const ctx = canvas.getContext("2d");
const kaabahImg = new Image();
kaabahImg.src = "assets/Ka'bah.png"; // pastikan ada di folder assets

let lat, lon;
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{
    lat = p.coords.latitude;
    lon = p.coords.longitude;
    updateJadwal();
    kaabahImg.onload = drawQibla; // mulai animasi setelah gambar Ka'bah load
  }, e=>alert("Geolokasi tidak diizinkan!"));
}else{
  alert("Geolokasi tidak didukung browser ini!");
}

function updateJadwal(){
  // Hitung jadwal sholat menggunakan library sederhana (hanya perkiraan)
  // Bisa diganti library akurat seperti "adhan.js"
  const date = new Date();
  const times = {
    Fajr: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 4,37),
    Dhuhr: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 11,54),
    Asr: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 15,19),
    Maghrib: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 18,8),
    Isha: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 19,10)
  };

  const container = document.getElementById("jadwalContainer");
  container.innerHTML = "";
  for(const [name,time] of Object.entries(times)){
    const d = document.createElement("div");
    d.innerHTML = `<span>${name}</span><small>${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}</small>`;
    container.appendChild(d);
  }

  // Countdown
  updateCountdown(times);
}

function updateCountdown(times){
  const nextSholatEl = document.getElementById("nextSholat");
  setInterval(()=>{
    const now = new Date();
    let nextName = "";
    let nextTime = null;
    for(const [name,time] of Object.entries(times)){
      if(time>now){ nextName=name; nextTime=time; break; }
    }
    if(!nextTime){ nextName="Fajr"; nextTime=new Date(times.Fajr.getTime()+24*60*60*1000); } // besok
    const diff = nextTime-now;
    const h = Math.floor(diff/3600000);
    const m = Math.floor((diff%3600000)/60000);
    const s = Math.floor((diff%60000)/1000);
    nextSholatEl.textContent = `Menuju ${nextName}: ${h}j ${m}m ${s}s`;
  },1000);
}

function drawQibla(){
  const kaabah = {lat:21.4225, lon:39.8262};
  const φ1 = lat*Math.PI/180, λ1 = lon*Math.PI/180;
  const φ2 = kaabah.lat*Math.PI/180, λ2 = kaabah.lon*Math.PI/180;
  const y = Math.sin(λ2-λ1)*Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
  const brng = Math.atan2(y, x);
  let angle = brng*180/Math.PI;
  if(angle<0) angle+=360;

  let current = 0;
  const centerX = canvas.width/2;
  const centerY = canvas.height/2;
  const radius = 100;

  function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Lingkaran
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2*Math.PI);
    ctx.strokeStyle = "#1f6f51";
    ctx.lineWidth = 3;
    ctx.stroke();

    // Ka'bah
    const rad = current*Math.PI/180;
    const xPos = centerX + radius * Math.cos(rad);
    const yPos = centerY + radius * Math.sin(rad);
    ctx.drawImage(kaabahImg, xPos-20, yPos-20, 40, 40);

    current += (angle - current)/10;
    requestAnimationFrame(animate);
  }
  animate();
}
</script>
</body>
</html>
