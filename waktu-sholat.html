<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waktu Sholat & Kiblat Real-Time</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body{
  font-family:'Poppins',sans-serif;
  background:#f4f7f6;
  display:flex;
  flex-direction:column;
  align-items:center;
  margin:0;
  padding:20px;
}
h1{color:#1f6f51; margin-bottom:10px;}
.card{
  background:white;
  border-radius:12px;
  padding:20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);
  max-width:400px;
  width:100%;
  margin-bottom:20px;
}
.time-row{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid #e0e0e0;
  font-size:16px;
  transition:0.3s;
}
.time-row:last-child{border:none;}
.time-now{background:#e0f2e9; font-weight:600; border-radius:6px; padding:2px 6px;}
#next-prayer{margin-top:10px; font-size:14px; color:#555; text-align:center;}
#compass-container{
  position:relative;
  width:250px; height:250px;
  border:3px solid #1f6f51;
  border-radius:50%;
  background:radial-gradient(circle,#eaf3ea 70%,#f4f7f6 100%);
  margin:20px;
}
#kaabah{
  position:absolute;
  width:40px; height:40px;
  top:50%; left:50%;
  transform-origin:0 -100px;
  transition: transform 0.5s linear;
}
#qibla-angle{
  margin-top:10px;
  color:#666;
  font-size:14px;
  text-align:center;
}
select{
  width:90%;
  max-width:300px;
  padding:8px;
  margin-bottom:12px;
}
</style>
</head>
<body>

<h1>Waktu Sholat</h1>
<div class="card">
  <select id="method-select">
    <option value="2">Muslim World League (MWL)</option>
    <option value="1">University of Islamic Sciences, Karachi</option>
    <option value="3">Egyptian General Authority</option>
    <option value="4">Umm Al-Qura, Makkah</option>
  </select>
  <div class="time-row"><span>Subuh</span><span id="subuh">--:--</span></div>
  <div class="time-row"><span>Dzuhur</span><span id="dzuhur">--:--</span></div>
  <div class="time-row"><span>Ashar</span><span id="ashar">--:--</span></div>
  <div class="time-row"><span>Maghrib</span><span id="maghrib">--:--</span></div>
  <div class="time-row"><span>Isya</span><span id="isya">--:--</span></div>
  <div id="next-prayer">Menghitung waktu sholat berikutnya...</div>
</div>

<h1>Arah Kiblat</h1>
<div id="compass-container">
  <img id="kaabah" src="https://upload.wikimedia.org/wikipedia/commons/6/6b/Kaaba_Masjid_al-Haram.svg" alt="Ka'bah">
</div>
<p id="qibla-angle">Menghitung arah kiblat...</p>

<audio id="adhan-audio" src="https://www.soundjay.com/misc/sounds/bell-ringing-01.mp3" preload="auto"></audio>

<script>
const prayerIds = {Fajr:'subuh', Dhuhr:'dzuhur', Asr:'ashar', Maghrib:'maghrib', Isha:'isya'};
let timings = {};
let currentMethod = 2;

document.getElementById('method-select').onchange=(e)=>{
  currentMethod=parseInt(e.target.value);
  if(window.lat && window.lon) updateSholat(window.lat,window.lon);
}

// Format waktu
function formatTime(time){return time.padStart(5,'0');}

// Update Kiblat
function updateQibla(lat, lon){
  const latRad = lat*Math.PI/180;
  const lonRad = lon*Math.PI/180;
  const kaabaLat = 21.4225*Math.PI/180;
  const kaabaLon = 39.8262*Math.PI/180;
  const y = Math.sin(kaabaLon-lonRad)*Math.cos(kaabaLat);
  const x = Math.cos(latRad)*Math.sin(kaabaLat)-Math.sin(latRad)*Math.cos(kaabaLat)*Math.cos(kaabaLon-lonRad);
  const brng = Math.atan2(y,x)*(180/Math.PI);
  const angle = (brng+360)%360;
  const kaabah = document.getElementById('kaabah');
  kaabah.style.transform = `rotate(${angle}deg) translateX(100px) rotate(${-angle}deg)`;
  document.getElementById('qibla-angle').innerText = `Arah kiblat: ${angle.toFixed(1)}Â°`;
}

// Update Waktu Sholat
function updateSholat(lat, lon){
  window.lat = lat; window.lon = lon;
  fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=${currentMethod}`)
  .then(r=>r.json())
  .then(d=>{
    timings=d.data.timings;
    for(const key in prayerIds){
      document.getElementById(prayerIds[key]).innerText=timings[key];
    }
  });
}

// Hitung waktu sholat berikutnya
function nextPrayerCountdown(){
  if(!timings.Fajr) return;
  const now = new Date();
  const prayers = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  let next=null;
  for(const p of prayers){
    const [h,m] = timings[p].split(':').map(Number);
    let prTime = new Date();
    prTime.setHours(h); prTime.setMinutes(m); prTime.setSeconds(0);
    if(prTime>now){ next=p; break; }
  }
  if(!next) next='Fajr'; // jika sudah lewat Isya, berikutnya subuh besok
  const [h,m] = timings[next].split(':').map(Number);
  let prTime = new Date();
  prTime.setHours(h); prTime.setMinutes(m); prTime.setSeconds(0);
  if(next==='Fajr' && now>prTime){ prTime.setDate(prTime.getDate()+1); }
  const diff = prTime-now;
  const hDiff = Math.floor(diff/1000/3600);
  const mDiff = Math.floor(diff/1000/60)%60;
  const sDiff = Math.floor(diff/1000)%60;
  document.getElementById('next-prayer').innerText=`Waktu ${next} tinggal ${hDiff}j ${mDiff}m ${sDiff}s`;
  // Cek adzan
  const el = document.getElementById(prayerIds[next]).parentNode;
  if(hDiff===0 && mDiff===0 && sDiff<60){
    el.classList.add('time-now');
    document.getElementById('adhan-audio').play();
  } else el.classList.remove('time-now');
}

// Ambil lokasi dan update
navigator.geolocation.getCurrentPosition(pos=>{
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  updateQibla(lat, lon);
  updateSholat(lat, lon);
  setInterval(()=>updateQibla(lat, lon),1000); // kiblat real-time
  setInterval(nextPrayerCountdown,1000);
}, err=>{
  alert('Gagal mendapatkan lokasi. Aktifkan GPS atau izinkan lokasi.');
});
</script>

</body>
</html>
