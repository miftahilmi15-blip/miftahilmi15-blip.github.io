<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SANTRI | Input Masal Rapor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1f6f51; --bg: #f0f7f4; --accent: #eab308; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #222; padding: 15px; }

        /* KONTROL TAMPILAN */
        #hal-input { display: block; max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 20px; }
        #hal-rapor-masal { display: none; background: #ddd; padding: 20px; }

        /* UI COMPONENTS */
        .header { text-align: center; margin-bottom: 20px; color: var(--primary); }
        .form-grup { margin-bottom: 15px; }
        label { font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; }
        select, input, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        
        /* TABEL INPUT MASAL */
        .tabel-masal { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        .tabel-masal th, .tabel-masal td { border: 1px solid #eee; padding: 8px; }
        .tabel-masal th { background: var(--primary); color: white; }
        .input-tabel { border: none; background: #f9f9f9; padding: 5px; width: 100%; }

        .btn-aksi { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
        .btn-biru { background: #2563eb; }
        .btn-hijau { background: var(--primary); }

        /* STYLE RAPOR (SESUAI SCREENSHOT) */
        .kertas { 
            background: white; width: 215mm; min-height: 330mm; margin: 20px auto; padding: 15mm 20mm; color: black;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); page-break-after: always;
        }
        .kop { display: flex; align-items: center; border-bottom: 1px solid #000; padding-bottom: 5px; }
        .kop img { width: 80px; margin-right: 15px; }
        .kop-text { text-align: center; flex: 1; line-height: 1.2; }
        .kop-text h2 { font-size: 14pt; color: var(--primary); }
        .kop-text .arab { font-size: 18pt; font-family: 'Times New Roman'; font-weight: bold; color: var(--primary); }
        .kop-text p { font-size: 8pt; }
        .garis-db { border-bottom: 3px solid #000; margin-top: 2px; margin-bottom: 15px; }
        .judul { text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 11pt; }
        .info-sw { display: flex; justify-content: space-between; font-size: 10pt; margin-bottom: 10px; }
        .tabel-n { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tabel-n th, .tabel-n td { border: 1px solid black; padding: 8px; font-size: 10pt; vertical-align: top; }
        .isi-h { height: 100px; white-space: pre-wrap; }
        .ftr { margin-top: 30px; display: flex; justify-content: space-between; font-size: 10pt; }
        .ttd { margin-top: 60px; font-weight: bold; text-decoration: underline; }

        @media print {
            body { background: white; padding: 0; }
            #hal-input, .no-print { display: none !important; }
            #hal-rapor-masal { display: block !important; background: white; padding: 0; }
            .kertas { box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>

<div id="hal-input">
    <div class="header"><h1>GASA BOS! INPUT MASAL 1 KELAS</h1></div>
    
    <div style="display: flex; gap: 10px;">
        <div class="form-grup" style="flex: 1;">
            <label>Pilih Kelas</label>
            <select id="pilih-kelas" onchange="ambilSiswa()">
                <option value="">-- Pilih --</option>
                <option value="7A">7A</option><option value="7B">7B</option>
                <option value="8A">8A</option><option value="8B">8B</option>
                <option value="9A">9A</option><option value="9B">9B</option>
            </select>
        </div>
        <div class="form-grup" style="flex: 1;"><label>Semester</label><select id="in-smstr"><option>Ganjil</option><option>Genap</option></select></div>
        <div class="form-grup" style="flex: 1;"><label>TP</label><input type="text" id="in-tp" value="2025/2026"></div>
    </div>

    <div id="loading" style="display:none; text-align:center;">‚è≥ Memuat data siswa...</div>

    <table class="tabel-masal" id="tabel-input-masal">
        <thead>
            <tr>
                <th>NAMA SANTRI</th>
                <th>CAPAIAN TAHSIN</th>
                <th>KET. TAHSIN</th>
                <th>CAPAIAN TAHFIZH</th>
                <th>KET. TAHFIZH</th>
            </tr>
        </thead>
        <tbody id="list-siswa">
            </tbody>
    </table>

    <button class="btn-aksi btn-hijau" onclick="simpanMasal()">üöÄ SIMPAN & TERBITKAN RAPOR KELAS</button>
</div>

<div id="hal-rapor-masal">
    <div class="no-print" style="position: fixed; top: 10px; right: 10px; z-index: 100;">
        <button onclick="window.location.reload()" style="padding:10px; background:red; color:white; border:none; border-radius:5px; cursor:pointer;">‚¨ÖÔ∏è Batal</button>
        <button onclick="window.print()" style="padding:10px; background:green; color:white; border:none; border-radius:5px; cursor:pointer;">üñ®Ô∏è Cetak Semua</button>
    </div>
    <div id="daftar-kertas-rapor"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2V6YylCXh8TkmToeNXpSX9uRiuHsQnBElBUUturdGlV1XbwrK5XFIZegOZjC-zo0/exec";
    const FIREBASE_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app/data_rapor";

    let daftarSiswa = [];

    async function ambilSiswa() {
        const kls = document.getElementById('pilih-kelas').value;
        if(!kls) return;
        document.getElementById('loading').style.display = 'block';
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getSantri&kelas=${kls}`);
            daftarSiswa = await res.json();
            
            let html = "";
            daftarSiswa.forEach((s, i) => {
                html += `
                <tr>
                    <td><b>${s.nama}</b><input type="hidden" class="m-nisn" value="${s.nisn || ''}"></td>
                    <td><input type="text" class="m-tahsin input-tabel" placeholder="..."></td>
                    <td><textarea class="m-ktahsin input-tabel" rows="2"></textarea></td>
                    <td><input type="text" class="m-tahfizh input-tabel" placeholder="..."></td>
                    <td><textarea class="m-ktahfizh input-tabel" rows="2"></textarea></td>
                </tr>`;
            });
            document.getElementById('list-siswa').innerHTML = html;
        } catch(e) { alert("Gagal ambil data!"); }
        document.getElementById('loading').style.display = 'none';
    }

    async function simpanMasal() {
        const kls = document.getElementById('pilih-kelas').value;
        const rows = document.querySelectorAll('#list-siswa tr');
        if(rows.length === 0) return alert("Belum ada data!");

        let raporHTML = "";
        
        for(let i=0; i < rows.length; i++) {
            const data = {
                nama: daftarSiswa[i].nama,
                nisn: rows[i].querySelector('.m-nisn').value,
                kelas: kls,
                semester: document.getElementById('in-smstr').value,
                tp: document.getElementById('in-tp').value,
                tahsin: rows[i].querySelector('.m-tahsin').value,
                k_tahsin: rows[i].querySelector('.m-ktahsin').value,
                tahfizh: rows[i].querySelector('.m-tahfizh').value,
                k_tahfizh: rows[i].querySelector('.m-ktahfizh').value
            };

            // Simpan ke Firebase (Async tapi gak usah ditunggu biar cepet)
            fetch(`${FIREBASE_URL}/${kls}/${data.nisn || data.nama}.json`, { 
                method: 'PUT', 
                body: JSON.stringify(data) 
            });

            // Generate HTML Rapor untuk tiap siswa
            raporHTML += buatTemplateRapor(data);
        }

        document.getElementById('daftar-kertas-rapor').innerHTML = raporHTML;
        document.getElementById('hal-input').style.display = 'none';
        document.getElementById('hal-rapor-masal').style.display = 'block';
    }

    function buatTemplateRapor(d) {
        return `
        <div class="kertas">
            <div class="kop">
                <img src="https://upload.wikimedia.org/wikipedia/id/1/10/Logo_Al-Irsyad_Al-Islamiyyah.png">
                <div class="kop-text">
                    <p>YAYASAN AL-IRSYAD AL-ISLAMIYYAH KOTA CIREBON</p>
                    <p class="arab">ÿßŸÑŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ÿ© ÿßŸÑÿ•ÿ±ÿ¥ÿßÿØ ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸäÿ©</p>
                    <h2>SMP AL-IRSYAD AL-ISLAMIYYAH KOTA CIREBON</h2>
                    <p>Jl. Panjunan No. 27 Cirebon | ‚òè (0231) 234191</p>
                </div>
            </div>
            <div class="garis-db"></div>
            <div class="judul">LAPORAN PERKEMBANGAN HASIL BELAJAR TAHSIN & TAHFIZH</div>
            <div class="info-sw">
                <div>Nama : <b>${d.nama}</b><br>NISN : ${d.nisn}</div>
                <div style="text-align:right">Kelas : <b>${d.kelas}</b><br>Semester : ${d.semester}</div>
            </div>
            <table class="tabel-n">
                <tr><th width="40">NO</th><th width="180">PENCAPAIAN</th><th>KETERANGAN</th></tr>
                <tr><td align="center">1</td><td><b>Tahsin</b><br>${d.tahsin}</td><td class="isi-h">${d.k_tahsin}</td></tr>
                <tr><td align="center">2</td><td><b>Tahfizh</b><br>${d.tahfizh}</td><td class="isi-h">${d.k_tahfizh}</td></tr>
            </table>
            <div class="ftr">
                <div>Mengetahui,<br>Kepala SMP Al-Irsyad<br><div class="ttd">Siti Hamidah, M.Pd</div></div>
                <div style="text-align:right">Cirebon, 22 Desember 2025<br>PJ. Al-Qur'an<br><div class="ttd">Ria Setiawati, A.Md</div></div>
            </div>
        </div>`;
    }
</script>
</body>
</html>
