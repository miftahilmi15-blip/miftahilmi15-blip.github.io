<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Exam Center | E-Santri Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --primary: #1f6f51; --accent: #eab308; --bg: #f0f2f5; --text: #2d3436; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); line-height: 1.6; user-select: none; }
        .header-top { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 100; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .welcome-card { background: linear-gradient(135deg, var(--primary), #2ecc71); padding: 30px 20px; border-radius: 24px; color: white; text-align: center; margin-bottom: 20px; }
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #e2e8f0; background: #f8fafc; font-size: 14px; outline: none; }
        .btn-start { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; }
        #timer { position: fixed; top: 75px; right: 10px; background: #1e293b; color: white; padding: 8px 15px; border-radius: 12px; font-weight: 800; z-index: 1000; }
        .soal-card { background: white; padding: 20px; border-radius: 18px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .option { display: block; padding: 12px 15px; background: #f8fafc; border: 2px solid #f1f5f9; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .option input { margin-right: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="header-top">
    <div style="font-weight:800; color:var(--primary)">EXAM CENTER</div>
    <div id="user-tag" style="font-size:10px; font-weight:bold">OFFLINE</div>
</div>

<div class="container">
    <div id="login-screen">
        <div class="welcome-card">
            <h2 id="info-mapel">Mengecek Ujian...</h2>
            <p>Silakan Masuk Menggunakan Token</p>
        </div>
        <div id="form-masuk" class="card hidden">
            <label>Pilih Kelas Kamu</label>
            <select id="user-kelas">
                <option>7A</option><option>7B</option><option>8A</option><option>8B</option>
                <option>9A</option><option>9B</option><option>9C</option><option>9D</option>
            </select>
            <label>Nama Lengkap</label>
            <input type="text" id="user-nama" placeholder="Nama Sesuai Absen">
            <label>Token Ujian</label>
            <input type="text" id="user-token" placeholder="PIN/Token dari Guru">
            <button class="btn-start" style="margin-top:20px" onclick="cekMasuk()">MULAI UJIAN</button>
        </div>
        <div id="pesan-off" class="card hidden" style="text-align:center; color:red">
            Belum ada ujian yang dibuka untuk kelas ini.
        </div>
    </div>

    <div id="exam-screen" class="hidden">
        <div id="timer">‚è≥ <span id="time-left">00:00</span></div>
        <div id="konten-soal"></div>
        <button class="btn-start" onclick="kirimJawaban()" style="background:#6c5ce7; margin-bottom:100px">SELESAI & KIRIM</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let sesiUjian = null;
    let listSoal = [];
    let intervalTimer;

    // 1. Monitor Jadwal dari Admin (Disesuaikan dengan jadwal_ujian/[kelas] di Admin)
    document.getElementById('user-kelas').onchange = function() {
        const kls = this.value;
        db.ref(`jadwal_ujian/${kls}`).on('value', snap => {
            sesiUjian = snap.val();
            if(sesiUjian && sesiUjian.status === "BUKA") {
                document.getElementById('info-mapel').innerText = "UJIAN: " + sesiUjian.mapel;
                document.getElementById('form-masuk').classList.remove('hidden');
                document.getElementById('pesan-off').classList.add('hidden');
            } else {
                document.getElementById('info-mapel').innerText = "OFFLINE";
                document.getElementById('form-masuk').classList.add('hidden');
                document.getElementById('pesan-off').classList.remove('hidden');
            }
        });
    };
    // Trigger awal
    document.getElementById('user-kelas').dispatchEvent(new Event('change'));

    // 2. Verifikasi & Ambil Soal (Path disesuaikan dengan bank_soal/[kelasLengkap]/[mapel])
    function cekMasuk() {
    const nama = document.getElementById('user-nama').value.trim();
    const kls = document.getElementById('user-kelas').value;

    // Sekarang cuma butuh Nama, tidak perlu Token lagi
    if(!nama) return alert("Masukkan Nama Lengkap dulu, Bos!");

    // Langsung ambil soal dari database
    db.ref(`bank_soal/${kls}/${sesiUjian.mapel}`).once('value', snap => {
        if(!snap.exists()) {
            return alert("Soal belum tersedia untuk kelas " + kls + " mata pelajaran " + sesiUjian.mapel);
        }
        
        listSoal = [];
        snap.forEach(s => { listSoal.push(s.val()); });
        
        // Mulai deh ujiannya
        mulaiUjian(nama, kls);
    });
}

    function mulaiUjian(nama, kls) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('exam-screen').classList.remove('hidden');
        document.getElementById('user-tag').innerText = nama + " | " + kls;

        const container = document.getElementById('konten-soal');
        container.innerHTML = "";

        listSoal.forEach((s, i) => {
            let htmlOpsi = "";
            if(s.opsi) {
                const opsi = s.opsi.split(',');
                const huruf = ['A','B','C','D'];
                opsi.forEach((teks, idx) => {
                    htmlOpsi += `<label class="option"><input type="radio" name="q${i}" value="${huruf[idx]}"> <b>${huruf[idx]}.</b> ${teks.trim()}</label>`;
                });
            } else {
                htmlOpsi = `<textarea id="essay${i}" placeholder="Tulis jawaban..."></textarea>`;
            }

            container.innerHTML += `
                <div class="soal-card">
                    <p style="font-weight:800">Soal ${i+1}</p>
                    <p style="margin:10px 0">${s.soal}</p>
                    ${htmlOpsi}
                </div>`;
        });

        let detik = (sesiUjian.durasi || 60) * 60;
        intervalTimer = setInterval(() => {
            let m = Math.floor(detik/60); let s = detik%60;
            document.getElementById('time-left').innerText = `${m}:${s<10?'0'+s:s}`;
            if(detik <= 0) { clearInterval(intervalTimer); kirimJawaban(true); }
            detik--;
        }, 1000);
    }

    function kirimJawaban(auto = false) {
        if(!auto && !confirm("Kirim jawaban sekarang?")) return;
        clearInterval(intervalTimer);

        let benar = 0;
        let totalPG = 0;
        listSoal.forEach((s, i) => {
            if(s.opsi) {
                totalPG++;
                const pil = document.querySelector(`input[name="q${i}"]:checked`);
                if(pil && pil.value === s.kunci) benar++;
            }
        });

        const skor = totalPG > 0 ? Math.round((benar/totalPG)*100) : 0;
        const kls = document.getElementById('user-kelas').value;
        const nama = document.getElementById('user-nama').value;

        // Simpan ke path nilai_ujian/[kelas]/[mapel] sesuai kode Rekap Admin
        db.ref(`nilai_ujian/${kls}/${sesiUjian.mapel}`).push({
            nama: nama,
            skor: skor,
            waktu: new Date().toLocaleString()
        }).then(() => {
            alert("Berhasil! Skor kamu: " + skor);
            location.reload();
        });
    }
</script>
</body>
</html>
