<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistem Laporan Karakter MTs As Sunnah</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #10b981; --bg: #f1f5f9; --text: #1e293b; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; color: var(--text); }

        .no-print { 
            max-width: 1000px; margin: 0 auto 20px auto; 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
        }
        .controls { display: grid; grid-template-columns: 1fr 1fr auto auto auto; gap: 10px; align-items: end; }
        label { font-size: 11px; font-weight: 700; color: #64748b; }
        select, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; outline: none; }
        button { background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer; }
        .btn-excel { background: #16a34a; }
        .btn-print { background: #475569; }

        /* Kertas Laporan */
        .kertas-laporan { 
            background: white; width: 210mm; min-height: 297mm; 
            margin: auto; padding: 15mm 20mm; box-shadow: 0 0 20px rgba(0,0,0,0.1); 
        }

        .header-lp { text-align: center; border-bottom: 2px solid #1e293b; padding-bottom: 10px; margin-bottom: 20px; }
        .header-lp h2 { margin: 0; font-size: 16px; text-transform: uppercase; }
        
        .info-santri { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; margin-bottom: 20px; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        
        .section-title { background: #f8fafc; padding: 5px 10px; font-weight: 800; font-size: 13px; margin: 15px 0 8px 0; border-left: 4px solid var(--primary); }
        
        .isi-narasi { font-size: 12px; line-height: 1.5; text-align: justify; }
        .aspek-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .box-aspek { border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .judul-aspek { font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; }
        .skor-badge { font-size: 10px; color: #64748b; }

        .footer-ttd { margin-top: 30px; display: flex; justify-content: flex-end; }
        .ttd-box { text-align: center; width: 200px; font-size: 12px; }

        /* Style Tabel Rekap */
        #area-rekap { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f4f7f6; }

        @media print {
            body { background: white; padding: 0; }
            .no-print, #area-rekap { display: none; }
            .kertas-laporan { box-shadow: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="controls">
        <div><label>KELAS</label><br><select id="pilih-kls" onchange="muatDaftarNama()"><option value="">-- Pilih --</option><option>9A</option><option>9B</option><option>8A</option><option>7A</option></select></div>
        <div><label>SANTRI</label><br><select id="pilih-nama"><option value="">Pilih Kelas Dulu</option></select></div>
        <button onclick="generateLaporan()">üìÑ LIHAT PDF</button>
        <button class="btn-excel" onclick="exportExcel()">üìä EXCEL REKAP</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è PRINT</button>
    </div>
</div>

<div id="konten-laporan" class="kertas-laporan">
    <p style="text-align:center; color:#ccc; margin-top:100px;">Data akan muncul di sini...</p>
</div>

<div id="area-rekap" class="no-print">
    <h3 style="font-size: 14px;">Preview Rekap Kelas (Untuk Excel)</h3>
    <table id="tabel-rekap">
        <thead>
            <tr>
                <th>Nama Santri</th>
                <th>Perkataan</th><th>Berpakaian</th><th>Akhlak</th><th>Disiplin</th>
                <th>Jujur</th><th>Tjwb</th><th>Ibadah</th><th>Peduli</th>
                <th>Rata-rata</th>
            </tr>
        </thead>
        <tbody id="body-rekap"></tbody>
    </table>
</div>

<script>
const DB_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app";
const aspekList = ["Perkataan", "Berpakaian", "Akhlak", "Disiplin", "Jujur", "Tanggung Jawab", "Ibadah", "Peduli"];

async function muatDaftarNama() {
    const kls = document.getElementById('pilih-kls').value;
    const res = await fetch(`${DB_URL}/observasi/${kls}.json`);
    const data = await res.json() || {};
    let listNama = new Set();
    Object.keys(data).forEach(tgl => Object.keys(data[tgl]).forEach(n => listNama.add(n)));
    
    const select = document.getElementById('pilih-nama');
    select.innerHTML = '<option value="">-- Pilih Santri --</option>';
    Array.from(listNama).sort().forEach(n => select.innerHTML += `<option>${n}</option>`);
    
    updateTabelRekap(data);
}

function updateTabelRekap(data) {
    const body = document.getElementById('body-rekap');
    body.innerHTML = "";
    
    // Logic menghitung rata-rata per anak untuk rekap
    let rekapAnak = {};
    Object.keys(data).forEach(tgl => {
        Object.keys(data[tgl]).forEach(nama => {
            if(!rekapAnak[nama]) rekapAnak[nama] = { total: 0, count: 0, aspek: {} };
            const entry = Object.values(data[tgl][nama])[0]; // Ambil salah satu penilai
            if(entry && entry.skor) {
                aspekList.forEach(a => {
                    let v = parseInt(entry.skor[a] || 3);
                    rekapAnak[nama].aspek[a] = v;
                });
            }
        });
    });

    Object.keys(rekapAnak).sort().forEach(nama => {
        let tr = `<tr><td>${nama}</td>`;
        let sum = 0;
        aspekList.forEach(a => {
            let n = rekapAnak[nama].aspek[a] || 0;
            tr += `<td>${n}</td>`;
            sum += n;
        });
        tr += `<td>${(sum/8).toFixed(1)}</td></tr>`;
        body.innerHTML += tr;
    });
}

async function generateLaporan() {
    const kls = document.getElementById('pilih-kls').value;
    const nama = document.getElementById('pilih-nama').value;
    if(!nama) return alert("Pilih Nama!");

    const res = await fetch(`${DB_URL}/observasi/${kls}.json`);
    const data = await res.json() || {};
    
    // Ambil data terbaru (tanggal terakhir)
    const tanggalSemua = Object.keys(data).sort().reverse();
    const dataAnak = data[tanggalSemua[0]][nama];
    // Ambil skor dari penilai pertama (misal: Guru)
    const penilaiKey = Object.keys(dataAnak)[0];
    const skor = dataAnak[penilaiKey].skor;

    let html = `
        <div class="header-lp">
            <h2>LAPORAN PERKEMBANGAN KARAKTER SANTRI</h2>
            <p style="font-size:12px; margin:2px;">MTs As Sunnah Kota Cirebon | Ganjil 2025/2026</p>
        </div>

        <div class="info-santri">
            <div><b>Nama:</b> ${nama}</div>
            <div><b>Kelas:</b> ${kls}</div>
            <div><b>Wali Kelas:</b> Fahrijal Umar, S.Pd.I., Gr.</div>
            <div><b>Tanggal:</b> ${tanggalSemua[0]}</div>
        </div>

        <div class="isi-narasi">
            <div class="section-title">üåü Pendahuluan</div>
            <p>Laporan ini merupakan hasil observasi perilaku harian. Tujuan laporan ini adalah memberikan gambaran menyeluruh mengenai perkembangan karakter Ananda.</p>

            <div class="section-title">‚úÖ Kekuatan & Aspek Karakter</div>
            <div class="aspek-grid">
    `;

    // LOOPING SEMUA ASPEK AGAR MASUK SEMUA
    aspekList.forEach(a => {
        let n = parseInt(skor[a] || 3);
        let ket = n >= 4 ? "Sangat Baik" : (n >= 3 ? "Baik" : "Cukup");
        html += `
            <div class="box-aspek">
                <div class="judul-aspek"><span>${a}</span> <span class="skor-badge">Status: ${ket}</span></div>
                <p style="margin:2px 0;">Ananda menunjukkan kualitas ${a.toLowerCase()} yang ${ket.toLowerCase()} dalam interaksi harian di sekolah.</p>
            </div>
        `;
    });

    html += `
            </div>
            <div class="section-title">ü§ù Tindak Lanjut</div>
            <p>Diharapkan orang tua tetap memberikan penguatan positif di rumah agar konsistensi karakter Ananda tetap terjaga.</p>
        </div>

        <div class="footer-ttd">
            <div class="ttd-box">
                Cirebon, ${new Date().toLocaleDateString('id-ID')}<br>
                Wali Kelas,<br><br><br><br>
                <b>Fahrijal Umar, S.Pd.I., Gr.</b>
            </div>
        </div>
    `;

    document.getElementById('konten-laporan').innerHTML = html;
}

function exportExcel() {
    const kls = document.getElementById('pilih-kls').value;
    if(!kls) return alert("Pilih Kelas!");
    const table = document.getElementById("tabel-rekap");
    const wb = XLSX.utils.table_to_book(table);
    XLSX.writeFile(wb, `Rekap_Karakter_${kls}.xlsx`);
}
</script>
</body>
</html>
