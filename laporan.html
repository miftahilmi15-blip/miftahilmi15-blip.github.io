<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>E-SANTRI | Generator Laporan Narasi</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #10b981; --bg: #f1f5f9; --text: #1e293b; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; color: var(--text); }

        .no-print { 
            max-width: 1000px; margin: 0 auto 20px auto; 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
        }
        .controls { display: grid; grid-template-columns: 1fr 1fr auto auto auto; gap: 10px; align-items: end; }
        label { font-size: 11px; font-weight: 700; color: #64748b; }
        select, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; outline: none; }
        button { background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-excel { background: #16a34a; }
        .btn-print { background: #475569; }

        /* KERTAS LAPORAN (MIRIP DOCX) */
        .kertas-laporan { 
            background: white; width: 210mm; min-height: 297mm; 
            margin: auto; padding: 20mm 25mm; box-shadow: 0 0 20px rgba(0,0,0,0.1); 
        }

        .header-lp { text-align: center; border-bottom: 2px solid #1e293b; padding-bottom: 10px; margin-bottom: 20px; }
        .header-lp h2 { margin: 0; font-size: 16px; text-transform: uppercase; }
        
        .info-santri { font-size: 13px; margin-bottom: 25px; line-height: 1.6; }
        
        .section-title { font-weight: 800; font-size: 14px; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 10px; }
        .isi-narasi { font-size: 13px; line-height: 1.7; text-align: justify; }
        
        .box-aspek { margin-bottom: 15px; }
        .judul-aspek { font-weight: 700; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 2px; }
        .label-skor { font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; }

        .footer-ttd { margin-top: 50px; display: flex; justify-content: flex-end; }
        .ttd-box { text-align: center; width: 250px; font-size: 13px; border-top: 1px solid transparent; }

        /* TABEL REKAP EXCEL */
        #area-rekap { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f8fafc; }

        @media print {
            body { background: white; padding: 0; }
            .no-print, #area-rekap { display: none; }
            .kertas-laporan { box-shadow: none; margin: 0; width: 100%; padding: 15mm; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="controls">
        <div><label>KELAS</label><br><select id="pilih-kls" onchange="muatDaftarSantri()"><option value="">-- Pilih --</option><option>9A</option><option>8A</option><option>7A</option></select></div>
        <div><label>NAMA SANTRI</label><br><select id="pilih-nama"><option value="">Pilih Kelas Dulu</option></select></div>
        <button onclick="generateLaporan()">üìÑ GENERATE PDF</button>
        <button class="btn-excel" onclick="exportExcel()">üìä REKAP EXCEL</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è PRINT</button>
    </div>
</div>

<div id="konten-laporan" class="kertas-laporan">
    <p style="text-align:center; color:#ccc; margin-top:150px;">Silakan pilih Santri dan klik "Generate PDF"</p>
</div>

<div id="area-rekap" class="no-print">
    <h3 style="font-size: 14px;">Preview Rekap Nilai Kelas</h3>
    <table id="tabel-rekap">
        <thead>
            <tr>
                <th>Nama Santri</th>
                <th>Perkataan</th><th>Berpakaian</th><th>Akhlak</th><th>Disiplin</th>
                <th>Jujur</th><th>Tanggung Jawab</th><th>Ibadah</th><th>Peduli</th>
                <th>Rata-rata</th>
            </tr>
        </thead>
        <tbody id="body-rekap"></tbody>
    </table>
</div>

<script>
const DB_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app";
const aspekList = ["Perkataan", "Berpakaian", "Akhlak", "Disiplin", "Jujur", "Tanggung Jawab", "Ibadah", "Peduli"];

// FUNGSI MUAT NAMA SANTRI
async function muatDaftarSantri() {
    const kls = document.getElementById('pilih-kls').value;
    const res = await fetch(`${DB_URL}/observasi/${kls}.json`);
    const data = await res.json() || {};
    let listNama = new Set();
    Object.keys(data).forEach(tgl => Object.keys(data[tgl]).forEach(n => listNama.add(n)));
    
    const select = document.getElementById('pilih-nama');
    select.innerHTML = '<option value="">-- Pilih Santri --</option>';
    Array.from(listNama).sort().forEach(n => select.innerHTML += `<option>${n}</option>`);
    
    renderTableRekap(data);
}

// FUNGSI GENERATE LAPORAN (Sesuai Template Docx)
async function generateLaporan() {
    const kls = document.getElementById('pilih-kls').value;
    const nama = document.getElementById('pilih-nama').value;
    if(!nama) return alert("Pilih Santri!");

    const res = await fetch(`${DB_URL}/observasi/${kls}.json`);
    const data = await res.json() || {};
    const tglTerakhir = Object.keys(data).sort().reverse()[0];
    const dataAnak = data[tglTerakhir][nama];
    
    // Asumsi: Kita ambil satu sampel penilaian (misal dari Wali Kelas/Guru)
    const penilaiKey = Object.keys(dataAnak)[0];
    const skor = dataAnak[penilaiKey].skor;

    const getKet = (val) => val >= 4 ? "Sangat Baik" : (val >= 3 ? "Baik" : (val >= 2 ? "Cukup" : "Kurang"));

    let html = `
        <div class="header-lp">
            <h2>üìù Laporan Perkembangan Karakter Santri</h2>
            <p style="font-size:12px; margin:2px;">MTs As Sunnah Kota Cirebon | Semester Ganjil 2025/2026</p>
        </div>

        <div class="info-santri">
            <b>Nama Santri:</b> ${nama}<br>
            <b>Kelas:</b> ${kls}<br>
            <b>Wali Kelas:</b> Fahrijal Umar, S.Pd.I., Gr.
        </div>

        <div class="isi-narasi">
            <div class="section-title">üåü Pendahuluan</div>
            <p>Yth. Bapak/Ibu Wali Santri, Terima kasih atas kepercayaan Bapak/Ibu dalam mendampingi pendidikan karakter Ananda. Laporan ini disusun berdasarkan observasi untuk memberikan gambaran menyeluruh mengenai perkembangan karakter, kekuatan, serta area yang memerlukan pendampingan.</p>

            <div class="section-title">üìà Rangkuman Hasil Observasi</div>
            <p>Secara keseluruhan, Ananda menunjukkan perkembangan yang cukup baik dan stabil. Terlihat bahwa Ananda memiliki potensi karakter yang kuat disertai kesadaran diri yang baik‚Äîterutama pada aspek yang menurutnya perlu diperbaiki.</p>

            <div class="section-title">‚úÖ Kekuatan Utama</div>
            <p>(Berdasarkan penilaian harian di sekolah):</p>
            <div class="box-aspek">
                <div class="judul-aspek">Perkataan ‚Äì ${getKet(skor.Perkataan)}</div>
                <p>Ananda mampu menjaga ucapan dan berkomunikasi dengan baik di lingkungan sekolah.</p>
            </div>
            <div class="box-aspek">
                <div class="judul-aspek">Berpakaian ‚Äì ${getKet(skor.Berpakaian)}</div>
                <p>Penampilan Ananda dinilai rapi dan mampu mematuhi aturan kerapian pada banyak kesempatan.</p>
            </div>

            <div class="section-title">üí° Area Perhatian Khusus</div>
    `;

    // Looping Aspek Sisanya (Akhlak, Jujur, dll)
    const sisaAspek = ["Akhlak", "Jujur", "Tanggung Jawab", "Peduli", "Ibadah", "Disiplin"];
    sisaAspek.forEach((asp, index) => {
        let val = parseInt(skor[asp] || 3);
        html += `
            <div class="box-aspek">
                <div class="judul-aspek">${index + 1}. ${asp}</div>
                <span class="label-skor">Status: ${getKet(val)}</span>
                <p>Diperlukan konsistensi lebih lanjut dalam aspek ${asp.toLowerCase()} agar selaras dengan harapan sekolah dan lingkungan.</p>
            </div>
        `;
    });

    html += `
            <div class="section-title">ü§ù Tindak Lanjut & Sinergi</div>
            <p><b>Dukungan Rumah:</b> Mohon Bapak/Ibu membiasakan Ananda menjaga disiplin harian dan ibadah wajib. Komunikasi terbuka akan membantu Ananda merasa lebih percaya diri dalam berproses.</p>
        </div>

        <div class="footer-ttd">
            <div class="ttd-box">
                Cirebon, ${new Date().toLocaleDateString('id-ID')}<br>
                Wali Kelas,<br><br><br><br>
                <b>Fahrijal Umar, S.Pd.I., Gr.</b>
            </div>
        </div>
    `;

    document.getElementById('konten-laporan').innerHTML = html;
}

// RENDER TABEL UNTUK EXCEL
function renderTableRekap(data) {
    const body = document.getElementById('body-rekap');
    body.innerHTML = "";
    let dataMap = {};

    Object.keys(data).forEach(tgl => {
        Object.keys(data[tgl]).forEach(nama => {
            if(!dataMap[nama]) dataMap[nama] = { total: 0, count: 0, s: {} };
            const entry = Object.values(data[tgl][nama])[0];
            if(entry && entry.skor) {
                aspekList.forEach(a => { dataMap[nama].s[a] = entry.skor[a] || 0; });
            }
        });
    });

    Object.keys(dataMap).sort().forEach(nama => {
        let tr = `<tr><td>${nama}</td>`;
        let sum = 0;
        aspekList.forEach(a => {
            let n = parseInt(dataMap[nama].s[a] || 0);
            tr += `<td>${n}</td>`;
            sum += n;
        });
        tr += `<td>${(sum/8).toFixed(1)}</td></tr>`;
        body.innerHTML += tr;
    });
}

function exportExcel() {
    const kls = document.getElementById('pilih-kls').value;
    if(!kls) return alert("Pilih Kelas!");
    const table = document.getElementById("tabel-rekap");
    const wb = XLSX.utils.table_to_book(table);
    XLSX.writeFile(wb, `Rekap_Karakter_${kls}.xlsx`);
}
</script>
</body>
</html>
