<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistem Laporan Karakter Pro - MTs As Sunnah</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #059669; --bg: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; color: #1e293b; }

        .no-print { background: white; padding: 20px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-tab { display: flex; gap: 10px; max-width: 1200px; margin: 0 auto 15px auto; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; background: #e2e8f0; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: white; }
        .controls { display: flex; gap: 15px; align-items: flex-end; max-width: 1200px; margin: auto; flex-wrap: wrap; }
        
        select, button { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 13px; }
        .btn-proses { background: var(--accent); color: white; border: none; font-weight: 700; cursor: pointer; }
        .btn-excel { background: #16a34a; color: white; border: none; font-weight: 700; cursor: pointer; }

        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        .wrap-table { background: white; padding: 20px; border-radius: 12px; max-width: 1300px; margin: auto; overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1100px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        th { background: #f1f5f9; position: sticky; top: 0; }
        .name-col { text-align: left; font-weight: 700; min-width: 180px; position: sticky; left: 0; background: white; z-index: 10; }
        
        .cell-main { font-size: 14px; font-weight: 800; display: block; }
        .cell-sub { font-size: 9px; color: #64748b; white-space: nowrap; display: block; margin-top: 2px; }
        .badge-diri { font-size: 9px; background: #e0f2fe; color: #0369a1; padding: 1px 4px; border-radius: 4px; display: inline-block; margin-top: 3px; font-weight: 700; }

        .kertas-laporan { background: white; width: 210mm; min-height: 297mm; margin: 0 auto 30px auto; padding: 20mm 15mm; box-shadow: 0 4px 20px rgba(0,0,0,0.1); page-break-after: always; color: #000; }
        .header-lp { border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        .section-header { font-weight: 800; font-size: 14px; margin-top: 20px; border-bottom: 1px solid #000; padding-bottom: 3px; }
        .box-aspek { margin-bottom: 15px; padding-left: 10px; border-left: 2px solid #eee; }

        .footer-ttd { margin-top: 40px; display: flex; justify-content: space-between; }
        .ttd-box { text-align: center; width: 250px; font-size: 13px; line-height: 1.5; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .kertas-laporan { margin: 0; box-shadow: none; width: 100%; padding: 10mm; }
            .tab-content { display: none; }
            #tab-rapor { display: block !important; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="nav-tab">
        <button class="tab-btn active" onclick="switchTab('rapor')">üìÑ MODE RAPOR PDF</button>
        <button class="tab-btn" onclick="switchTab('rekap')">üìä MODE REKAP EXCEL</button>
    </div>
    <div class="controls">
        <select id="pilih-kls" onchange="muatData()">
            <option value="">-- Pilih Kelas --</option>
            <option>7A</option><option>7B</option><option>7C</option><option>7D</option>
            <option>8A</option><option>8B</option><option>8C</option><option>8D</option>
            <option>9A</option><option>9B</option><option>9C</option><option>9D</option>
        </select>
        <select id="pilih-nama" style="width:250px">
            <option value="ALL">Cetak Semua (Satu Kelas)</option>
        </select>
        <button class="btn-proses" onclick="prosesData()">PROSES DATA</button>
        <button class="btn-excel" onclick="exportExcel()">SIMPAN KE EXCEL</button>
        <button onclick="window.print()">üñ®Ô∏è PRINT PDF</button>
    </div>
</div>

<div id="tab-rapor" class="tab-content active">
    <div id="container-rapor">
        <p style="text-align:center; color:#94a3b8; margin-top:50px;">Silakan pilih kelas dan klik "Proses Data" Bos.</p>
    </div>
</div>

<div id="tab-rekap" class="tab-content">
    <div class="wrap-table">
        <table id="tabel-rekap-master">
            <thead>
                <tr id="head-rekap">
                    <th class="name-col">Nama Santri</th>
                </tr>
            </thead>
            <tbody id="body-rekap"></tbody>
        </table>
    </div>
</div>

<script>
const DB_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app";
const aspekList = ["Perkataan", "Berpakaian", "Akhlak", "Disiplin", "Jujur", "Tanggung Jawab", "Ibadah", "Peduli"];
let globalRaw = {};

function switchTab(t) {
    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector(`button[onclick*="${t}"]`).classList.add('active');
    document.getElementById(`tab-${t}`).classList.add('active');
}

async function muatData() {
    const kls = document.getElementById('pilih-kls').value;
    if(!kls) return;
    const res = await fetch(`${DB_URL}/observasi/${kls}.json`);
    globalRaw = await res.json() || {};
    let namaUnik = new Set();
    Object.values(globalRaw).forEach(t => Object.keys(t).forEach(n => namaUnik.add(n)));
    const sel = document.getElementById('pilih-nama');
    sel.innerHTML = '<option value="ALL">Cetak Seluruh Kelas</option>';
    Array.from(namaUnik).sort().forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
}

function hitungAgregasi(nama) {
    let res = {};
    aspekList.forEach(a => res[a] = { c: {4:0, 3:0, 2:0, 1:0}, diri: 3 });
    Object.values(globalRaw).forEach(tgl => {
        if(tgl[nama]) {
            Object.entries(tgl[nama]).forEach(([penilai, konten]) => {
                aspekList.forEach(a => {
                    let v = parseInt(konten.skor[a] || 3);
                    if(penilai === nama || konten.tipe === 'Diri') res[a].diri = v;
                    else if(v >= 1) res[a].c[v]++;
                });
            });
        }
    });
    aspekList.forEach(a => {
        let max = -1, mode = 3;
        for(let i=1; i<=4; i++) { if(res[a].c[i] >= max) { max = res[a].c[i]; mode = i; } }
        res[a].modus = mode;
    });
    return res;
}

function prosesData() {
    const kls = document.getElementById('pilih-kls').value;
    const target = document.getElementById('pilih-nama').value;
    const container = document.getElementById('container-rapor');
    const bodyRekap = document.getElementById('body-rekap');
    const headRekap = document.getElementById('head-rekap');

    container.innerHTML = ""; bodyRekap.innerHTML = "";
    headRekap.innerHTML = '<th class="name-col">Nama Santri</th>' + aspekList.map(a => `<th>${a}</th>`).join('') + '<th>Rata</th>';

    let daftar = (target === "ALL") ? Array.from(document.querySelectorAll("#pilih-nama option")).map(o => o.value).filter(v => v !== "ALL") : [target];

    daftar.sort().forEach(nama => {
        const aggr = hitungAgregasi(nama);
        const namaPanggilan = nama.split(' ')[0];
        
        let rowHtml = `<td class="name-col">${nama}</td>`;
        let sumModus = 0;
        aspekList.forEach(a => {
            const d = aggr[a]; sumModus += d.modus;
            let color = d.modus >= 4 ? '#059669' : (d.modus >= 3 ? '#2563eb' : '#d97706');
            rowHtml += `<td><span class="cell-main" style="color:${color}">${d.modus}</span><span class="cell-sub">SB:${d.c[4]} B:${d.c[3]} C:${d.c[2]} K:${d.c[1]}</span><span class="badge-diri">Diri: ${d.diri}</span></td>`;
        });
        rowHtml += `<td style="background:#f8fafc; font-weight:800;">${(sumModus/8).toFixed(1)}</td>`;
        bodyRekap.innerHTML += `<tr>${rowHtml}</tr>`;

        let htmlKekuatan = "", htmlPerhatian = "", listKekuatan = [], listPerhatian = [];
        aspekList.forEach(a => {
            const d = aggr[a];
            const ket = (v) => v >= 4 ? "Sangat Baik" : (v >= 3 ? "Baik" : (v >= 2 ? "Cukup" : "Kurang"));
            let narasi = `Mayoritas teman menilai aspek ${a.toLowerCase()} Ananda berada pada level ${ket(d.modus).toLowerCase()}. `;
            narasi += d.diri < d.modus ? "Ananda cenderung rendah hati dalam menilai diri sendiri." : (d.diri > d.modus ? "Ananda memiliki percaya diri yang kuat namun perlu penyesuaian." : "Penilaian diri Ananda sudah selaras dengan pengamatan sosial.");
            
            let item = `
                <div class="box-aspek">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 3px; margin-bottom: 5px;">
                        <b>${a} ‚Äì ${ket(d.modus)}</b>
                        <span style="font-size: 10px; color: #64748b;">Statistik: SB:${d.c[4]} B:${d.c[3]} C:${d.c[2]} K:${d.c[1]}</span>
                    </div>
                    <span style="font-size:12px; text-align:justify; display:block;">
                        ${narasi} <small>(Diri: ${ket(d.diri)})</small>
                    </span>
                </div>`;

            if(d.modus >= 3) { htmlKekuatan += item; listKekuatan.push(a.toLowerCase()); }
            else { htmlPerhatian += item; listPerhatian.push(a.toLowerCase()); }
        });

        // RENDER PDF TEMPLATE KE CONTAINER
        container.innerHTML += `
            <div class="kertas-laporan">
                <div class="header-lp" style="display: flex; align-items: center; border-bottom: 4px double #000; padding-bottom: 10px; margin-bottom: 20px;">
                    <div style="flex: 0 0 80px;">
                        <img src="cop.png" style="width: 75px; height: auto;" alt="Logo">
                    </div>
                    <div style="flex: 1; text-align: center; padding-right: 80px;">
                        <h4 style="margin: 0; font-size: 13px; text-transform: uppercase; font-weight: 500;">Yayasan As Sunnah Cirebon</h4>
                        <h2 style="margin: 0; font-size: 19px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px;">MTs AS SUNNAH KOTA CIREBON</h2>
                        <p style="margin: 2px 0 0 0; font-size: 10px; font-style: italic; line-height: 1.2;">
                            Jl. Kalitanjung No. 52 Kel. Karyamulya Kec. Kesambi Kota Cirebon 45131<br>
                            Email: mtsassunnahcrb@gmail.com | Website: www.assunnah.sch.id
                        </p>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; text-decoration: underline; font-size: 16px; text-transform: uppercase;">LAPORAN PERKEMBANGAN KARAKTER SANTRI</h3>
                    <p style="font-size: 12px; margin: 3px 0; font-weight: bold;">Semester Ganjil ‚Äì Tahun Pelajaran 2025/2026</p>
                </div>
                
                <div style="margin-bottom:15px; border:1px solid #000; padding:10px; line-height:1.6; background: #fff;">
                    <div style="font-size:13px;"><b>Nama Santri :</b> ${nama}</div>
                    <div style="font-size:13px;"><b>Kelas        :</b> ${kls}</div>
                    <div style="font-size:13px;"><b>Wali Kelas   :</b> Fahrijal Umar, S.Pd.I., Gr.</div>
                </div>

                <div class="section-header">üåü PENDAHULUAN</div>
                <p style="font-size:12px; text-align:justify;">Yth. Bapak/Ibu Wali Santri, Terima kasih atas kepercayaan Bapak/Ibu dalam mendampingi pendidikan karakter Ananda <b>${nama}</b>. Laporan ini disusun berdasarkan observasi teman sebaya dan penilaian diri guna memberikan gambaran objektif bagi perkembangan Ananda.</p>

                <div class="section-header">üìà RANGKUMAN HASIL OBSERVASI</div>
                <p style="font-size:12px; text-align:justify;">Secara keseluruhan, Ananda <b>${namaPanggilan}</b> menunjukkan perkembangan yang stabil. Ananda memiliki potensi karakter yang kuat disertai kesadaran diri yang baik‚Äîterutama pada aspek yang menurutnya perlu diperbaiki.</p>
                
                <div class="section-header">‚úÖ KEKUATAN UTAMA</div> 
                ${htmlKekuatan || '<p style="font-size:12px; font-style:italic;">Belum ada aspek yang menonjol.</p>'}
                
                <div class="section-header">üí° AREA PERHATIAN KHUSUS</div> 
                ${htmlPerhatian || '<p style="font-size:12px; font-style:italic;">Seluruh aspek menunjukkan tren positif.</p>'}
                
                <div class="section-header">ü§ù TINDAK LANJUT</div>
                <div style="font-size:12px; line-height:1.4;">
                    <p><b>1. Pujian:</b> Apresiasi atas aspek ${listKekuatan.join(', ')}.</p>
                    <p><b>2. Wali Kelas:</b> Pembinaan pada aspek ${listPerhatian.length > 0 ? listPerhatian.join(', ') : 'sosial'}.</p>
                    <p><b>3. Orang Tua:</b> Mohon dukungan komunikasi terbuka di rumah.</p>
                </div>

                <div class="footer-ttd">
                    <div class="ttd-box">
                        Mengetahui,<br>
                        Kepala Madrasah<br><br><br><br><br>
                        <b>Abdullah Banawi, Lc.</b>
                    </div>
                    <div class="ttd-box">
                        Cirebon, 02 Februari 2026<br>
                        Wali Kelas,<br><br><br><br><br>
                        <b>Fahrijal Umar, S.Pd.I., Gr.</b>
                    </div>
                </div>
            </div>`;
    }); 
} 

function exportExcel() {
    let dataExcel = [];
    let rows = document.querySelectorAll("#body-rekap tr");
    rows.forEach(tr => {
        let cells = tr.querySelectorAll("td");
        let item = { "Nama Santri": cells[0].innerText };
        aspekList.forEach((a, idx) => {
            let detail = cells[idx+1].querySelector(".cell-sub").innerText;
            let modus = cells[idx+1].querySelector(".cell-main").innerText;
            let diri = cells[idx+1].querySelector(".badge-diri").innerText;
            item[a] = `${modus} (${detail} | ${diri})`;
        });
        item["Rata-Rata"] = cells[cells.length-1].innerText;
        dataExcel.push(item);
    });
    const ws = XLSX.utils.json_to_sheet(dataExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Rekap Karakter");
    XLSX.writeFile(wb, `Rekap_Karakter_${document.getElementById('pilih-kls').value}.xlsx`);
}
</script>
</body>
</html>
