<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laporan Karakter Full Template - MTs As Sunnah</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #059669; --bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; color: #1e293b; line-height: 1.6; }

        /* UI Controls */
        .no-print { background: white; padding: 20px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-tab { display: flex; gap: 10px; max-width: 1000px; margin: 0 auto 15px auto; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; background: #e2e8f0; }
        .tab-btn.active { background: var(--accent); color: white; }
        .controls { display: flex; gap: 15px; align-items: flex-end; max-width: 1000px; margin: auto; flex-wrap: wrap; }
        
        /* Layout Kertas (A4) */
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .kertas-laporan { 
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto 30px auto; 
            padding: 25mm 20mm; box-shadow: 0 4px 20px rgba(0,0,0,0.1); page-break-after: always;
        }

        /* Typography sesuai PDF */
        h2 { font-size: 18px; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; }
        .header-lp { border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 25px; }
        .info-santri { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; font-size: 13px; }
        
        .section-header { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 15px; margin-top: 25px; margin-bottom: 10px; color: var(--primary); border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
        
        .box-aspek { margin-bottom: 20px; padding-left: 15px; border-left: 3px solid #e2e8f0; }
        .aspek-title { font-weight: 700; font-size: 14px; color: var(--accent); display: flex; justify-content: space-between; }
        .stat-line { font-size: 11px; color: #64748b; font-style: italic; margin-bottom: 5px; }
        .narasi-text { font-size: 13px; text-align: justify; color: #334155; }
        .rekomendasi { background: #fff7ed; border-radius: 6px; padding: 10px; margin-top: 8px; font-size: 12px; border: 1px dashed #fdba74; }

        .footer-ttd { margin-top: 50px; display: flex; justify-content: flex-end; }
        .ttd-box { text-align: center; width: 280px; font-size: 14px; }

        /* Tabel Rekap */
        .wrap-table { background: white; padding: 20px; border-radius: 12px; max-width: 1200px; margin: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f1f5f9; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .kertas-laporan { margin: 0; box-shadow: none; width: 100%; padding: 10mm; }
            .tab-content { display: none; }
            #tab-rapor { display: block !important; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="nav-tab">
        <button class="tab-btn active" onclick="switchTab('rapor')">üìù MODE RAPOR PDF</button>
        <button class="tab-btn" onclick="switchTab('rekap')">üìä MODE REKAP EXCEL</button>
    </div>
    <div class="controls">
        <select id="pilih-kls" onchange="muatData()" style="padding:10px; border-radius:8px;">
            <option value="">-- Pilih Kelas --</option>
            <option>9A</option><option>8A</option><option>7A</option>
        </select>
        <select id="pilih-nama" style="padding:10px; border-radius:8px; width:250px">
            <option value="ALL">Cetak Semua (1 Kelas)</option>
        </select>
        <button onclick="prosesGenerate()" style="background:var(--accent); color:white; padding:10px 25px; border:none; border-radius:8px; font-weight:700; cursor:pointer;">PROSES DATA</button>
        <button onclick="window.print()" style="background:#475569; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">üñ®Ô∏è PRINT PDF</button>
    </div>
</div>

<div id="tab-rapor" class="tab-content active">
    <div id="container-rapor"></div>
</div>

<div id="tab-rekap" class="tab-content">
    <div class="wrap-table">
        <button onclick="exportExcel()" style="margin-bottom:10px; background:#16a34a; color:white; padding:8px 15px; border:none; border-radius:6px; cursor:pointer;">‚¨áÔ∏è Simpan ke Excel</button>
        <table id="tabel-rekap">
            <thead><tr id="head-rekap"><th>Nama Santri</th></tr></thead>
            <tbody id="body-rekap"></tbody>
        </table>
    </div>
</div>

<script>
const DB_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app";
const aspekList = ["Perkataan", "Berpakaian", "Akhlak", "Disiplin", "Jujur", "Tanggung Jawab", "Ibadah", "Peduli"];
let globalData = {};

function switchTab(t) {
    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector(`button[onclick*="${t}"]`).classList.add('active');
    document.getElementById(`tab-${t}`).classList.add('active');
}

async function muatData() {
    const kls = document.getElementById('pilih-kls').value;
    if(!kls) return;
    const res = await fetch(`${DB_URL}/observasi/${kls}.json`);
    globalData = await res.json() || {};
    let namaUnik = new Set();
    Object.values(globalData).forEach(t => Object.keys(t).forEach(n => namaUnik.add(n)));
    const sel = document.getElementById('pilih-nama');
    sel.innerHTML = '<option value="ALL">Cetak Seluruh Kelas (30 Halaman)</option>';
    Array.from(namaUnik).sort().forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
}

function hitungStatistik(nama) {
    let res = {};
    aspekList.forEach(a => res[a] = { counts: {1:0, 2:0, 3:0, 4:0}, diri: 3 });
    Object.values(globalData).forEach(tglData => {
        if(tglData[nama]) {
            Object.entries(tglData[nama]).forEach(([penilai, konten]) => {
                aspekList.forEach(a => {
                    let v = parseInt(konten.skor[a] || 3);
                    if(penilai === nama || konten.tipe === 'Diri') res[a].diri = v;
                    else res[a].counts[v]++;
                });
            });
        }
    });
    aspekList.forEach(a => {
        let max = -1, mode = 3;
        for(let i=1; i<=4; i++) { if(res[a].counts[i] >= max) { max = res[a].counts[i]; mode = i; } }
        res[a].modus = mode;
    });
    return res;
}

function getNarasiKompleks(aspek, d) {
    const ket = (n) => n >= 4 ? "Sangat Baik" : (n >= 3 ? "Baik" : (n >= 2 ? "Cukup" : "Kurang"));
    
    // Statistik Line
    let statArr = [];
    if(d.counts[4]>0) statArr.push(`${d.counts[4]} teman memberi nilai Sangat Baik`);
    if(d.counts[3]>0) statArr.push(`${d.counts[3]} teman memberi nilai Baik`);
    if(d.counts[2]>0) statArr.push(`${d.counts[2]} teman memberi nilai Cukup`);
    if(d.counts[1]>0) statArr.push(`${d.counts[1]} teman memberi nilai Kurang`);
    
    let nrs = `Berdasarkan konsensus sosial, mayoritas rekan sebaya menilai aspek ${aspek.toLowerCase()} Ananda berada pada kategori ${ket(d.modus).toLowerCase()}. `;
    
    if(d.diri < d.modus) {
        nrs += `Ananda memiliki kecenderungan evaluasi diri yang sangat kritis atau sikap rendah hati (${ket(d.diri)}), sementara lingkungan menangkap potensi yang jauh lebih unggul secara konsisten. `;
    } else if(d.diri > d.modus) {
        nrs += `Ananda memiliki kepercayaan diri yang tinggi, namun terdapat sedikit kesenjangan dengan pengamatan teman-teman yang mengharapkan stabilitas lebih lanjut di lapangan. `;
    } else {
        nrs += `Tingkat kesadaran diri Ananda sudah sangat selaras dengan realita perilaku yang ditampilkan di hadapan publik sekolah. `;
    }

    if(d.counts[4]>0 && d.counts[1]>0) nrs += `Persepsi teman cukup beragam, menunjukkan adanya dinamika interaksi yang berbeda-beda pada situasi tertentu.`;

    return { stat: statArr.join(', '), nrs: nrs };
}

function prosesGenerate() {
    const kls = document.getElementById('pilih-kls').value;
    const target = document.getElementById('pilih-nama').value;
    const container = document.getElementById('container-rapor');
    const bodyRekap = document.getElementById('body-rekap');
    
    container.innerHTML = ""; bodyRekap.innerHTML = "";
    document.getElementById('head-rekap').innerHTML = '<th>Nama</th>' + aspekList.map(a => `<th>${a.substring(0,3)}</th>`).join('') + '<th>Rata</th>';

    let daftar = (target === "ALL") ? Array.from(document.querySelectorAll("#pilih-nama option")).map(o => o.value).filter(v => v !== "ALL") : [target];

    daftar.sort().forEach(nama => {
        const aggr = hitungStatistik(nama);
        
        // Render Rekap
        let row = `<td><b>${nama}</b></td>`; let sum = 0;
        aspekList.forEach(a => { row += `<td>${aggr[a].modus}</td>`; sum += aggr[a].modus; });
        bodyRekap.innerHTML += `<tr>${row}<td>${(sum/8).toFixed(1)}</td></tr>`;

        // Render Rapor
        let htmlKekuatan = "", htmlPerhatian = "";
        aspekList.forEach(a => {
            const nar = getNarasiKompleks(a, aggr[a]);
            const item = `
                <div class="box-aspek">
                    <div class="aspek-title"><span>${a} ‚Äì ${aggr[a].modus >= 3 ? 'Positif' : 'Perlu Bimbingan'}</span> <span>${aggr[a].modus >= 3 ? '‚úÖ' : '‚ö†Ô∏è'}</span></div>
                    <div class="stat-line">${nar.stat} | Penilaian Diri: ${aggr[a].diri >= 3 ? 'Baik' : 'Cukup'}</div>
                    <div class="narasi-text">${nar.nrs}</div>
                    ${aggr[a].modus < 3 ? `<div class="rekomendasi"><b>Rekomendasi:</b> Ananda perlu menjaga stabilitas perilaku ${a.toLowerCase()} secara lebih konsisten di berbagai situasi sosial.</div>` : ''}
                </div>`;
            if(aggr[a].modus >= 3) htmlKekuatan += item; else htmlPerhatian += item;
        });

        container.innerHTML += `
            <div class="kertas-laporan">
                <div class="header-lp">
                    <h2>LAPORAN PERKEMBANGAN KARAKTER SANTRI</h2>
                    <p style="text-align:center; font-size:13px; margin:5px 0 0 0;">Semester Ganjil 2025/2026 - MTs As Sunnah Kota Cirebon</p>
                </div>
                <div class="info-santri">
                    <div><b>Nama Santri:</b> ${nama}<br><b>Kelas:</b> ${kls}</div>
                    <div style="text-align:right"><b>Wali Kelas:</b> Fahrijal Umar, S.Pd.I., Gr.<br><b>Tanggal:</b> 02/02/2026</div>
                </div>
                
                <div class="section-header">üåü PENDAHULUAN</div>
                <p style="font-size:13px; text-align:justify;">Laporan ini disusun sebagai bentuk transparansi pendidikan karakter, menggabungkan persepsi 29 rekan sebaya dan penilaian diri. Tujuannya adalah memberikan cermin objektif bagi Ananda dalam mengenali kekuatan diri serta area yang memerlukan pendampingan lebih lanjut demi kematangan karakter di masa depan.</p>

                <div class="section-header">üìà RANGKUMAN HASIL OBSERVASI</div>
                <p style="font-size:13px; text-align:justify;">Secara keseluruhan, Ananda menunjukkan dinamika perkembangan yang stabil. Terlihat adanya korelasi positif antara kesadaran diri dengan apresiasi dari lingkungan sosial sekolah. Ini merupakan modal penting bagi pembinaan berkelanjutan.</p>

                <div class="section-header">‚úÖ KEKUATAN UTAMA (KONSENSUS SOSIAL)</div>
                ${htmlKekuatan || '<p style="font-size:12px; font-style:italic;">Belum ada aspek yang menonjol.</p>'}

                <div class="section-header">üí° AREA PERHATIAN KHUSUS</div>
                ${htmlPerhatian || '<p style="font-size:12px; font-style:italic;">Seluruh aspek menunjukkan tren positif.</p>'}

                <div class="section-header">ü§ù TINDAK LANJUT DAN SINERGI</div>
                <p style="font-size:12px; margin:5px 0;"><b>1. Pujian & Penguatan:</b> Mohon apresiasi tulus atas aspek yang dinilai positif untuk menguatkan motivasi internal Ananda.</p>
                <p style="font-size:12px; margin:5px 0;"><b>2. Peran Wali Kelas:</b> Kami akan melakukan <i>coaching personal</i> pada aspek yang menunjukkan kesenjangan persepsi agar Ananda lebih peka secara sosial.</p>
                <p style="font-size:12px; margin:5px 0;"><b>3. Peran Orang Tua:</b> Dukungan keteladanan di rumah sangat krusial untuk membantu Ananda mencapai konsistensi karakter yang matang.</p>

                <div class="footer-ttd">
                    <div class="ttd-box">Cirebon, 02 Februari 2026<br>Wali Kelas,<br><br><br><br><b>Fahrijal Umar, S.Pd.I., Gr.</b></div>
                </div>
            </div>`;
    });
}

function exportExcel() {
    XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("tabel-rekap")), `Rekap_Karakter_${document.getElementById('pilih-kls').value}.xlsx`);
}
</script>
</body>
</html>
