<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Admin Panel | E-Santri Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #1f6f51; --secondary: #2ecc71; --accent: #6c5ce7; --bg: #f0f2f5; --red: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: #333; padding-bottom: 30px; }

        .sidebar { background: white; padding: 10px; display: flex; gap: 8px; overflow-x: auto; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #ddd; scrollbar-width: none; }
        .nav-item { padding: 10px 15px; border-radius: 10px; background: #eee; border: none; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }

        .container { padding: 15px; max-width: 900px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { font-size: 14px; margin-bottom: 15px; color: var(--primary); text-transform: uppercase; border-left: 4px solid var(--primary); padding-left: 10px; display: flex; align-items: center; gap: 8px; }
        
        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; background: #fafafa; margin-bottom: 10px; outline: none; font-size: 13px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; color: white; font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--red); }
        .btn-success { background: var(--secondary); }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 12px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 10px; }
        .badge-open { background: #dcfce7; color: #15803d; }
        .badge-close { background: #fee2e2; color: #b91c1c; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f8f8; }
        .hidden { display: none; }
        
        #chartContainer { height: 280px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="sidebar">
    <button class="nav-item active" onclick="showTab('absen', this)"><i class="fas fa-user-check"></i> Absen</button>
    <button class="nav-item" onclick="showTab('tahfidz', this)"><i class="fas fa-star"></i> Tahfidz</button>
    <button class="nav-item" onclick="showTab('ujian', this)"><i class="fas fa-file-alt"></i> Ujian</button>
    <button class="nav-item" onclick="showTab('materi', this)"><i class="fas fa-book"></i> Materi</button>
    <button class="nav-item" onclick="showTab('aquarium', this)"><i class="fas fa-fish"></i> Ikan</button>
    <button class="nav-item" onclick="showTab('pengaduan', this)"><i class="fas fa-comment-dots"></i> Aduan</button>
</div>

<div class="container">
    
    <div id="tab-absen" class="tab-content">
        <div class="card">
            <h3>Monitoring Absensi Realtime</h3>
            <select id="abs-kelas" onchange="loadAbsen()"><option value="">-- Pilih Kelas --</option><option>7A</option><option>7B</option><option>8A</option><option>8B</option><option>9A</option><option>9B</option></select>
            <div id="list-absen"></div>
        </div>
    </div>

    <div id="tab-ujian" class="tab-content hidden">
        <div class="card" style="border: 2px solid var(--accent)">
            <h3><i class="fas fa-key"></i> Kontrol & Jadwal Ujian</h3>
            <div class="grid-2">
                <div>
                    <label style="font-size:10px; font-weight:bold">Status Akses</label>
                    <select id="uj-status"><option value="Buka">üîì BUKA (Bisa Dikerjakan)</option><option value="Tutup">üîí TUTUP (Terkunci)</option></select>
                </div>
                <div>
                    <label style="font-size:10px; font-weight:bold">Target Kelas</label>
                    <select id="uj-kls-target"><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select>
                </div>
            </div>
            <div class="grid-2">
                <div>
                    <label style="font-size:10px; font-weight:bold">Mata Pelajaran</label>
                    <input type="text" id="uj-mapel-set" placeholder="Contoh: Fiqih">
                </div>
                <div>
                    <label style="font-size:10px; font-weight:bold">Durasi (Menit)</label>
                    <input type="number" id="uj-durasi" value="60">
                </div>
            </div>
            <button class="btn btn-accent" onclick="updateKontrolUjian()"><i class="fas fa-save"></i> UPDATE AKSES UJIAN</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-plus-circle"></i> Tambah Bank Soal</h3>
            <select id="soal-tipe">
                <option value="PG">Pilihan Ganda (PG)</option>
                <option value="Essay">Essay (Jawaban Bebas)</option>
            </select>
            <textarea id="bulk-soal" placeholder="PG: Soal|A,B,C,D|Kunci &#10;Essay: Masukkan soal saja" rows="3"></textarea>
            <button class="btn btn-primary" onclick="simpanSoal()"><i class="fas fa-upload"></i> SIMPAN KE BANK SOAL</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-poll"></i> Hasil Ujian & Grafik</h3>
            <div class="grid-2">
                <select id="rek-kelas"><option>7A</option><option>7B</option><option>8A</option><option>8B</option><option>9A</option><option>9B</option></select>
                <select id="rek-bulan"><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option></select>
            </div>
            <button class="btn btn-success" onclick="tarikNilai()"><i class="fas fa-sync"></i> TAMPILKAN REKAP</button>
            
            <div id="chartContainer"><canvas id="grafikUjian"></canvas></div>
            
            <table id="tabelUjian">
                <thead><tr><th>Nama</th><th>Nilai</th><th>Mapel</th><th>Tipe</th></tr></thead>
                <tbody id="body-ujian"></tbody>
            </table>
            <button class="btn btn-primary" style="background:#27ae60; margin-top:10px" onclick="exportExcel()"><i class="fas fa-file-excel"></i> DOWNLOAD EXCEL</button>
        </div>
    </div>

    <div id="tab-materi" class="tab-content hidden">
        <div class="card">
            <h3>Update Mahfuzat</h3>
            <input type="text" id="mahf-arab" placeholder="Teks Arab" style="text-align:right">
            <textarea id="mahf-arti" placeholder="Artinya"></textarea>
            <button class="btn btn-primary" onclick="setMahfuzat()">UPDATE MAHFUZAT</button>
        </div>
        <div class="card">
            <h3>Input Doa Harian</h3>
            <input type="text" id="doa-judul" placeholder="Judul Doa">
            <input type="text" id="doa-arab" placeholder="Arab" style="text-align:right">
            <textarea id="doa-arti" placeholder="Arti"></textarea>
            <button class="btn btn-accent" onclick="tambahDoa()">SIMPAN DOA</button>
            <div id="list-doa-admin" style="margin-top:15px"></div>
        </div>
    </div>

    <div id="tab-aquarium" class="tab-content hidden">
        <div class="card"><h3>Hadiah Ikan</h3><input type="email" id="aq-email" placeholder="Email Santri"><input type="number" id="aq-jml" value="1"><button class="btn btn-primary" onclick="kirimIkan()">KIRIM üêü</button></div>
    </div>
    <div id="tab-pengaduan" class="tab-content hidden"><div class="card"><h3>Laporan Santri</h3><div id="list-aduan"></div></div></div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myChart;

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        btn.classList.add('active');
        if(id === 'materi') loadDoaAdmin();
        if(id === 'pengaduan') loadAduan();
    }

    // --- FITUR UJIAN LENGKAP ---
    async function updateKontrolUjian() {
        const kls = document.getElementById('uj-kls-target').value;
        const data = {
            status: document.getElementById('uj-status').value,
            mapel: document.getElementById('uj-mapel-set').value,
            durasi: document.getElementById('uj-durasi').value,
            tanggal: new Date().toLocaleDateString('id-ID')
        };
        if(!data.mapel) return alert("Isi Mapel!");
        await db.ref(`pengaturan_ujian/${kls}`).set(data);
        alert("Akses Ujian Berhasil Diupdate!");
    }

    function simpanSoal() {
        const kls = document.getElementById('uj-kls-target').value;
        const tipe = document.getElementById('soal-tipe').value;
        const txt = document.getElementById('bulk-soal').value;
        
        let dataSoal = { tipe: tipe, soal: txt };

        if(tipe === "PG") {
            const p = txt.split('|');
            if(p.length < 3) return alert("Format PG: Soal|A,B,C,D|Kunci");
            dataSoal = { soal: p[0], opsi: p[1], kunci: p[2], tipe: "PG" };
        }

        db.ref(`bank_soal/${kls}/Ujian`).push(dataSoal);
        alert("Soal Tersimpan di Bank Soal!");
        document.getElementById('bulk-soal').value = "";
    }

    function tarikNilai() {
        const kls = document.getElementById('rek-kelas').value;
        const bln = document.getElementById('rek-bulan').value;
        db.ref(`hasil_ujian/2026/${bln}`).once('value', snap => {
            const body = document.getElementById('body-ujian'); body.innerHTML = "";
            let dataG = { l: [], s: [] };
            snap.forEach(user => {
                user.forEach(u => {
                    const v = u.val();
                    if(v.kelas === kls) {
                        body.innerHTML += `<tr><td>${v.nama}</td><td>${v.nilai}</td><td>${v.mapel}</td><td><span class="badge ${v.tipe==='PG'?'badge-open':'badge-close'}">${v.tipe || 'PG'}</span></td></tr>`;
                        dataG.l.push(v.nama); dataG.s.push(v.nilai);
                    }
                });
            });
            renderChart(dataG);
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('grafikUjian').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'bar', data: { labels: data.l, datasets: [{ label: 'Nilai Santri', data: data.s, backgroundColor: '#6c5ce7' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    // --- FITUR LAINNYA ---
    function setMahfuzat() { db.ref('konten/mahfuzat').set({ arab: document.getElementById('mahf-arab').value, indo: document.getElementById('mahf-arti').value }); alert("Update!"); }
    
    function tambahDoa() {
        const data = { judul: document.getElementById('doa-judul').value, arab: document.getElementById('doa-arab').value, arti: document.getElementById('doa-arti').value };
        db.ref('doa_harian').push(data).then(() => { alert("Tersimpan!"); loadDoaAdmin(); });
    }

    function loadDoaAdmin() {
        db.ref('doa_harian').on('value', snap => {
            const list = document.getElementById('list-doa-admin'); list.innerHTML = "";
            snap.forEach(d => { list.innerHTML += `<div class="item-row"><span>${d.val().judul}</span><button class="btn-danger" style="width:auto; padding:5px 10px" onclick="db.ref('doa_harian/${d.key}').remove()">Hapus</button></div>`; });
        });
    }

    function loadAbsen() {
        const kls = document.getElementById('abs-kelas').value;
        const d = new Date();
        db.ref(`absensi/2026/${d.getMonth()+1}/${d.getDate()}/${kls}`).on('value', snap => {
            const list = document.getElementById('list-absen'); list.innerHTML = "";
            if(!snap.exists()) list.innerHTML = "<p style='text-align:center; padding:20px; color:#999'>Belum ada data absen hari ini.</p>";
            snap.forEach(s => { list.innerHTML += `<div class="item-row"><b>${s.val().nama}</b> <span class="badge badge-open">${s.val().status}</span></div>`; });
        });
    }

    function loadAduan() {
        db.ref('pengaduan').on('value', snap => {
            const list = document.getElementById('list-aduan'); list.innerHTML = "";
            snap.forEach(a => { list.innerHTML += `<div class="card" style="border-left:5px solid var(--red)"><b>${a.val().nama}</b><p style="font-size:12px">${a.val().pesan}</p></div>`; });
        });
    }

    function kirimIkan() {
        const email = document.getElementById('aq-email').value.replace(/\./g, ',');
        db.ref(`users/${email}/ikan`).transaction(v => (v||0)+parseInt(document.getElementById('aq-jml').value));
        alert("Ikan Terkirim!");
    }

    function exportExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("tabelUjian")), `Rekap_Ujian.xlsx`); }
</script>
</body>
</html>
