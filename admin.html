<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Admin Panel | E-Santri Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #1f6f51; --secondary: #2ecc71; --accent: #6c5ce7; --bg: #f0f2f5; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: #333; }

        /* Sidebar Navigasi */
        .sidebar { background: white; padding: 10px; display: flex; gap: 8px; overflow-x: auto; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #ddd; scrollbar-width: none; }
        .nav-item { padding: 10px 15px; border-radius: 10px; background: #eee; border: none; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }

        /* Konten */
        .container { padding: 15px; max-width: 900px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { font-size: 14px; margin-bottom: 15px; color: var(--primary); text-transform: uppercase; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; background: #fafafa; margin-bottom: 10px; outline: none; font-size: 13px; }
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; color: white; font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: #e74c3c; }

        /* Tabel & List */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f8f8; }
        .hidden { display: none; }
        
        #chartContainer { height: 250px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="sidebar">
    <button class="nav-item active" onclick="showTab('absen', this)"><i class="fas fa-calendar-check"></i> Absen</button>
    <button class="nav-item" onclick="showTab('tahfidz', this)"><i class="fas fa-quran"></i> Tahfidz</button>
    <button class="nav-item" onclick="showTab('ujian', this)"><i class="fas fa-file-signature"></i> Ujian</button>
    <button class="nav-item" onclick="showTab('materi', this)"><i class="fas fa-book-open"></i> Materi</button>
    <button class="nav-item" onclick="showTab('aquarium', this)"><i class="fas fa-fish"></i> Aquarium</button>
    <button class="nav-item" onclick="showTab('pengaduan', this)"><i class="fas fa-bullhorn"></i> Pengaduan</button>
</div>

<div class="container">
    
    <div id="tab-absen" class="tab-content">
        <div class="card">
            <h3>Monitoring Absensi</h3>
            <select id="abs-kelas" onchange="loadAbsen()"><option>Pilih Kelas</option><option>7A</option><option>7B</option><option>7C</option><option>7D</option><option>8A</option><option>8B</option><option>8C</option><option>8D</option><option>9A</option><option>9B</option><option>9C</option><option>9D</option></select>
            <div id="list-absen"></div>
        </div>
    </div>

    <div id="tab-tahfidz" class="tab-content hidden">
        <div class="card">
            <h3>Monitoring Tahfidz</h3>
            <select id="thf-kelas" onchange="loadTahfidz()"><option>Pilih Kelas</option><option>7A</option><option>7B</option><option>7C</option><option>7D</option><option>8A</option><option>8B</option><option>8C</option><option>8D</option><option>9A</option><option>9B</option><option>9C</option><option>9D</option></select>
            <div id="list-tahfidz"></div>
        </div>
    </div>

    <div id="tab-ujian" class="tab-content hidden">
        <div class="card">
            <h3>Input Soal Baru</h3>
            <select id="soal-kelas"><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select>
            <textarea id="bulk-soal" placeholder="Format: Soal|A,B,C,D|Kunci" rows="3"></textarea>
            <button class="btn btn-primary" onclick="simpanSoal()">Simpan Bank Soal</button>
        </div>

        <div class="card">
            <h3>Rekap Nilai Ujian</h3>
            <div style="display:flex; gap:10px;">
                <select id="rek-kelas"><option>7A</option><option>7B</option><option>7C</option><option>7D</option><option>8A</option><option>8B</option><option>8C</option><option>8D</option><option>9A</option><option>9B</option><option>9C</option><option>9D</option></select>
                <select id="rek-bulan"><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select>
            </div>
            <button class="btn btn-accent" onclick="tarikNilai()">Tampilkan & Hitung Grafik</button>
            <button class="btn btn-primary" style="background:#27ae60" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Download Excel</button>
            
            <div id="chartContainer"><canvas id="grafikUjian"></canvas></div>
            
            <table id="tabelUjian">
                <thead><tr><th>Nama</th><th>Nilai</th><th>Mapel</th></tr></thead>
                <tbody id="body-ujian"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-materi" class="tab-content hidden">
        <div class="card">
            <h3>Update Mahfuzat</h3>
            <input type="text" id="mahf-arab" placeholder="Teks Arab" style="text-align:right">
            <textarea id="mahf-arti" placeholder="Artinya"></textarea>
            <button class="btn btn-primary" onclick="setMahfuzat()">Update Mahfuzat</button>
        </div>
        <div class="card">
            <h3>Input Doa Harian (doa.html)</h3>
            <input type="text" id="doa-judul" placeholder="Judul Doa">
            <input type="text" id="doa-arab" placeholder="Teks Arab" style="text-align:right">
            <textarea id="doa-arti" placeholder="Terjemahan"></textarea>
            <button class="btn btn-accent" onclick="tambahDoa()">Simpan ke Database Doa</button>
            <div id="list-doa-admin" style="margin-top:15px"></div>
        </div>
    </div>

    <div id="tab-aquarium" class="tab-content hidden">
        <div class="card">
            <h3>Kirim Reward Ikan</h3>
            <input type="email" id="aq-email" placeholder="Email Santri (pake koma untuk titik)">
            <input type="number" id="aq-jml" value="1">
            <button class="btn btn-primary" onclick="kirimIkan()">Kirim Ikan üêü</button>
        </div>
    </div>

    <div id="tab-pengaduan" class="tab-content hidden">
        <div class="card">
            <h3>Pesan Pengaduan</h3>
            <div id="list-aduan"></div>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myChart;

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        btn.classList.add('active');
        if(id === 'pengaduan') loadAduan();
        if(id === 'materi') loadDoaAdmin();
    }

    // --- LOGIC UJIAN & GRAFIK ---
    function tarikNilai() {
        const kls = document.getElementById('rek-kelas').value;
        const bln = document.getElementById('rek-bulan').value;
        db.ref(`hasil_ujian/2026/${bln}`).once('value', snap => {
            const body = document.getElementById('body-ujian'); body.innerHTML = "";
            let dataGrafik = { labels: [], skor: [] };
            
            snap.forEach(user => {
                user.forEach(u => {
                    const val = u.val();
                    if(val.kelas === kls) {
                        body.innerHTML += `<tr><td>${val.nama}</td><td>${val.nilai}</td><td>${val.mapel}</td></tr>`;
                        dataGrafik.labels.push(val.nama);
                        dataGrafik.skor.push(val.nilai);
                    }
                });
            });
            renderChart(dataGrafik);
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('grafikUjian').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Nilai Santri', data: data.skor, backgroundColor: '#1f6f51' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function exportExcel() {
        const table = document.getElementById("tabelUjian");
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `Rekap_Ujian_${document.getElementById('rek-kelas').value}.xlsx`);
    }

    function simpanSoal() {
        const kls = document.getElementById('soal-kelas').value;
        const txt = document.getElementById('bulk-soal').value;
        const p = txt.split('|');
        if(p.length < 3) return alert("Format salah!");
        db.ref(`bank_soal/${kls}/Ujian`).push({ soal: p[0], opsi: p[1], kunci: p[2] });
        alert("Soal berhasil masuk bank soal!");
    }

    // --- MATERI & DOA ---
    function tambahDoa() {
        const data = { judul: document.getElementById('doa-judul').value, arab: document.getElementById('doa-arab').value, arti: document.getElementById('doa-arti').value };
        db.ref('doa_harian').push(data).then(() => { alert("Doa tersimpan!"); loadDoaAdmin(); });
    }

    function loadDoaAdmin() {
        db.ref('doa_harian').on('value', snap => {
            const list = document.getElementById('list-doa-admin'); list.innerHTML = "";
            snap.forEach(d => {
                list.innerHTML += `<div class="item-row"><span>${d.val().judul}</span><button class="btn-danger" style="width:auto; padding:5px 10px" onclick="hapusDoa('${d.key}')">Hapus</button></div>`;
            });
        });
    }
    function hapusDoa(key) { if(confirm("Hapus doa ini?")) db.ref('doa_harian/'+key).remove(); }

    function setMahfuzat() {
        db.ref('konten/mahfuzat').set({ arab: document.getElementById('mahf-arab').value, indo: document.getElementById('mahf-arti').value });
        alert("Mahfuzat Update!");
    }

    // --- AQUARIUM ---
    function kirimIkan() {
        const email = document.getElementById('aq-email').value.replace(/\./g, ',');
        const jml = parseInt(document.getElementById('aq-jml').value);
        db.ref(`users/${email}/ikan`).transaction(v => (v||0)+jml);
        alert("Ikan terkirim!");
    }

    // --- PENGADUAN ---
    function loadAduan() {
        db.ref('pengaduan').on('value', snap => {
            const list = document.getElementById('list-aduan'); list.innerHTML = "";
            snap.forEach(a => {
                list.innerHTML += `<div class="card" style="border:1px solid #eee"><b>${a.val().nama}:</b><p>${a.val().pesan}</p></div>`;
            });
        });
    }

    // --- ABSEN & TAHFIDZ MONITOR ---
    function loadAbsen() {
        const kls = document.getElementById('abs-kelas').value;
        const tgl = new Date().getDate();
        db.ref(`absensi/2026/1/${tgl}/${kls}`).on('value', snap => {
            const div = document.getElementById('list-absen'); div.innerHTML = "";
            snap.forEach(s => div.innerHTML += `<div class="item-row"><b>${s.val().nama}</b> <span style="color:green">${s.val().status}</span></div>`);
        });
    }
</script>
</body>
</html>
