<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Management & Rewards | E-Santri Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --primary: #1f6f51; --gold: #f1c40f; --bg: #f4f7f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
        
        body { background: var(--bg); color: #2d3436; }

        /* HEADER REWARD SECTION */
        .reward-page { 
            background: linear-gradient(180deg, #1f6f51 0%, #133b2c 100%); 
            min-height: 100vh; padding: 30px 20px; color: white;
            display: flex; flex-direction: column; align-items: center;
        }

        .trophy-icon { font-size: 50px; color: var(--gold); margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(241,196,15,0.5)); }
        .reward-page h2 { font-weight: 800; letter-spacing: 1px; text-transform: uppercase; font-size: 20px; }
        .reward-page p { font-size: 11px; opacity: 0.8; margin-bottom: 30px; }

        /* LEADERBOARD CARD */
        .leaderboard-container { width: 100%; max-width: 500px; }
        .guru-rank-card { 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 20px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(255,255,255,0.1); transition: 0.3s;
        }
        .rank-1 { background: rgba(241,196,15,0.2); border: 1px solid var(--gold); transform: scale(1.05); margin-bottom: 20px; }
        
        .guru-info { display: flex; align-items: center; gap: 15px; }
        .rank-num { font-weight: 800; font-size: 18px; width: 30px; }
        .guru-name b { font-size: 14px; display: block; }
        .guru-name small { font-size: 10px; opacity: 0.7; }
        .points { text-align: right; }
        .points b { font-size: 16px; color: var(--gold); }
        .points span { font-size: 9px; display: block; opacity: 0.8; }

        /* FLOATING ACTION BUTTON TO ADMIN */
        .btn-to-admin {
            position: fixed; bottom: 30px; right: 20px;
            background: white; color: var(--primary);
            padding: 15px 25px; border-radius: 50px; font-weight: 800;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            text-decoration: none; display: flex; align-items: center; gap: 10px;
            font-size: 13px; z-index: 1000; border: none; cursor: pointer;
        }

        /* OVERLAY ADMIN PANEL (Hidden by default) */
        #admin-panel {
            position: fixed; inset: 0; background: var(--bg);
            z-index: 2000; overflow-y: auto; display: none;
        }
        .admin-header { background: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn-back { border: none; background: #eee; padding: 8px 15px; border-radius: 10px; font-weight: 600; cursor: pointer; }

        /* SHARED STYLES */
        .content { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .nav-btn { padding: 10px 18px; border-radius: 12px; border: none; background: #fff; font-weight: 600; white-space: nowrap; font-size: 11px; cursor: pointer; border: 1px solid #eee; }
        .nav-btn.active { background: var(--primary); color: white; }
        .item-row { background: #f9f9f9; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 6px; color: white; font-size: 10px; font-weight: bold; }
        .btn-action { width: 100%; padding: 15px; border: none; background: var(--primary); color: white; border-radius: 15px; font-weight: 700; margin-top: 10px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="reward-page" id="reward-page">
    <div class="trophy-icon"><i class="fas fa-crown"></i></div>
    <h2>Teacher of the Month</h2>
    <p id="current-month">Periode: Januari 2026</p>

    <div class="leaderboard-container" id="leaderboard-list">
        <div style="text-align: center; opacity: 0.5; margin-top: 50px;">Memuat Papan Peringkat...</div>
    </div>

    <button class="btn-to-admin" onclick="openAdmin()">
        MASUK CONTROL PANEL <i class="fas fa-arrow-right"></i>
    </button>
</div>

<div id="admin-panel">
    <div class="admin-header">
        <b style="color: var(--primary);">MASTER CONTROL</b>
        <button class="btn-back" onclick="closeAdmin()"><i class="fas fa-times"></i> Tutup</button>
    </div>

    <div class="content">
        <div class="nav-scroller">
            <button class="nav-btn active" onclick="switchTab('tab-absen', this)">Absensi</button>
            <button class="nav-btn" onclick="switchTab('tab-tahfidz', this)">Tahfidz</button>
            <button class="nav-btn" onclick="switchTab('tab-aquarium', this)">Aquarium</button>
            <button class="nav-btn" onclick="switchTab('tab-aduan', this)">Aduan</button>
            <button class="nav-btn" onclick="switchTab('tab-materi', this)">Materi</button>
        </div>

        <div id="tab-absen" class="tab-content card">
            <h3>Monitoring Guru Aktif</h3>
            <div id="mon-guru" style="margin-bottom: 20px;"></div>
            <h3>Absensi Santri</h3>
            <select id="sel-kls" onchange="loadAbsen()" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
                <option value="7A">Kelas 7A</option><option value="7B">Kelas 7B</option><option value="8A">Kelas 8A</option>
            </select>
            <div id="list-absen" style="margin-top:15px;"></div>
        </div>

        <div id="tab-aquarium" class="tab-content card hidden">
            <h3>Kirim Hadiah Ikan</h3>
            <label style="font-size:11px; font-weight:700;">Email Santri</label>
            <input type="email" id="aq-email" placeholder="santri@gmail.com" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
            <button class="btn-action" onclick="kirimIkan()">KIRIM IKAN</button>
        </div>

        <div id="tab-aduan" class="tab-content card hidden">
            <h3>Pengaduan Santri</h3>
            <div id="list-aduan"></div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. FUNGSI LEADERBOARD REWARD
    function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        const now = new Date();
        const bln = now.getMonth() + 1;
        
        db.ref(`budaya/2026/${bln}`).on('value', snap => {
            let guruData = {};
            snap.forEach(tgl => tgl.forEach(kls => kls.forEach(s => {
                const d = s.val();
                if(d.guru) {
                    if(!guruData[d.guru]) guruData[d.guru] = { n: d.guru, p: 0 };
                    guruData[d.guru].p += 1;
                }
            })));

            const sorted = Object.values(guruData).sort((a,b) => b.p - a.p);
            list.innerHTML = "";
            sorted.forEach((g, i) => {
                let isTop = i === 0 ? 'rank-1' : '';
                let icon = i === 0 ? 'ü•á' : (i===1 ? 'ü•à' : (i===2 ? 'ü•â' : 'üéñÔ∏è'));
                list.innerHTML += `
                    <div class="guru-rank-card ${isTop}">
                        <div class="guru-info">
                            <div class="rank-num">${icon}</div>
                            <div class="guru-name"><b>${g.n}</b><small>Guru Aktif Bulan Ini</small></div>
                        </div>
                        <div class="points"><b>${g.p}</b><span>POIN</span></div>
                    </div>`;
            });
        });
    }

    // 2. NAVIGASI HALAMAN
    function openAdmin() { document.getElementById('admin-panel').style.display = 'block'; loadAbsen(); loadMonitorGuru(); }
    function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        btn.classList.add('active');
        if(tabId === 'tab-aduan') loadAduan();
    }

    // 3. FUNGSI ADMIN TOOLS
    function loadMonitorGuru() {
        const mon = document.getElementById('mon-guru');
        const now = new Date();
        const path = `budaya/${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
        db.ref(path).on('value', snap => {
            mon.innerHTML = "";
            let aktif = new Set();
            snap.forEach(k => k.forEach(s => { if(s.val().guru) aktif.add(s.val().guru); }));
            aktif.forEach(name => {
                mon.innerHTML += `<div class="item-row"><b>Ust. ${name}</b> <span class="badge" style="background:#1f6f51">READY</span></div>`;
            });
        });
    }

    function loadAbsen() {
        const list = document.getElementById('list-absen');
        const kls = document.getElementById('sel-kls').value;
        const now = new Date();
        const path = `absensi/${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}/${kls}`;
        db.ref(path).on('value', snap => {
            list.innerHTML = "";
            snap.forEach(s => {
                const v = s.val();
                list.innerHTML += `<div class="item-row"><b>${v.nama}</b> <b>${v.status}</b></div>`;
            });
        });
    }

    function kirimIkan() {
        const email = document.getElementById('aq-email').value.replace(/\./g, ',');
        if(!email) return alert("Isi Email!");
        db.ref('users/'+email+'/ikan').transaction(c => (c||0)+1).then(()=>alert("Ikan Terkirim!"));
    }

    function loadAduan() {
        const list = document.getElementById('list-aduan');
        db.ref('pengaduan').on('value', snap => {
            list.innerHTML = "";
            snap.forEach(a => {
                list.innerHTML += `<div class="item-row" style="flex-direction:column;"><b>${a.val().nama}</b><p>${a.val().pesan}</p></div>`;
            });
        });
    }

    loadLeaderboard();
</script>
</body>
</html>
