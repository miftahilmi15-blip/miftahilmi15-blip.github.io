at.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const LIST_MAPEL = ["Mtk", "IPA", "IPS", "PKN", "B.Indo", "B.Ing", "B.Arab", "Fikih", "Aqidah", "Tarikh", "Infor", "B.Daerah", "Seni"];

    function bukaAdmin() { document.getElementById('reward-screen').style.display = 'none'; document.getElementById('admin-screen').style.display = 'block'; }
    function tutupAdmin() { document.getElementById('reward-screen').style.display = 'flex'; document.getElementById('admin-screen').style.display = 'none'; }
    
    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        btn.classList.add('active');
        
        if(id === 'tab-monitoring') { loadMonitorGuru(); loadAbsensi(); }
        if(id === 'tab-tahfidz') loadTahfidz(); 
        if(id === 'tab-pengaduan') loadPengaduan();
        if(id === 'tab-aquarium') loadRiwayatIkan();
    }

    // --- LOGIKA TAHFIDZ ---
    function loadTahfidz() {
        const list = document.getElementById('list-tahfidz');
        list.innerHTML = "<p style='font-size:12px; color:#888;'>Sedang melacak data...</p>";
        
        db.ref('tahfidz').limitToLast(20).on('value', snap => {
            list.innerHTML = "";
            if (!snap.exists()) { 
                list.innerHTML = "<div class='item-row'>Folder 'tahfidz' ditemukan tapi kosong.</div>"; 
                return; 
            }
            
            snap.forEach(c => {
                const d = c.val();
                
                // OTOMATIS: Ambil semua isi data tanpa peduli nama labelnya
                // Kita gabungkan semua isinya menjadi satu teks panjang agar terlihat
                let semuaInfo = Object.keys(d).map(key => `<b>${key}:</b> ${d[key]}`).join(' | ');

                list.innerHTML += `
                <div class="item-row" style="flex-direction: column; align-items: flex-start; gap: 5px; padding: 15px;">
                    <div style="font-size: 13px; color: var(--primary); font-weight:700; border-bottom:1px solid #eee; width:100%; padding-bottom:5px; margin-bottom:5px;">
                        <i class="fas fa-history"></i> Data Setoran Hafalan
                    </div>
                    <div style="font-size: 12px; line-height: 1.6; color: #444;">
                        ${semuaInfo}
                    </div>
                    <div style="margin-top:10px; width:100%; text-align:right;">
                         <button onclick="db.ref('tahfidz/${c.key}').remove()" style="background:none; border:none; color:red; font-size:10px; cursor:pointer;"><i class="fas fa-trash"></i> Hapus</button>
                    </div>
                </div>`;
            });
        });
    }

            dataArr.forEach(d => {
                list.innerHTML += `
                <div class="item-row" style="flex-direction: column; align-items: flex-start; gap: 5px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; width: 100%;">
                        <b style="color: var(--primary)">${d.nama} (${d.kelas})</b>
                        <small style="color: #999;">${d.tanggal}</small>
                    </div>
                    <div style="font-size: 12px; background: #f0fdf4; padding: 8px; border-radius: 8px; width: 100%; border-left: 3px solid #22c55e;">
                        <b>Surah:</b> ${d.surah} | <b>Ayat:</b> ${d.ayat} <br>
                        <b>Predikat:</b> <span style="color: #1f6f51; font-weight:700;">${d.nilai}</span>
                    </div>
                </div>`;
            });
        });
    }

    // --- LOGIKA REKAP & UJIAN ---
    function generateRekap() {
        const kls = document.getElementById('rekap-kelas-pilih').value;
        const body = document.getElementById('body-rekap');
        const head = document.getElementById('head-rekap');
        let headHtml = `<tr><th class="nama-col">Nama Santri</th>`;
        LIST_MAPEL.forEach(m => headHtml += `<th>${m}</th>`);
        headHtml += `<th class="rata-col">Rata2</th></tr>`;
        head.innerHTML = headHtml;

        db.ref(`hasil_ujian/${kls}`).once('value', snap => {
            if(!snap.exists()) return alert("Data Kosong!");
            let dataSantri = {};
            snap.forEach(c => {
                const v = c.val();
                if(!dataSantri[v.nama]) dataSantri[v.nama] = {};
                let nAkhir = v.nilai_essay && v.nilai_essay !== "Belum" ? (v.nilai_pg + parseFloat(v.nilai_essay))/2 : v.nilai_pg;
                dataSantri[v.nama][v.mapel] = nAkhir;
            });
            body.innerHTML = "";
            for(let nama in dataSantri) {
                let total = 0, count = 0, row = `<tr><td class="nama-col">${nama}</td>`;
                LIST_MAPEL.forEach(m => {
                    let nilai = dataSantri[nama][m] !== undefined ? dataSantri[nama][m] : "-";
                    if(nilai !== "-") { total += nilai; count++; }
                    row += `<td>${nilai}</td>`;
                });
                row += `<td class="rata-col">${count > 0 ? (total/count).toFixed(1) : 0}</td></tr>`;
                body.innerHTML += row;
            }
            document.getElementById('btn-download').classList.remove('hidden');
        });
    }

    function publishJadwalUjian() {
        const m = document.getElementById('u-mapel').value, k = document.getElementById('u-target-kelas').value, j = document.getElementById('u-jadwal').value, s = document.getElementById('u-massal').value;
        if(!j || !s) return alert("Lengkapi data!");
        db.ref(`ujian/${k}`).set({ mapel: m, waktu_buka: j, bank_soal: s, status: "Aktif" }).then(() => alert("Ujian Publish!"));
    }

    function downloadExcel() { window.open('data:application/vnd.ms-excel,' + encodeURIComponent(document.getElementById("tabel-rekap").outerHTML)); }

    // --- MONITORING & ABSENSI ---
    function loadMonitorGuru() {
        const list = document.getElementById('list-guru-input');
        const now = new Date();
        db.ref(`budaya/${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`).on('value', snap => {
            list.innerHTML = "";
            snap.forEach(k => k.forEach(s => {
                const d = s.val();
                list.innerHTML += `<div class="item-row"><b>Ust. ${d.guru}</b><span>${d.kelas}</span></div>`;
            }));
        });
    }

    function loadAbsensi() {
        const kls = document.getElementById('pilih-kelas-mon').value;
        const now = new Date();
        db.ref(`absensi/${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}/${kls}`).on('value', snap => {
            const container = document.getElementById('list-absensi');
            container.innerHTML = "";
            snap.forEach(s => {
                const v = s.val();
                container.innerHTML += `<div class="item-row"><b>${v.nama}</b><span>${v.status}</span></div>`;
            });
        });
    }

    // --- MATERI & AQUARIUM ---
    function saveMahfuzat() {
        const arb = document.getElementById('m-arab').value, ind = document.getElementById('m-indo').value;
        db.ref('konten/mahfuzat').set({ arab: arb, indo: ind }).then(() => alert("Berhasil!"));
    }

    function kirimIkanByEmail() {
        const em = document.getElementById('aq-email').value.trim().toLowerCase().replace(/\./g, ',');
        const jml = parseInt(document.getElementById('aq-jumlah').value);
        if(!em) return alert("Email kosong!");
        db.ref('users/'+em+'/ikan').transaction(v => (v||0)+jml).then(() => { alert("Ikan Dikirim!"); loadRiwayatIkan(); });
    }

    function loadRiwayatIkan() {
        const list = document.getElementById('riwayat-ikan');
        db.ref('users').limitToLast(10).once('value', snap => {
            list.innerHTML = "";
            snap.forEach(u => {
                const d = u.val();
                if(d.ikan) list.innerHTML += `<div class="item-row"><b>${u.key.replace(/,/g,'.')}</b><span>${d.ikan} Ikan</span></div>`;
            });
        });
    }

    function loadPengaduan() {
        db.ref('pengaduan').on('value', snap => {
            const list = document.getElementById('list-pengaduan');
            list.innerHTML = "";
            snap.forEach(i => { const d = i.val(); list.innerHTML += `<div class="item-row"><b>${d.nama}</b><p>${d.pesan}</p></div>`; });
        });
    }

    function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        const now = new Date();
        db.ref(`budaya/${now.getFullYear()}/${now.getMonth() + 1}`).on('value', snap => {
            let guruSkor = {};
            snap.forEach(t => t.forEach(k => k.forEach(s => { const d = s.val(); if(d.guru) guruSkor[d.guru] = (guruSkor[d.guru] || 0) + 1; })));
            const sorted = Object.keys(guruSkor).sort((a,b) => guruSkor[b] - guruSkor[a]);
            list.innerHTML = "";
            sorted.forEach((n, i) => {
                list.innerHTML += `<div class="leaderboard-item" style="${i==0?'border:1px solid gold; background:rgba(255,215,0,0.1)':''}"><span>${n}</span><b>${guruSkor[n]} Poin</b></div>`;
            });
        });
    }

    loadLeaderboard();
</script>
</body>
</html>
