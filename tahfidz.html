<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SANTRI | Rekap Harian & Bulanan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1f6f51; --bg: #f0f7f4; --accent: #eab308; --blue: #2563eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); padding: 10px; display: flex; justify-content: center; }
        .wadah { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        header { text-align: center; margin-bottom: 15px; }
        header h1 { color: var(--primary); font-size: 18px; font-weight: 800; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 700; font-size: 12px; cursor: pointer; color: #666; }
        .tab-btn.active { background: var(--primary); color: white; }

        .form-grup { margin-bottom: 12px; }
        label { font-size: 10px; font-weight: 700; color: #444; display: block; margin-bottom: 4px; text-transform: uppercase; }
        select, input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #eee; background: #f9f9f9; font-size: 13px; outline: none; }
        
        .grid-rekap { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        .btn-aksi { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 5px; font-size: 13px; }
        .btn-cari { background: var(--primary); color: white; }
        .btn-excel { background: #107c41; color: white; margin-top: 10px; }
        
        .tabel-scroll { width: 100%; overflow-x: auto; margin-top: 15px; }
        .rekap-table { width: 100%; border-collapse: collapse; font-size: 10px; min-width: 500px; }
        .rekap-table th { background: #f1f5f9; color: var(--primary); padding: 8px; border: 1px solid #ddd; }
        .rekap-table td { padding: 8px; border: 1px solid #ddd; text-align: center; vertical-align: middle; }
        
        #lock-screen { position:fixed; inset:0; background:var(--primary); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h2 style="margin-bottom:20px;">üîí PIN USTADZ</h2>
    <input type="password" id="passcode" style="width:200px; text-align:center; margin-bottom:15px;" placeholder="****">
    <button onclick="cekLogin()" class="btn-aksi" style="width:200px; background:var(--accent)">MASUK</button>
</div>

<div class="wadah">
    <header><h1>REKAP TAHFIDZ & QIRAATI</h1></header>

    <div class="tabs">
        <button class="tab-btn active" onclick="location.reload()">INPUT DATA</button>
        <button class="tab-btn" onclick="bukaTabRekap()">MENU REKAP</button>
    </div>

    <div id="page-rekap">
        <div class="form-grup">
            <label>Pilih Kelas</label>
            <select id="rekap-kelas">
                <option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="7D">7D</option>
                <option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option><option value="8D">8D</option>
                <option value="9A">9A</option><option value="9B">9B</option><option value="9C">9C</option><option value="9D">9D</option>
            </select>
        </div>

        <div class="grid-rekap">
            <div class="form-grup">
                <label>Jenis Rekap</label>
                <select id="jenis-rekap" onchange="toggleFilter()">
                    <option value="harian">Per Hari (Tanggal)</option>
                    <option value="bulanan">Per Bulan</option>
                </select>
            </div>
            <div class="form-grup" id="box-tanggal">
                <label>Pilih Tanggal</label>
                <input type="date" id="filter-tanggal">
            </div>
            <div class="form-grup" id="box-bulan" style="display:none">
                <label>Pilih Bulan</label>
                <select id="filter-bulan">
                    <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
                    <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
                    <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
                    <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                </select>
            </div>
        </div>

        <button class="btn-aksi btn-cari" onclick="prosesRekap()">üîç TAMPILKAN REKAP</button>
        <button id="btnExcel" class="btn-aksi btn-excel" style="display:none" onclick="exportExcel()">Excel</button>

        <div class="tabel-scroll" id="wadah-tabel">
            </div>
    </div>
</div>

<script>
    const FIREBASE_URL = "https://e-santri-b62be-default-rtdb.asia-southeast1.firebasedatabase.app";
    const KODE_RAHASIA = "152003";

    window.onload = function() {
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            document.getElementById('lock-screen').style.display = 'flex';
        }
        // Set tanggal hari ini sebagai default
        document.getElementById('filter-tanggal').valueAsDate = new Date();
    };

    function cekLogin() {
        if (document.getElementById('passcode').value === KODE_RAHASIA) {
            sessionStorage.setItem('isLoggedIn', 'true');
            document.getElementById('lock-screen').style.display = 'none';
        } else { alert("PIN Salah!"); }
    }

    function toggleFilter() {
        const jenis = document.getElementById('jenis-rekap').value;
        document.getElementById('box-tanggal').style.display = jenis === 'harian' ? 'block' : 'none';
        document.getElementById('box-bulan').style.display = jenis === 'bulanan' ? 'block' : 'none';
    }

    function bukaTabRekap() {
        // Logika pindah ke menu rekap (menyembunyikan input jika digabung dalam 1 file)
        alert("Gunakan filter di bawah untuk melihat data");
    }

    async function prosesRekap() {
        const jenis = document.getElementById('jenis-rekap').value;
        const kelas = document.getElementById('rekap-kelas').value;
        const wadah = document.getElementById('wadah-tabel');
        
        let url = "";
        let filterTanggal = "";

        if (jenis === 'harian') {
            const tgl = new Date(document.getElementById('filter-tanggal').value);
            url = `${FIREBASE_URL}/tahfidz/${tgl.getFullYear()}/${tgl.getMonth() + 1}.json`;
            filterTanggal = tgl.toLocaleDateString('id-ID');
        } else {
            const bln = document.getElementById('filter-bulan').value;
            url = `${FIREBASE_URL}/tahfidz/2026/${bln}.json`;
        }

        wadah.innerHTML = "Memuat data...";

        try {
            const res = await fetch(url);
            const data = await res.json();
            if (!data) { wadah.innerHTML = "Tidak ada data ditemukan."; return; }

            let html = `<table class="rekap-table" id="tabelData">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama</th>
                        <th>Materi/Surat</th>
                        <th>Halaman/Ayat</th>
                        <th>Status</th>
                        <th>‚òÖ</th>
                        <th>Tanggal</th>
                    </tr>
                </thead>
                <tbody>`;
            
            let no = 1;
            let dataAda = false;

            // Looping NIPD
            Object.keys(data).forEach(nipd => {
                const logs = data[nipd];
                Object.values(logs).forEach(log => {
                    // Filter jika harian
                    if (jenis === 'harian' && log.tgl !== filterTanggal) return;

                    dataAda = true;
                    html += `<tr>
                        <td>${no++}</td>
                        <td style="text-align:left">${log.nama}</td>
                        <td>${log.materi}</td>
                        <td>${log.ayat}</td>
                        <td>${log.status || 'Lulus'}</td>
                        <td>${log.nilai}</td>
                        <td>${log.tgl}</td>
                    </tr>`;
                });
            });

            if (!dataAda) {
                wadah.innerHTML = "Data untuk kriteria ini kosong.";
                document.getElementById('btnExcel').style.display = 'none';
            } else {
                wadah.innerHTML = html + "</tbody></table>";
                document.getElementById('btnExcel').style.display = 'block';
            }

        } catch (e) {
            wadah.innerHTML = "Gagal mengambil data.";
        }
    }

    function exportExcel() {
        const table = document.getElementById("tabelData");
        const wb = XLSX.utils.table_to_book(table, {sheet: "Rekap Tahfidz"});
        XLSX.writeFile(wb, `Rekap_Tahfidz_${new Date().getTime()}.xlsx`);
    }
</script>

</body>
</html>
