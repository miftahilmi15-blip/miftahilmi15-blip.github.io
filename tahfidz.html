<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SANTRI | Database Tahfidz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1f6f51; --bg: #f0f7f4; --accent: #eab308; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); padding: 15px; display: flex; justify-content: center; }
        .wadah { width: 100%; max-width: 450px; background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        header h1 { color: var(--primary); font-size: 20px; font-weight: 800; }
        
        .form-grup { margin-bottom: 15px; }
        label { font-size: 11px; font-weight: 700; color: #444; display: block; margin-bottom: 5px; text-transform: uppercase; }
        select, input, textarea { 
            width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #eee; 
            background: #f9f9f9; font-size: 14px; outline: none; transition: 0.3s;
        }
        select:focus, input:focus { border-color: var(--primary); background: #fff; }
        
        .grid-2 { display: flex; gap: 10px; }
        .rating { display: flex; gap: 8px; justify-content: center; background: #f9f9f9; padding: 10px; border-radius: 12px; }
        .star { cursor: pointer; font-size: 26px; color: #ddd; transition: 0.2s; }
        
        .btn-simpan { 
            width: 100%; background: var(--primary); color: white; border: none; 
            padding: 16px; border-radius: 15px; font-weight: 700; cursor: pointer; margin-top: 10px;
        }
        #loading { display: none; text-align: center; font-weight: 700; color: var(--primary); margin: 10px 0; }
    </style>
</head>
<body>

<div class="wadah">
    <header>
        <h1>CATAT TAHFIDZ</h1>
        <p style="font-size: 11px; color: #777;">Database Hafalan Otomatis</p>
    </header>

    <div class="form-grup">
        <label>Pilih Kelas</label>
        <select id="pilih-kelas">
            <option value="">-- Pilih Kelas --</option>
            <optgroup label="KELAS 7">
                <option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="7D">7D</option>
            </optgroup>
            <optgroup label="KELAS 8">
                <option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option><option value="8D">8D</option>
            </optgroup>
            <optgroup label="KELAS 9">
                <option value="9A">9A</option><option value="9B">9B</option><option value="9C">9C</option><option value="9D">9D</option>
            </optgroup>
        </select>
    </div>

    <div class="form-grup">
        <label>Nama Santri</label>
        <select id="pilih-santri">
            <option value="">-- Pilih Nama --</option>
            <option value="DUMMY">Nama akan muncul setelah pilih kelas</option>
        </select>
    </div>

    <div class="grid-2">
        <div class="form-grup" style="flex: 2;">
            <label>Surah</label>
            <select id="surah" onchange="isiJuzOtomatis()">
                <option value="">-- Pilih Surah --</option>
            </select>
        </div>
        <div class="form-grup" style="flex: 1;">
            <label>Juz</label>
            <input type="text" id="juz" readonly style="background: #ececec; text-align: center; font-weight: bold;">
        </div>
    </div>

    <div class="grid-2">
        <div class="form-grup">
            <label>Ayat Awal</label>
            <input type="number" id="ayat-awal" placeholder="1">
        </div>
        <div class="form-grup">
            <label>Ayat Akhir</label>
            <input type="number" id="ayat-akhir" placeholder="10">
        </div>
    </div>

    <div class="form-grup">
        <label>Status Progres</label>
        <select id="status-progres">
            <option value="Lulus">âœ… Lulus (Lanjut Hafalan Baru)</option>
            <option value="Sabaq">ðŸ”„ Sabaq (Mengulang Hafalan)</option>
        </select>
    </div>

    <div class="form-grup">
        <label>Kualitas Hafalan</label>
        <div class="rating">
            <span class="star" onclick="setStar(1)">â˜…</span>
            <span class="star" onclick="setStar(2)">â˜…</span>
            <span class="star" onclick="setStar(3)">â˜…</span>
            <span class="star" onclick="setStar(4)">â˜…</span>
            <span class="star" onclick="setStar(5)">â˜…</span>
        </div>
        <input type="hidden" id="nilai-bintang" value="0">
    </div>

    <div class="form-grup">
        <label>Catatan Ustadz</label>
        <textarea id="catatan" rows="2" placeholder="Tulis catatan makhraj/tajwid..."></textarea>
    </div>

    <div id="loading">Memproses...</div>
    <button class="btn-simpan" onclick="simpanTahfidz()">SIMPAN PENCAPAIAN</button>
</div>

<script>
    // URL Web App dari Google Apps Script Anda
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_FcWbbSpq49jYseGYQKUwN5YslFBRNIMMA5ZH0eZXr8NZY_TDtDU_jtXoesLk5oXf/exec";

    const alquran = [
        {n: "Al-Fatihah", j: 1}, {n: "Al-Baqarah", j: 1}, {n: "Ali 'Imran", j: 3}, {n: "An-Nisa'", j: 4}, {n: "Al-Ma'idah", j: 6}, {n: "Al-An'am", j: 7}, {n: "Al-A'raf", j: 8}, {n: "Al-Anfal", j: 9}, {n: "At-Taubah", j: 10}, {n: "Yunus", j: 11}, {n: "Hud", j: 11}, {n: "Yusuf", j: 12}, {n: "Ar-Ra'd", j: 13}, {n: "Ibrahim", j: 13}, {n: "Al-Hijr", j: 14}, {n: "An-Nahl", j: 14}, {n: "Al-Isra'", j: 15}, {n: "Al-Kahf", j: 15}, {n: "Maryam", j: 16}, {n: "Thaha", j: 16}, {n: "Al-Anbiya'", j: 17}, {n: "Al-Hajj", j: 17}, {n: "Al-Mu'minun", j: 18}, {n: "An-Nur", j: 18}, {n: "Al-Furqan", j: 18}, {n: "Asy-Syu'ara'", j: 19}, {n: "An-Naml", j: 19}, {n: "Al-Qashash", j: 20}, {n: "Al-'Ankabut", j: 20}, {n: "Ar-Rum", j: 21}, {n: "Luqman", j: 21}, {n: "As-Sajdah", j: 21}, {n: "Al-Ahzab", j: 21}, {n: "Saba'", j: 22}, {n: "Fathir", j: 22}, {n: "Yasin", j: 22}, {n: "Ash-Shaffat", j: 23}, {n: "Shad", j: 23}, {n: "Az-Zumar", j: 23}, {n: "Ghafir", j: 24}, {n: "Fushshilat", j: 24}, {n: "Asy-Syura", j: 25}, {n: "Az-Zukhruf", j: 25}, {n: "Ad-Dukhan", j: 25}, {n: "Al-Jatsiyah", j: 25}, {n: "Al-Ahqaf", j: 26}, {n: "Muhammad", j: 26}, {n: "Al-Fath", j: 26}, {n: "Al-Hujurat", j: 26}, {n: "Qaf", j: 26}, {n: "Adz-Dzariyat", j: 26}, {n: "Ath-Thur", j: 27}, {n: "An-Najm", j: 27}, {n: "Al-Qamar", j: 27}, {n: "Ar-Rahman", j: 27}, {n: "Al-Waqi'ah", j: 27}, {n: "Al-Hadid", j: 27}, {n: "Al-Mujadilah", j: 28}, {n: "Al-Hasyr", j: 28}, {n: "Al-Mumtahanah", j: 28}, {n: "Ash-Shaff", j: 28}, {n: "Al-Jumu'ah", j: 28}, {n: "Al-Munafiqun", j: 28}, {n: "At-Taghabun", j: 28}, {n: "Ath-Thalaq", j: 28}, {n: "At-Tahrim", j: 28}, {n: "Al-Mulk", j: 29}, {n: "Al-Qalam", j: 29}, {n: "Al-Haqqah", j: 29}, {n: "Al-Ma'arij", j: 29}, {n: "Nuh", j: 29}, {n: "Al-Jinn", j: 29}, {n: "Al-Muzzammil", j: 29}, {n: "Al-Muddatstsir", j: 29}, {n: "Al-Qiyamah", j: 29}, {n: "Al-Insan", j: 29}, {n: "Al-Mursalat", j: 29}, {n: "An-Naba'", j: 30}, {n: "An-Nazi'at", j: 30}, {n: "'Abasa", j: 30}, {n: "At-Takwir", j: 30}, {n: "Al-Infithar", j: 30}, {n: "Al-Muthaffifin", j: 30}, {n: "Al-Insyiqaq", j: 30}, {n: "Al-Buruj", j: 30}, {n: "Ath-Thariq", j: 30}, {n: "Al-A'la", j: 30}, {n: "Al-Ghasyiyah", j: 30}, {n: "Al-Fajr", j: 30}, {n: "Al-Balad", j: 30}, {n: "Asy-Syams", j: 30}, {n: "Al-Lail", j: 30}, {n: "Ad-Dhuha", j: 30}, {n: "Asy-Syarh", j: 30}, {n: "At-Tin", j: 30}, {n: "Al-'Alaq", j: 30}, {n: "Al-Qadr", j: 30}, {n: "Al-Bayyinah", j: 30}, {n: "Az-Zalzalah", j: 30}, {n: "Al-'Adiyat", j: 30}, {n: "Al-Qari'ah", j: 30}, {n: "At-Takatsur", j: 30}, {n: "Al-'Asr", j: 30}, {n: "Al-Humazah", j: 30}, {n: "Al-Fil", j: 30}, {n: "Quraisy", j: 30}, {n: "Al-Ma'un", j: 30}, {n: "Al-Kautsar", j: 30}, {n: "Al-Kafirun", j: 30}, {n: "An-Nashr", j: 30}, {n: "Al-Lahab", j: 30}, {n: "Al-Ikhlash", j: 30}, {n: "Al-Falaq", j: 30}, {n: "An-Nas", j: 30}
    ];

    // Isi Dropdown Surah
    const selSurah = document.getElementById('surah');
    alquran.forEach(s => {
        let opt = document.createElement('option');
        opt.value = s.n;
        opt.innerHTML = s.n;
        selSurah.appendChild(opt);
    });

    function isiJuzOtomatis() {
        const found = alquran.find(x => x.n === selSurah.value);
        document.getElementById('juz').value = found ? found.j : "";
    }

    function setStar(n) {
        document.getElementById('nilai-bintang').value = n;
        const stars = document.querySelectorAll('.star');
        stars.forEach((s, i) => s.style.color = i < n ? "#eab308" : "#ddd");
    }

    // Event Listener saat pilih kelas
    document.getElementById('pilih-kelas').addEventListener('change', function() {
        const kelas = this.value;
        const selectSantri = document.getElementById('pilih-santri');
        
        if (!kelas) return;

        selectSantri.innerHTML = '<option value="">-- Memuat Nama... --</option>';

        // Mengambil data santri dari Spreadsheet via Apps Script
        fetch(`${SCRIPT_URL}?action=getSantri&kelas=${kelas}`)
            .then(res => res.json())
            .then(data => {
                selectSantri.innerHTML = '<option value="">-- Pilih Nama --</option>';
                data.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s.nipd; // Simpan NIPD di value
                    opt.text = s.nama;  // Tampilkan Nama
                    selectSantri.appendChild(opt);
                });
            })
            .catch(err => {
                selectSantri.innerHTML = '<option value="">Gagal memuat data</option>';
                console.error(err);
            });
    });

    // Fungsi Simpan ke Spreadsheet
    async function simpanTahfidz() {
        const btn = document.querySelector('.btn-simpan');
        const loading = document.getElementById('loading');
        
        const payload = {
            nipd: document.getElementById('pilih-santri').value,
            nama: document.getElementById('pilih-santri').options[document.getElementById('pilih-santri').selectedIndex].text,
            kelas: document.getElementById('pilih-kelas').value,
            surah: document.getElementById('surah').value,
            juz: document.getElementById('juz').value,
            ayat: document.getElementById('ayat-awal').value + "-" + document.getElementById('ayat-akhir').value,
            status: document.getElementById('status-progres').value,
            nilai: document.getElementById('nilai-bintang').value,
            catatan: document.getElementById('catatan').value
        };

        // Validasi sederhana
        if(!payload.nipd || !payload.surah || payload.nilai == "0") {
            return alert("Mohon lengkapi Nama, Surah, dan Nilai Bintang!");
        }

        loading.style.display = "block";
        btn.disabled = true;

        try {
            await fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", // Gunakan no-cors untuk Web App GAS
                body: JSON.stringify(payload),
                headers: { "Content-Type": "application/json" }
            });
            
            alert("âœ… Data Hafalan Berhasil Disimpan!");
            // Reset Form
            document.getElementById('ayat-awal').value = "";
            document.getElementById('ayat-akhir').value = "";
            document.getElementById('catatan').value = "";
            setStar(0);
        } catch (error) {
            alert("Terjadi kesalahan saat menyimpan.");
            console.error(error);
        } finally {
            loading.style.display = "none";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
