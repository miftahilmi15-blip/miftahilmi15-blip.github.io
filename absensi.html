<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>E-Santri Pro v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f1f5f9; --primary: #10b981; --primary-dark: #059669; --hadir: #22c55e; --sakit: #f59e0b; --izin: #3b82f6; --alpha: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #1e293b; padding-bottom: 100px; }
        .app-header { background: white; padding: 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; text-align: center;}
        .app-title { font-size: 18px; font-weight: 800; color: var(--primary-dark); letter-spacing: -0.5px; }
        .card-controls { background: white; padding: 15px; margin: 15px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        select, .search-box { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #e2e8f0; font-size: 14px; margin-top: 10px; outline: none; }
        .santri-item { background: white; border-radius: 16px; padding: 15px; margin: 0 15px 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }
        .btn-st { width: 40px; height: 40px; border-radius: 10px; border: 1.5px solid #f1f5f9; background: #f8fafc; font-weight: 700; color: #cbd5e1; cursor: pointer; }
        .h-active { background: var(--hadir)!important; color: white!important; border: none; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
        .s-active { background: var(--sakit)!important; color: white!important; border: none; }
        .i-active { background: var(--izin)!important; color: white!important; border: none; }
        .a-active { background: var(--alpha)!important; color: white!important; border: none; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; gap: 10px; border-top: 1px solid #e2e8f0; }
        .btn-save { flex: 1; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 700; }
        #overlay { display: none; position: fixed; inset: 0; background: white; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--primary); border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    </style>
</head>
<body>

<div id="overlay">
    <span class="loader"></span>
    <h3 id="msg" style="margin-top: 20px; color: #1e293b;">Memproses Absen...</h3>
</div>

<div class="app-header">
    <div class="app-title">E-SANTRI SYSTEM v4</div>
</div>

<div class="card-controls">
    <label style="font-size: 11px; font-weight: 700; color: #94a3b8;">PILIH KELAS</label>
    <select id="kls">
        <option value="">-- Pilih --</option>
        <option value="7A">7A</option><option value="7B">7B</option><option value="8A">8A</option><option value="8B">8B</option><option value="9A">9A</option><option value="9B">9B</option>
    </select>
    <input type="text" id="cari" class="search-box" placeholder="Cari nama..." onkeyup="filter()">
</div>

<div id="list"></div>

<div class="footer">
    <button class="btn-save" onclick="simpan()">ðŸ’¾ SIMPAN PERUBAHAN</button>
</div>

<script>
    // 1. GANTI URL INI DENGAN URL WEB APP GOOGLE ANDA (PASTIKAN SUDAH NEW DEPLOYMENT)
    const SCRIPT_URL = "MASUKKAN_URL_SCRIPT_BARU_DI_SINI";

    // FUNGSI UTAMA NFC (LANGSUNG JALAN)
    (function checkNFC() {
        const p = new URLSearchParams(window.location.search);
        const id = p.get('scan');
        const kls = p.get('kls');

        if (id && kls) {
            document.getElementById('overlay').style.display = 'flex';
            const payload = JSON.stringify([{ kelas: kls, nipd: id, status: 'H' }]);
            
            // Gunakan fetch dengan mode: 'no-cors' agar tidak diblokir browser
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: payload
            }).then(() => {
                document.getElementById('msg').innerText = "âœ… BERHASIL DICATAT";
                setTimeout(() => location.href = "index.html", 1500);
            }).catch(() => {
                alert("Gagal koneksi ke server!");
                document.getElementById('overlay').style.display = 'none';
            });
        }
    })();

    // LOAD DATA MANUAL
    document.getElementById('kls').onchange = function() {
        if(!this.value) return;
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('msg').innerText = "Mengambil Nama...";
        const s = document.createElement('script');
        s.src = `${SCRIPT_URL}?kelas=${this.value}&callback=render`;
        document.body.appendChild(s);
    };

    function render(data) {
        document.getElementById('overlay').style.display = 'none';
        const cont = document.getElementById('list');
        cont.innerHTML = '';
        if(data.error) { alert(data.error); return; }
        
        data.forEach(x => {
            const d = document.createElement('div');
            d.className = 'santri-item';
            d.innerHTML = `
                <div><b style="font-size:14px;">${x.nama}</b><br><small style="color:#94a3b8">${x.nipd}</small></div>
                <div class="btn-group" data-nipd="${x.nipd}" data-nama="${x.nama}">
                    <button class="btn-st" onclick="st(this,'H')">H</button>
                    <button class="btn-st" onclick="st(this,'S')">S</button>
                    <button class="btn-st" onclick="st(this,'I')">I</button>
                    <button class="btn-st" onclick="st(this,'A')">A</button>
                </div>`;
            cont.appendChild(d);
        });
    }

    function st(btn, s) {
        btn.parentElement.querySelectorAll('button').forEach(b => b.className = 'btn-st');
        const c = {H:'h-active',S:'s-active',I:'i-active',A:'a-active'};
        btn.classList.add(c[s]); 
        btn.setAttribute('data-s', s);
    }

    async function simpan() {
        const k = document.getElementById('kls').value;
        const res = [];
        document.querySelectorAll('.btn-group').forEach(g => {
            const s = g.querySelector('[data-s]');
            if(s) res.push({ kelas: k, nipd: g.dataset.nipd, nama: g.dataset.nama, status: s.getAttribute('data-s') });
        });
        if(!res.length) return alert("Belum ada data yang dipilih!");
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('msg').innerText = "Menyimpan...";
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(res) });
            alert("âœ… Berhasil disimpan!");
            location.reload();
        } catch(e) { alert("Gagal Simpan!"); }
    }

    function filter() {
        const v = document.getElementById('cari').value.toLowerCase();
        document.querySelectorAll('.santri-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(v) ? 'flex' : 'none');
    }
</script>
</body>
</html>
