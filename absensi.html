<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Digital - SMP Al-Irsyad</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1f6f51; --h: #22c55e; --s: #eab308; --i: #3b82f6; --a: #ef4444; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f4f7f6; padding: 20px; color: #334155; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        header { text-align: center; margin-bottom: 25px; }
        .toolbar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #e2e8f0; align-items: end; }
        select, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-weight: 600; cursor: pointer; }
        .btn-sync { background: #3b82f6; color: white; border: none; }
        .btn-save { background: var(--primary); color: white; border: none; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { padding: 10px; border-radius: 10px; color: white; text-align: center; font-size: 0.8rem; }
        .table-wraper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f1f5f9; padding: 15px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        .status-btn-group { display: flex; justify-content: center; gap: 5px; }
        .btn-st { width: 35px; height: 35px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: bold; color: #94a3b8; }
        .btn-st.active-h { background: var(--h); color: white; border-color: var(--h); }
        .btn-st.active-s { background: var(--s); color: white; border-color: var(--s); }
        .btn-st.active-i { background: var(--i); color: white; border-color: var(--i); }
        .btn-st.active-a { background: var(--a); color: white; border-color: var(--a); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2 style="color: var(--primary)">ABSENSI SMP AL-IRSYAD</h2>
        <p id="current-date" style="font-weight: 600; color: #64748b;"></p>
    </header>

    <div class="toolbar">
        <div>
            <label style="font-size: 0.7rem; font-weight: bold;">1. DATABASE</label>
            <button onclick="document.getElementById('manual-file').click()" class="btn-sync">ðŸ”„ Muat santri.xlsx</button>
            <input type="file" id="manual-file" style="display:none" accept=".xlsx">
        </div>
        <div>
            <label style="font-size: 0.7rem; font-weight: bold;">2. PILIH KELAS</label>
            <select id="kelas-select">
                <option value="">-- Unggah File Dulu --</option>
            </select>
        </div>
        <div>
            <label style="font-size: 0.7rem; font-weight: bold;">3. HASIL</label>
            <button id="export-btn" class="btn-save">ðŸ’¾ Export Rekap</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card" style="background: var(--h)">Hadir: <span id="count-h">0</span></div>
        <div class="stat-card" style="background: var(--s)">Sakit: <span id="count-s">0</span></div>
        <div class="stat-card" style="background: var(--i)">Izin: <span id="count-i">0</span></div>
        <div class="stat-card" style="background: var(--a)">Alpha: <span id="count-a">0</span></div>
    </div>

    <div class="table-wraper">
        <table id="absensi-table">
            <thead>
                <tr>
                    <th>NO</th>
                    <th>NIPD</th>
                    <th>NAMA SANTRI</th>
                    <th>JK</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="padding:40px; color:#999;">Gunakan tombol "Muat santri.xlsx" di atas</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let allStudentsData = {}; // Objek untuk menyimpan data 7A, 7B, 7C, 7D
    const kelasSelect = document.getElementById('kelas-select');
    const tableBody = document.querySelector('#absensi-table tbody');

    document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

    // Handle File Upload Manual (Karena file Anda kompleks)
    document.getElementById('manual-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Ambil sheet pertama (DATA SISWA)
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            // PEMETAAN KOLOM (Berdasarkan file Anda)
            // 7A: Kolom A-E | 7B: Kolom H-L | 7C: Kolom O-S | 7D: Kolom V-Z
            const config = {
                "7A": { start: 0 },
                "7B": { start: 7 },
                "7C": { start: 14 },
                "7D": { start: 21 }
            };

            allStudentsData = {};
            kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';

            Object.keys(config).forEach(kls => {
                const col = config[kls].start;
                allStudentsData[kls] = [];
                
                // Mulai baris ke-6 (index 5)
                for (let i = 5; i < raw.length; i++) {
                    const row = raw[i];
                    if (row && row[col + 3]) { // Jika ada nama di kolom NAMA
                        allStudentsData[kls].push({
                            no: row[col],
                            nipd: row[col + 1],
                            nama: row[col + 3],
                            jk: row[col + 4]
                        });
                    }
                }
                if (allStudentsData[kls].length > 0) {
                    kelasSelect.add(new Option("Kelas " + kls, kls));
                }
            });
            alert("Berhasil memproses data santri menyamping.");
        };
        reader.readAsArrayBuffer(file);
    });

    kelasSelect.addEventListener('change', (e) => {
        const kls = e.target.value;
        if (!kls) return;

        tableBody.innerHTML = '';
        allStudentsData[kls].forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${s.no || '-'}</td>
                <td>${s.nipd || '-'}</td>
                <td style="text-align:left; font-weight:bold;">${s.nama}</td>
                <td>${s.jk || '-'}</td>
                <td>
                    <div class="status-btn-group">
                        <button class="btn-st" onclick="setStatus(this, 'H')">H</button>
                        <button class="btn-st" onclick="setStatus(this, 'S')">S</button>
                        <button class="btn-st" onclick="setStatus(this, 'I')">I</button>
                        <button class="btn-st" onclick="setStatus(this, 'A')">A</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(tr);
        });
        resetStats();
    });

    function setStatus(btn, code) {
        btn.parentElement.querySelectorAll('.btn-st').forEach(b => b.className = 'btn-st');
        const cls = { 'H': 'active-h', 'S': 'active-s', 'I': 'active-i', 'A': 'active-a' };
        btn.classList.add(cls[code]);
        btn.setAttribute('data-selected', code);
        updateStats();
    }

    function updateStats() {
        const counts = { 'H': 0, 'S': 0, 'I': 0, 'A': 0 };
        document.querySelectorAll('.btn-st[data-selected]').forEach(btn => counts[btn.getAttribute('data-selected')]++);
        document.getElementById('count-h').textContent = counts['H'];
        document.getElementById('count-s').textContent = counts['S'];
        document.getElementById('count-i').textContent = counts['I'];
        document.getElementById('count-a').textContent = counts['A'];
    }

    function resetStats() {
        ['h','s','i','a'].forEach(k => document.getElementById('count-'+k).textContent = '0');
    }

    document.getElementById('export-btn').addEventListener('click', () => {
        const rows = document.querySelectorAll('#absensi-table tbody tr');
        if (rows.length < 1 || !kelasSelect.value) return alert("Pilih kelas dulu!");

        const data = [['REKAP ABSENSI'], ['Kelas:', kelasSelect.value], [], ['NO', 'NIPD', 'NAMA', 'JK', 'KET']];
        rows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            const sel = tr.querySelector('.btn-st[data-selected]');
            data.push([cells[0].innerText, cells[1].innerText, cells[2].innerText, cells[3].innerText, sel ? sel.getAttribute('data-selected') : '-']);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Rekap");
        XLSX.writeFile(wb, `Absensi_${kelasSelect.value}.xlsx`);
    });
</script>
</body>
</html>
