<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>E-Santri Pro | Absensi</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
--bg:#f8fafc;--card:#fff;--primary:#10b981;--dark:#059669;
--hadir:#22c55e;--sakit:#f59e0b;--izin:#3b82f6;--alpha:#ef4444;
--text:#1e293b;--sub:#64748b
}
*{box-sizing:border-box;font-family:'Plus Jakarta Sans',sans-serif}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:90px}

header{background:var(--card);padding:20px;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:9}
h1{margin:0;font-size:18px;color:var(--dark)}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.box{background:#f1f5f9;padding:10px;border-radius:12px;text-align:center}
.box small{font-size:11px;color:var(--sub)}
.box b{font-size:16px}

.controls{background:#fff;padding:15px;border-bottom:1px solid #e2e8f0}
select,input{width:100%;padding:14px;border-radius:14px;border:1.5px solid #e2e8f0;margin-top:10px}

.list{padding:15px}
.item{background:#fff;border-radius:16px;padding:14px;margin-bottom:10px;
display:flex;justify-content:space-between;align-items:center;border:1px solid #f1f5f9}

.info b{display:block;font-size:14px}
.info small{color:var(--sub)}

.btns{display:flex;gap:6px}
.btn{width:38px;height:38px;border-radius:10px;border:1px solid #e2e8f0;
background:#fff;font-weight:700;color:#cbd5e1}
.h{background:var(--hadir);color:#fff}
.s{background:var(--sakit);color:#fff}
.i{background:var(--izin);color:#fff}
.a{background:var(--alpha);color:#fff}

footer{position:fixed;bottom:0;left:0;right:0;
background:rgba(255,255,255,.9);backdrop-filter:blur(10px);
padding:15px;display:grid;grid-template-columns:80px 1fr;gap:10px}
footer button{border-radius:14px;border:none;font-weight:700}
.save{background:var(--primary);color:#fff}
.circle{background:#fff;border:1px solid #e2e8f0}

#overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.8);
color:#fff;z-index:99;align-items:center;justify-content:center;flex-direction:column}
</style>
</head>
<body>

<div id="overlay"><h3 id="msg">Memproses...</h3></div>

<header>
<h1>ðŸŸ¢ E-SANTRI PRO</h1>
<div class="stats">
<div class="box"><small>Total</small><b id="total">0</b></div>
<div class="box"><small>Absen</small><b id="done" style="color:var(--primary)">0</b></div>
</div>
</header>

<div class="controls">
<select id="kelas">
<option value="">Pilih Kelas</option>
<option>7A</option><option>7B</option><option>7C</option>
<option>8A</option><option>8B</option>
<option>9A</option>
</select>
<input id="cari" placeholder="Cari santri..." onkeyup="filter()">
</div>

<div id="list" class="list">
<p style="text-align:center;color:#94a3b8">Pilih kelas dulu</p>
</div>

<footer>
<button class="circle" onclick="download()">ðŸ“¥</button>
<button class="save" onclick="simpan()">SIMPAN</button>
</footer>

<!-- ðŸ”Š AUDIO -->
<audio id="ok" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
<audio id="dup" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzalHnTb_U4l3yCvJ2yf2E31-nkh29GuKvX5jkUqL-cnV6202XSjZ1_fSm9r0CeCVY4Dg/exec";

/* ðŸ”Š SOUND */
const ok=()=>{const a=document.getElementById("ok");a.currentTime=0;a.play()}
const dup=()=>{const a=document.getElementById("dup");a.currentTime=0;a.play()}

/* NFC AUTO */
window.onload=()=>{
const p=new URLSearchParams(location.search)
let scan=p.get("scan")
const kelas=p.get("kls")
if(!scan||!kelas)return

if(scan.includes("http")){
scan=new URL(scan).searchParams.get("scan")
}
show("ðŸ“² NFC TERDETEKSI");ok()

fetch(SCRIPT_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify([{kelas,nipd:scan,status:"H",method:"NFC"}])
})
.then(r=>r.json())
.then(r=>{
if(r.status==="ALREADY"){msg("âš ï¸ SUDAH ABSEN");dup()}
else{msg("âœ… ABSEN BERHASIL");ok()}
setTimeout(()=>location.href=location.pathname,700)
})
.catch(()=>msg("âŒ GAGAL"))
}

/* LOAD KELAS */
kelas.onchange=()=>{
show("Memuat...")
const s=document.createElement("script")
s.src=`${SCRIPT_URL}?kelas=${kelas.value}&callback=render`
document.body.appendChild(s)
}

/* RENDER */
function render(d){
hide()
list.innerHTML=""
total.innerText=d.length
d.forEach(x=>{
list.innerHTML+=`
<div class="item">
<div class="info"><b>${x.nama}</b><small>${x.nipd}</small></div>
<div class="btns" data-n="${x.nipd}" data-nama="${x.nama}">
<button class="btn" onclick="st(this,'H')">H</button>
<button class="btn" onclick="st(this,'S')">S</button>
<button class="btn" onclick="st(this,'I')">I</button>
<button class="btn" onclick="st(this,'A')">A</button>
</div></div>`
})
}

/* STATUS */
function st(b,s){
b.parentElement.querySelectorAll("button").forEach(x=>x.className="btn")
b.classList.add(s.toLowerCase())
b.dataset.s=s
done.innerText=document.querySelectorAll("[data-s]").length
}

/* SIMPAN */
function simpan(){
const data=[]
document.querySelectorAll(".btns").forEach(b=>{
const s=b.querySelector("[data-s]")
if(s)data.push({kelas:kelas.value,nipd:b.dataset.n,nama:b.dataset.nama,status:s.dataset.s})
})
if(!data.length)return alert("Belum ada")
show("Menyimpan");ok()
fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)})
.then(()=>msg("âœ… TERSIMPAN"))
}

/* UTIL */
const show=t=>{overlay.style.display="flex";msg(t)}
const msg=t=>document.getElementById("msg").innerText=t
const hide=()=>overlay.style.display="none"
const filter=()=>{
const v=cari.value.toLowerCase()
document.querySelectorAll(".item").forEach(i=>{
i.style.display=i.innerText.toLowerCase().includes(v)?"flex":"none"
})
}
const download=()=>open(SCRIPT_URL+"?action=download","_blank")
</script>
</body>
</html> <button class="btn-st" onclick="st(this,'I')">I</button>
                <button class="btn-st" onclick="st(this,'A')">A</button>
            </div>`;
        list.appendChild(div);
    });
}

function st(btn, s) {
    btn.parentElement.querySelectorAll('button').forEach(b => b.className = 'btn-st');
    const c = { H:'h-active', S:'s-active', I:'i-active', A:'a-active' };
    btn.classList.add(c[s]);
    btn.setAttribute('data-s', s);
    document.getElementById('count-absen').innerText =
        document.querySelectorAll('[data-s]').length;
}

async function simpan() {
    const k = document.getElementById('kls').value;
    const data = [];
    document.querySelectorAll('.btn-group').forEach(g => {
        const s = g.querySelector('[data-s]');
        if (s) data.push({
            kelas: k,
            nipd: g.dataset.nipd,
            nama: g.dataset.nama,
            status: s.getAttribute('data-s')
        });
    });

    if (!data.length) return alert("Belum ada yang diabsen");

    showOverlay("Menyimpan...");
    await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(data)
    });

    document.getElementById('msg').innerText = "âœ… ABSEN BERHASIL!";
bunyiBerhasil();
}

function download() {
    window.open(SCRIPT_URL + "?action=download", "_blank");
}
function showOverlay(t) {
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('msg').innerText = t;
}
function hideOverlay() {
    document.getElementById('overlay').style.display = 'none';
}
function filter() {
    const v = document.getElementById('cari').value.toLowerCase();
    document.querySelectorAll('.santri-item').forEach(i => {
        i.style.display = i.innerText.toLowerCase().includes(v) ? 'flex' : 'none';
    });
}
</script>
</body>
</html>
