let workbookData = null;
const kelasSelect = document.getElementById('kelas-select');
const tableBody = document.querySelector('#absensi-table tbody');

document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

// 1. FUNGSI UTAMA: Membaca SEMUA Sheet dari santri.xlsx
async function loadSantriData() {
    const loadingMsg = document.getElementById('loading-msg');
    loadingMsg.style.display = 'block';
    
    try {
        // Tambahkan random parameter agar tidak terkena Cache browser
        const response = await fetch('santri.xlsx?v=' + Math.random());
        
        if (!response.ok) {
            throw new Error("File tidak terbaca otomatis");
        }
        
        const data = await response.arrayBuffer();
        prosesWorkbook(data);
        console.log("Database berhasil dimuat otomatis.");
        
    } catch (err) {
        console.warn("Gagal muat otomatis (CORS/File Not Found). Silakan gunakan tombol manual.");
        // Jika gagal otomatis, kita sediakan input manual sebagai cadangan di konsol
        let inputManual = document.createElement('input');
        inputManual.type = 'file';
        inputManual.accept = '.xlsx';
        inputManual.style.display = 'none';
        inputManual.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => prosesWorkbook(evt.target.result);
            reader.readAsArrayBuffer(file);
        };
        // Trigger manual jika otomatis gagal
        alert("Browser memblokir akses file otomatis. Silakan pilih file 'santri.xlsx' secara manual melalui jendela yang akan muncul.");
        inputManual.click();
    } finally {
        loadingMsg.style.display = 'none';
    }
}

// 2. Fungsi memproses data Workbook (Mendeteksi Semua Kelas)
function prosesWorkbook(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    workbookData = workbook;

    // Kosongkan dropdown
    kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
    
    // Ambil SEMUA sheet tanpa terkecuali
    if (workbook.SheetNames.length === 0) {
        alert("File Excel kosong atau tidak memiliki Sheet!");
        return;
    }

    workbook.SheetNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = "Kelas " + name; // Menambahkan kata 'Kelas' agar rapi
        kelasSelect.appendChild(opt);
    });

    alert("Berhasil memuat " + workbook.SheetNames.length + " Kelas.");
}

// 3. Render Santri saat Kelas dipilih
kelasSelect.addEventListener('change', e => {
    const sheetName = e.target.value;
    if (!sheetName) return;

    const sheet = workbookData.Sheets[sheetName];
    // Pastikan membaca dari baris yang benar (Header di baris 1-3, data mulai baris 4)
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    
    tableBody.innerHTML = '';
    
    // Looping data santri mulai dari index 3 (Baris 4 di Excel)
    let jmlSantri = 0;
    for (let i = 3; i < data.length; i++) {
        const row = data[i];
        if (!row || !row[2]) continue; // Lewati jika baris kosong atau Nama tidak ada

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row[0] || (i - 2)}</td>
            <td>${row[1] || '-'}</td>
            <td style="text-align:left; font-weight:600;">${row[2]}</td>
            <td>${row[3] || '-'}</td>
            <td>
                <div class="status-btn-group">
                    <button class="btn-st" onclick="setStatus(this, 'H')">H</button>
                    <button class="btn-st" onclick="setStatus(this, 'S')">S</button>
                    <button class="btn-st" onclick="setStatus(this, 'I')">I</button>
                    <button class="btn-st" onclick="setStatus(this, 'A')">A</button>
                </div>
            </td>
        `;
        tableBody.appendChild(tr);
        jmlSantri++;
    }
    
    if(jmlSantri === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="padding:20px;">Tidak ada data santri di sheet ini (Pastikan data mulai di Baris 4)</td></tr>';
    }
    
    resetStats();
});

// Fungsi pembantu lainnya tetap sama...
function setStatus(btn, code) {
    const group = btn.parentElement;
    group.querySelectorAll('.btn-st').forEach(b => b.className = 'btn-st');
    const cls = { 'H': 'active-h', 'S': 'active-s', 'I': 'active-i', 'A': 'active-a' };
    btn.classList.add(cls[code]);
    btn.setAttribute('data-selected', code);
    if (navigator.vibrate) navigator.vibrate(20);
    updateStats();
}

function updateStats() {
    const counts = { 'H': 0, 'S': 0, 'I': 0, 'A': 0 };
    document.querySelectorAll('.btn-st[data-selected]').forEach(btn => {
        counts[btn.getAttribute('data-selected')]++;
    });
    document.getElementById('count-h').textContent = counts['H'];
    document.getElementById('count-s').textContent = counts['S'];
    document.getElementById('count-i').textContent = counts['I'];
    document.getElementById('count-a').textContent = counts['A'];
}

function resetStats() {
    ['h','s','i','a'].forEach(k => document.getElementById(`count-${k}`).textContent = '0');
}

// Jalankan otomatis saat web dibuka
window.onload = loadSantriData;
