<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Digital - SMP Al-Irsyad</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1f6f51;
            --secondary: #16503a;
            --bg: #f8fafc;
            --white: #ffffff;
            --h: #22c55e; --s: #eab308; --i: #3b82f6; --a: #ef4444;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #334155; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        header { text-align: center; margin-bottom: 30px; }
        h2 { color: var(--primary); margin-bottom: 5px; }
        .info-date { font-weight: 600; color: #64748b; }

        .toolbar { display: flex; flex-wrap: wrap; gap: 15px; background: #f1f5f9; padding: 20px; border-radius: 12px; margin-bottom: 25px; align-items: center; }
        
        .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { flex: 1; padding: 15px; border-radius: 12px; color: white; text-align: center; min-width: 120px; }
        
        select { border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; outline: none; background: white; min-width: 200px; }
        button { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-sync { background: #3b82f6; color: white; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        th { background: #f8fafc; color: #475569; padding: 15px; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

        .status-btn-group { display: flex; justify-content: center; gap: 5px; }
        .btn-st { width: 35px; height: 35px; border-radius: 8px; border: 2px solid #e2e8f0; background: white; cursor: pointer; font-weight: bold; transition: 0.2s; color: #94a3b8; }
        .btn-st.active-h { background: var(--h); color: white; border-color: var(--h); }
        .btn-st.active-s { background: var(--s); color: white; border-color: var(--s); }
        .btn-st.active-i { background: var(--i); color: white; border-color: var(--i); }
        .btn-st.active-a { background: var(--a); color: white; border-color: var(--a); }

        .loading-overlay { display: none; color: var(--primary); font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>ABSENSI SANTRI SMP AL-IRSYAD</h2>
        <p class="info-date" id="current-date"></p>
    </header>

    <div class="toolbar">
        <div style="display:flex; flex-direction:column;">
            <label style="font-size:0.75rem; font-weight:bold; margin-bottom:5px;">Data Sumber: <b>santri.xlsx</b></label>
            <button onclick="loadSantriData()" class="btn-sync">ðŸ”„ Muat Ulang Database</button>
        </div>
        <div style="display:flex; flex-direction:column;">
            <label style="font-size:0.75rem; font-weight:bold; margin-bottom:5px;">Pilih Kelas</label>
            <select id="kelas-select">
                <option value="">-- Menunggu Data --</option>
            </select>
        </div>
        <div style="margin-left:auto; display:flex; gap:10px; align-items: flex-end;">
            <button id="export-btn" class="btn-save">ðŸ’¾ Export Rekap Excel</button>
        </div>
    </div>

    <div id="loading-msg" class="loading-overlay">Sedang membaca santri.xlsx...</div>

    <div class="stats">
        <div class="stat-card" style="background: var(--h)">Hadir: <span id="count-h">0</span></div>
        <div class="stat-card" style="background: var(--s)">Sakit: <span id="count-s">0</span></div>
        <div class="stat-card" style="background: var(--i)">Izin: <span id="count-i">0</span></div>
        <div class="stat-card" style="background: var(--a)">Alpha: <span id="count-a">0</span></div>
    </div>

    <table id="absensi-table">
        <thead>
            <tr>
                <th width="50">NO</th>
                <th width="120">NIPD</th>
                <th>NAMA SANTRI</th>
                <th width="80">JK</th>
                <th width="200">STATUS (H/S/I/A)</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" style="padding:40px; color:#94a3b8;">Klik "Muat Ulang Database" untuk memulai...</td></tr>
        </tbody>
    </table>
</div>

<script>
let workbookData = null;
const kelasSelect = document.getElementById('kelas-select');
const tableBody = document.querySelector('#absensi-table tbody');
const loadingMsg = document.getElementById('loading-msg');

document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

// 1. Fungsi Mengambil file santri.xlsx secara otomatis
async function loadSantriData() {
    loadingMsg.style.display = 'block';
    try {
        const response = await fetch('santri.xlsx');
        if (!response.ok) throw new Error("File santri.xlsx tidak ditemukan di root folder.");
        
        const data = await response.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        workbookData = workbook;

        kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        workbook.SheetNames.forEach(sheet => {
            const option = new Option(sheet, sheet);
            kelasSelect.add(option);
        });
        alert("Database Santri Berhasil Dimuat!");
    } catch (error) {
        alert("Error: " + error.message);
    } finally {
        loadingMsg.style.display = 'none';
    }
}

// 2. Tampilkan Santri saat Kelas dipilih
kelasSelect.addEventListener('change', e => {
    const sheetName = e.target.value;
    if (!sheetName || !workbookData) return;

    const worksheet = workbookData.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    tableBody.innerHTML = '';

    // Asumsi: Baris 1-3 Header, Baris 4 Data (Index 3)
    for (let i = 3; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row[2]) continue;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row[0] || i-2}</td>
            <td>${row[1] || '-'}</td>
            <td style="text-align:left; font-weight:600;">${row[2]}</td>
            <td>${row[3] || '-'}</td>
            <td>
                <div class="status-btn-group">
                    <button class="btn-st" onclick="setStatus(this, 'H')">H</button>
                    <button class="btn-st" onclick="setStatus(this, 'S')">S</button>
                    <button class="btn-st" onclick="setStatus(this, 'I')">I</button>
                    <button class="btn-st" onclick="setStatus(this, 'A')">A</button>
                </div>
            </td>
        `;
        tableBody.appendChild(tr);
    }
    resetStats();
});

function setStatus(btn, code) {
    const group = btn.parentElement;
    group.querySelectorAll('.btn-st').forEach(b => b.className = 'btn-st');
    const colors = { 'H': 'active-h', 'S': 'active-s', 'I': 'active-i', 'A': 'active-a' };
    btn.classList.add(colors[code]);
    btn.setAttribute('data-selected', code);
    updateStats();
}

function updateStats() {
    const counts = { 'H': 0, 'S': 0, 'I': 0, 'A': 0 };
    document.querySelectorAll('.btn-st[data-selected]').forEach(btn => counts[btn.getAttribute('data-selected')]++);
    document.getElementById('count-h').textContent = counts['H'];
    document.getElementById('count-s').textContent = counts['S'];
    document.getElementById('count-i').textContent = counts['I'];
    document.getElementById('count-a').textContent = counts['A'];
}

function resetStats() {
    document.getElementById('count-h').textContent = '0';
    document.getElementById('count-s').textContent = '0';
    document.getElementById('count-i').textContent = '0';
    document.getElementById('count-a').textContent = '0';
}

document.getElementById('export-btn').addEventListener('click', () => {
    const rows = document.querySelectorAll('#absensi-table tbody tr');
    if (rows.length < 1 || !kelasSelect.value) return alert("Pilih kelas dan isi absen dulu!");

    const exportData = [['REKAP ABSENSI SMP AL-IRSYAD'], ['Kelas:', kelasSelect.value], ['Tanggal:', document.getElementById('current-date').textContent], [], ['NO', 'NIPD', 'NAMA SANTRI', 'JK', 'KET']];
    
    rows.forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const selected = tr.querySelector('.btn-st[data-selected]');
        exportData.push([cells[0].innerText, cells[1].innerText, cells[2].innerText, cells[3].innerText, selected ? selected.getAttribute('data-selected') : '-']);
    });

    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Rekap");
    XLSX.writeFile(wb, `Absensi_${kelasSelect.value}_${new Date().toLocaleDateString()}.xlsx`);
});

// Load otomatis saat halaman dibuka
window.onload = loadSantriData;
</script>
</body>
</html>
