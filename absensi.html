<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>E-Santri Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --bg: #f8fafc; --text: #1e293b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 100px; }
        header { background: #fff; padding: 20px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
        .controls { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        .list { padding: 15px; }
        .item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btns { display: flex; gap: 5px; }
        .btns button { width: 35px; height: 35px; border-radius: 8px; border: 1px solid #eee; background: #fff; font-weight: bold; cursor: pointer; }
        .h-active { background: #22c55e !important; color: #fff; }
        .s-active { background: #f59e0b !important; color: #fff; }
        .i-active { background: #3b82f6 !important; color: #fff; }
        .a-active { background: #ef4444 !important; color: #fff; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="overlay"><div class="spinner"></div><p id="loadingText">Mohon Tunggu...</p></div>

<header>
    <h2 style="color:var(--primary)">ðŸŸ¢ E-SANTRI PRO</h2>
    <div class="controls">
        <select id="kelas">
            <option value="">-- Pilih Kelas --</option>
            <option value="7A">Kelas 7A</option><option value="7B">Kelas 7B</option>
            <option value="7C">Kelas 7C</option><option value="7D">Kelas 7D</option>
            <option value="8A">Kelas 8A</option><option value="8B">Kelas 8B</option>
            <option value="8C">Kelas 8C</option><option value="8D">Kelas 8D</option>
            <option value="9A">Kelas 9A</option><option value="9B">Kelas 9B</option>
            <option value="9C">Kelas 9C</option><option value="9D">Kelas 9D</option>
        </select>
        <input id="scan" placeholder="Ketik NIPD / Scan Kartu..." autofocus>
    </div>
</header>

<div id="list" class="list"></div>

<div class="footer">
    <input type="checkbox" id="selectAll" style="width:20px; height:20px;"> <label for="selectAll">Semua</label>
    <button onclick="simpan()" style="flex:1; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:10px; font-weight:bold;">SIMPAN ABSENSI</button>
</div>

<audio id="snd_ok" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

<script>
// URL WEB APP DARI GOOGLE APPS SCRIPT
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby24AOA1v7cB6g2oL6rbLOh3Ijhn-9dZdrRu5hdF1NrnL3VoBp4BSPsn71HL-h_4qpMCA/exec";

const kelasSelect = document.getElementById('kelas');
const list = document.getElementById('list');
const overlay = document.getElementById('overlay');
const loadingText = document.getElementById('loadingText');
const scanInput = document.getElementById('scan');

// Fungsi pembantu untuk menampilkan loading
function showLoading(text) {
    loadingText.innerText = text;
    overlay.style.display = 'flex';
}

// 1. FUNGSI LOAD DATA
kelasSelect.onchange = () => {
    if(!kelasSelect.value) return;
    showLoading("Memuat Siswa...");
    
    const oldScript = document.getElementById('jsonp');
    if(oldScript) oldScript.remove();

    const s = document.createElement('script');
    s.id = 'jsonp';
    s.src = `${SCRIPT_URL}?kelas=${kelasSelect.value}&callback=handleData`;
    document.body.appendChild(s);
};

window.handleData = (res) => {
    overlay.style.display = 'none';
    if(res.error) return alert(res.error);
    render(res.data);
};

function render(data) {
    list.innerHTML = data.length ? '' : 'Siswa tidak ditemukan.';
    data.forEach(x => {
        const div = document.createElement('div');
        div.className = 'item';
        div.dataset.nipd = x.nipd;
        div.dataset.nama = x.nama;
        div.dataset.kelas = x.kelas;
        div.innerHTML = `
            <div><b>${x.nama}</b><br><small>${x.nipd}</small></div>
            <div style="display:flex; align-items:center; gap:10px">
                <div class="btns">
                    <button onclick="st(this,'H')">H</button>
                    <button onclick="st(this,'S')">S</button>
                    <button onclick="st(this,'I')">I</button>
                    <button onclick="st(this,'A')">A</button>
                </div>
                <input type="checkbox" class="multi" style="width:18px;height:18px">
            </div>`;
        list.appendChild(div);
    });
}

function st(btn, s) {
    [...btn.parentElement.children].forEach(b => b.className = '');
    btn.className = s.toLowerCase() + '-active';
    btn.dataset.status = s;
}

document.getElementById('selectAll').onclick = function() {
    document.querySelectorAll('.multi').forEach(c => c.checked = this.checked);
};

// 2. FUNGSI SIMPAN MANUAL
async function simpan() {
    const kirim = [];
    document.querySelectorAll('.item').forEach(el => {
        const s = el.querySelector('[data-status]');
        const chk = el.querySelector('.multi');
        if(s && chk.checked) {
            kirim.push({
                nipd: el.dataset.nipd,
                nama: el.dataset.nama,
                kelas: el.dataset.kelas,
                status: s.dataset.status,
                metode: 'Manual'
            });
        }
    });

    if(!kirim.length) return alert("Pilih siswa & status!");
    
    showLoading("Menyimpan...");

    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(kirim) });
    document.getElementById('snd_ok').play();
    alert("Berhasil Disimpan!");
    location.reload();
}

// 3. FUNGSI SCAN (KEYBOARD/ENTER)
scanInput.onkeydown = async (e) => {
    if(e.key === 'Enter' && scanInput.value && kelasSelect.value) {
        showLoading("Menyimpan Absen...");
        const dataScan = [{
            nipd: scanInput.value,
            nama: "Scan Otomatis",
            kelas: kelasSelect.value,
            status: 'H',
            metode: 'Auto'
        }];
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dataScan) });
        document.getElementById('snd_ok').play();
        scanInput.value = '';
        overlay.style.display = 'none';
        alert("Scan Berhasil!");
    }
};

// 4. FUNGSI OTOMATIS (UNTUK MACRODROID/NFC)
window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const scanId = urlParams.get('scan');
    const kelasId = urlParams.get('kls');

    if (scanId && kelasId) {
        showLoading("ðŸ“² MENGIRIM DATA...");
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify([{
                nipd: scanId,
                nama: "Scan NFC",
                kelas: kelasId,
                status: 'H',
                metode: 'Auto'
            }])
        }).then(() => {
            document.getElementById('snd_ok').play();
            loadingText.innerHTML = "âœ… BERHASIL!<br>Siap Scan Berikutnya...";
            
            // Tunggu 1.5 detik agar suara Beep terdengar, lalu REFRESH TOTAL
            setTimeout(() => {
                // Ini akan membersihkan URL dan membuat browser SIAP scan lagi
                window.location.href = window.location.pathname; 
            }, 1500);
            
        }).catch((err) => {
            alert("Koneksi Error: " + err);
            overlay.style.display = 'none';
        });
    }
};
</script>
</body>
</html>
