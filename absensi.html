<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Digital - SMP Al-Irsyad</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1f6f51;
            --secondary: #16503a;
            --bg: #f0f4f8;
            --white: #ffffff;
            --h: #22c55e; --s: #eab308; --i: #3b82f6; --a: #ef4444;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #334155; padding: 15px; }
        .container { max-width: 1100px; margin: auto; background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        h2 { color: var(--primary); font-size: 1.5rem; }
        .info-date { font-weight: 600; color: #64748b; font-size: 0.9rem; }

        .toolbar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 20px; align-items: end; border: 1px solid #e2e8f0; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { padding: 12px; border-radius: 12px; color: white; text-align: center; font-weight: bold; font-size: 0.85rem; }
        
        select, .btn-action { width: 100%; border: 1px solid #cbd5e1; padding: 12px; border-radius: 10px; font-weight: 600; outline: none; }
        select { background: white; cursor: pointer; }
        
        .btn-action { border: none; cursor: pointer; transition: 0.3s; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-sync { background: #3b82f6; }
        .btn-save { background: var(--primary); }
        .btn-action:hover { filter: brightness(0.9); transform: translateY(-2px); }

        .table-responsive { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f1f5f9; color: #475569; padding: 15px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

        .status-btn-group { display: flex; justify-content: center; gap: 6px; }
        .btn-st { width: 38px; height: 38px; border-radius: 10px; border: 2px solid #e2e8f0; background: white; cursor: pointer; font-weight: bold; transition: 0.2s; color: #94a3b8; }
        
        .btn-st.active-h { background: var(--h); color: white; border-color: var(--h); box-shadow: 0 4px 10px rgba(34,197,94,0.3); }
        .btn-st.active-s { background: var(--s); color: white; border-color: var(--s); box-shadow: 0 4px 10px rgba(234,179,8,0.3); }
        .btn-st.active-i { background: var(--i); color: white; border-color: var(--i); box-shadow: 0 4px 10px rgba(59,130,246,0.3); }
        .btn-st.active-a { background: var(--a); color: white; border-color: var(--a); box-shadow: 0 4px 10px rgba(239,68,68,0.3); }

        .loading-msg { font-weight: bold; color: var(--primary); text-align: center; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>SMP AL-IRSYAD DIGITAL ATTENDANCE</h2>
        <p class="info-date" id="current-date"></p>
    </header>

    <div class="toolbar">
        <div>
            <label style="font-size:0.75rem; font-weight:bold;">Sumber Data</label>
            <button onclick="loadSantriData()" class="btn-action btn-sync">ðŸ”„ Refresh santri.xlsx</button>
        </div>
        <div>
            <label style="font-size:0.75rem; font-weight:bold;">Pilih Kelas</label>
            <select id="kelas-select">
                <option value="">-- Memuat Data --</option>
            </select>
        </div>
        <div>
            <button id="export-btn" class="btn-action btn-save">ðŸ’¾ Export Rekap Excel</button>
        </div>
    </div>

    <div id="loading-msg" class="loading-msg">Membaca file santri.xlsx...</div>

    <div class="stats">
        <div class="stat-card" style="background: var(--h)">Hadir: <span id="count-h">0</span></div>
        <div class="stat-card" style="background: var(--s)">Sakit: <span id="count-s">0</span></div>
        <div class="stat-card" style="background: var(--i)">Izin: <span id="count-i">0</span></div>
        <div class="stat-card" style="background: var(--a)">Alpha: <span id="count-a">0</span></div>
    </div>

    <div class="table-responsive">
        <table id="absensi-table">
            <thead>
                <tr>
                    <th width="50">NO</th>
                    <th width="100">NIPD</th>
                    <th>NAMA SANTRI</th>
                    <th width="60">JK</th>
                    <th width="220">KETERANGAN</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="padding:50px; color:#94a3b8;">Silakan refresh database...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let workbookData = null;
const kelasSelect = document.getElementById('kelas-select');
const tableBody = document.querySelector('#absensi-table tbody');

document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

// 1. Membaca Seluruh Sheet (Kelas) dari santri.xlsx
async function loadSantriData() {
    document.getElementById('loading-msg').style.display = 'block';
    try {
        // Cache-busting agar data selalu terbaru
        const response = await fetch('santri.xlsx?v=' + Math.random());
        if (!response.ok) throw new Error("File santri.xlsx tidak ditemukan.");
        
        const data = await response.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        workbookData = workbook;

        // Kosongkan dan isi select dengan SEMUA sheet yang ada
        kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        workbook.SheetNames.forEach(name => {
            const opt = new Option(name, name);
            kelasSelect.add(opt);
        });

        console.log("Daftar Kelas Terdeteksi:", workbook.SheetNames);
    } catch (err) {
        alert("Gagal memuat file: " + err.message);
    } finally {
        document.getElementById('loading-msg').style.display = 'none';
    }
}

// 2. Render Santri saat Pilih Kelas
kelasSelect.addEventListener('change', e => {
    const sheetName = e.target.value;
    if (!sheetName) return;

    const sheet = workbookData.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    
    tableBody.innerHTML = '';
    
    // Dimulai dari baris ke-4 (Index 3)
    for (let i = 3; i < data.length; i++) {
        const row = data[i];
        if (!row[2]) continue; // Skip jika kolom Nama kosong

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row[0] || i-2}</td>
            <td>${row[1] || '-'}</td>
            <td style="text-align:left; font-weight:600;">${row[2]}</td>
            <td>${row[3] || '-'}</td>
            <td>
                <div class="status-btn-group">
                    <button class="btn-st" onclick="setStatus(this, 'H')">H</button>
                    <button class="btn-st" onclick="setStatus(this, 'S')">S</button>
                    <button class="btn-st" onclick="setStatus(this, 'I')">I</button>
                    <button class="btn-st" onclick="setStatus(this, 'A')">A</button>
                </div>
            </td>
        `;
        tableBody.appendChild(tr);
    }
    resetStats();
});

function setStatus(btn, code) {
    const group = btn.parentElement;
    group.querySelectorAll('.btn-st').forEach(b => b.className = 'btn-st');
    
    const cls = { 'H': 'active-h', 'S': 'active-s', 'I': 'active-i', 'A': 'active-a' };
    btn.classList.add(cls[code]);
    btn.setAttribute('data-selected', code);
    
    // Fitur Getar (Vibrate) di HP
    if (navigator.vibrate) navigator.vibrate(20);
    
    updateStats();
}

function updateStats() {
    const counts = { 'H': 0, 'S': 0, 'I': 0, 'A': 0 };
    document.querySelectorAll('.btn-st[data-selected]').forEach(btn => counts[btn.getAttribute('data-selected')]++);
    
    ['h','s','i','a'].forEach(k => {
        document.getElementById(`count-${k}`).textContent = counts[k.toUpperCase()];
    });
}

function resetStats() {
    ['h','s','i','a'].forEach(k => document.getElementById(`count-${k}`).textContent = '0');
}

document.getElementById('export-btn').addEventListener('click', () => {
    const trs = document.querySelectorAll('#absensi-table tbody tr');
    if (!trs.length || !kelasSelect.value) return alert("Data masih kosong!");

    const content = [['REKAP ABSENSI SANTRI'], ['Kelas:', kelasSelect.value], ['Tanggal:', document.getElementById('current-date').textContent], [], ['NO', 'NIPD', 'NAMA SANTRI', 'JK', 'STATUS']];
    
    trs.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const sel = tr.querySelector('.btn-st[data-selected]');
        content.push([tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText, sel ? sel.getAttribute('data-selected') : '-']);
    });

    const ws = XLSX.utils.aoa_to_sheet(content);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Absensi");
    XLSX.writeFile(wb, `Rekap_${kelasSelect.value}_${new Date().toLocaleDateString()}.xlsx`);
});

// Jalankan otomatis
window.onload = loadSantriData;
</script>
</body>
</html>
