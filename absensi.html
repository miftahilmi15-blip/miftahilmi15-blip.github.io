<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>E-Santri Otomatis</title>
<style>
body{margin:0;font-family:sans-serif;background:#f8fafc;padding-bottom:120px}
header{background:#fff;padding:16px;border-bottom:1px solid #ccc;position:sticky;top:0;z-index:100;}
.list{padding:15px;}
.item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff;margin-bottom:5px;border-radius:8px;}
.btns button{width:35px;height:35px;margin-left:5px;border-radius:6px;border:none;color:#fff;font-weight:bold;cursor:pointer;}
.h{background:#22c55e;} .s{background:#f59e0b;} .i{background:#3b82f6;} .a{background:#ef4444;}
.multi{margin-left:10px;}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;color:#fff;font-size:18px;z-index:999;}
</style>
</head>
<body>

<div id="overlay">‚è≥ Menyimpan...</div>

<header>
<h1>üü¢ E-Santri</h1>
<select id="kelas">
<option value="">Pilih Kelas</option>
<option>7A</option><option>7B</option>
<option>8A</option><option>8B</option>
<option>9A</option><option>9B</option>
</select>
<input id="scan" placeholder="Scan kartu/NIPD" autofocus>
</header>

<div id="list" class="list"></div>

<div style="padding:15px;">
<label><input type="checkbox" id="selectAll"> Pilih Semua</label>
</div>

<div style="padding:15px;">
<button onclick="simpan()" style="padding:10px 20px;background:#10b981;color:#fff;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">SIMPAN</button>
</div>

<audio id="ok" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
<audio id="fail" src="https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3"></audio>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwHeS1LbwRJgWKsnHkIyZGe_hrKUiCctpTBTtjjG9rSAtxKN28jguXDDdvS15U6kyFAOA/exec";
const overlay=document.getElementById('overlay');
const kelasSelect=document.getElementById('kelas');
const scanInput=document.getElementById('scan');
const list=document.getElementById('list');
const ok=document.getElementById('ok');
const fail=document.getElementById('fail');

// Load siswa ketika pilih kelas
kelasSelect.onchange=async ()=>{
  if(!kelasSelect.value) return;
  overlay.style.display='flex';
  try{
    const res = await fetch(`${SCRIPT_URL}?kelas=${kelasSelect.value}`);
    const data = await res.json();
    overlay.style.display='none';
    render(data.data || []);
  }catch(err){
    overlay.style.display='none';
    alert('Gagal load siswa: '+err);
  }
};

// Render list siswa
function render(data){
  list.innerHTML='';
  data.forEach(x=>{
    const div=document.createElement('div');
    div.className='item';
    div.dataset.nipd=x.nipd;
    div.dataset.kelas=x.kelas;
    div.innerHTML=`
      <div><b>${x.nama}</b> (#${x.no})<br>${x.nipd}</div>
      <div class="btns">
        <button onclick="setStatus(this,'H')">H</button>
        <button onclick="setStatus(this,'S')">S</button>
        <button onclick="setStatus(this,'I')">I</button>
        <button onclick="setStatus(this,'A')">A</button>
      </div>
      <input type="checkbox" class="multi">`;
    list.appendChild(div);
  });
}

// Set status H/S/I/A
function setStatus(btn,status){
  [...btn.parentElement.children].forEach(b=>b.className='');
  btn.className=status.toLowerCase();
  btn.dataset.s=status;
}

// Pilih semua
document.getElementById('selectAll').onchange=function(){
  document.querySelectorAll('.multi').forEach(chk=>chk.checked=this.checked);
};

// Simpan manual
async function simpan(){
  const data=[];
  document.querySelectorAll('.item').forEach(div=>{
    const statusBtn=div.querySelector('[data-s]');
    const chk=div.querySelector('.multi');
    if(statusBtn && chk.checked){
      data.push({
        kelas:div.dataset.kelas,
        nipd:div.dataset.nipd,
        nama: div.querySelector('b').innerText,
        status: statusBtn.dataset.s,
        metode:'manual'
      });
    }
  });
  if(data.length===0){ alert("Pilih siswa & status"); return; }
  overlay.style.display='flex';
  try{
    const res = await fetch(SCRIPT_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    const result=await res.json();
    result.results.forEach(r=>r.status==='Sukses'?ok.play():fail.play());
  }catch(err){ alert('Gagal simpan'); }
  overlay.style.display='none';
  setTimeout(()=>location.reload(),1000);
}

// Auto-save scan kartu/NIPD
scanInput.addEventListener('keydown',e=>{
  if(e.key==='Enter' && scanInput.value){
    const nipd=scanInput.value.trim();
    if(!kelasSelect.value){ alert("Pilih kelas dulu"); return; }
    overlay.style.display='flex';
    fetch(SCRIPT_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify([{kelas:kelasSelect.value,nipd,status:'H',metode:'auto'}])
    }).then(()=>ok.play()).catch(()=>fail.play()).finally(()=>overlay.style.display='none');
    scanInput.value='';
  }
});
</script>
</body>
</html>
